<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ilyambr</title>
	<link rel="icon" type="image/x-icon" href="https://ilyambr.me/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<!-- Firebase SDK -->
	<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
	<style>
		:root{
			--bg-1:#0b0b12;
			--bg-2:#0e0b1a;
			--twitch:#3a3a3a;
			--twitch-2:#777777;
			--pink:#666666;
			--cyan:#888888;
			--glow:#9a9a9a;
			--text:#e8e8f0;
			--muted:#b8b8c7;
			--card:#121226cc;
			--glass:rgba(18,18,38,0.55);
			--border:rgba(255,255,255,0.08);
			--button-glow: rgba(145,70,255,0.35);
			--shadow:0 10px 40px rgba(0,0,0,0.65), inset 0 1px 0 rgba(255,255,255,0.04);
			--radius:18px;
			--radius-sm:12px;
			--accent:#63a4ff;
			--accent-hover:#7ab4ff;
			--accent-contrast:#0c1424;
			--surface-overlay:rgba(255,255,255,0.05);
			--surface-overlay-hover:rgba(255,255,255,0.12);
			--surface-button:rgba(255,255,255,0.08);
			--surface-button-border:rgba(255,255,255,0.16);
			--surface-button-hover:rgba(255,255,255,0.16);
			--surface-button-border-hover:rgba(255,255,255,0.22);
			--text-subtle:rgba(255,255,255,0.6);
			--text-stronger:rgba(255,255,255,0.75);
			--danger-overlay:rgba(255,59,107,0.2);
			--danger-overlay-hover:rgba(255,59,107,0.3);
			--danger-border:rgba(255,59,107,0.3);
			--success-main:#49c977;
			--success-bg:rgba(73,201,119,0.15);
			--success-border-strong:rgba(73,201,119,0.4);
			--success-border:rgba(73,201,119,0.35);
			--success-shadow:rgba(73,201,119,0.25);
			--info-main:#73b7ff;
			--info-bg:rgba(111,182,255,0.15);
			--info-border-strong:rgba(111,182,255,0.4);
			--info-border:rgba(111,182,255,0.3);
			--info-shadow:rgba(111,182,255,0.2);
			--warning-main:#fdc45a;
			--warning-bg:rgba(253,196,90,0.18);
			--warning-border-strong:rgba(253,196,90,0.45);
			--warning-border:rgba(253,196,90,0.35);
			--warning-shadow:rgba(253,196,90,0.22);
			--error-main:#ff6b81;
			--error-bg:rgba(255,107,129,0.18);
			--error-border-strong:rgba(255,107,129,0.45);
			--error-border:rgba(255,107,129,0.35);
			--error-shadow:rgba(255,107,129,0.25);
			--error-strong:rgba(255,107,129,0.6);
			--settings-section-bg-start:rgba(20,24,46,0.86);
			--settings-section-bg-end:rgba(12,14,28,0.94);
			--settings-section-border:rgba(132,164,255,0.16);
			--settings-section-heading:rgba(173,222,255,0.86);
			--settings-section-row-label:rgba(174,205,255,0.72);
			--settings-section-row-value:rgba(255,255,255,0.96);
			--settings-section-placeholder:rgba(186,204,232,0.66);
			--accent:#63a4ff;
			--accent-hover:#7ab4ff;
			--accent-contrast:#0c1424;
			--surface-overlay:rgba(255,255,255,0.05);
			--surface-overlay-hover:rgba(255,255,255,0.12);
			--surface-button:rgba(255,255,255,0.08);
			--surface-button-border:rgba(255,255,255,0.16);
			--surface-button-hover:rgba(255,255,255,0.16);
			--surface-button-border-hover:rgba(255,255,255,0.22);
			--text-subtle:rgba(255,255,255,0.6);
			--text-stronger:rgba(255,255,255,0.75);
			--danger-overlay:rgba(255,59,107,0.2);
			--danger-overlay-hover:rgba(255,59,107,0.3);
			--danger-border:rgba(255,59,107,0.3);
			--success-main:#49c977;
			--success-bg:rgba(73,201,119,0.15);
			--success-border-strong:rgba(73,201,119,0.4);
			--success-border:rgba(73,201,119,0.35);
			--success-shadow:rgba(73,201,119,0.25);
			--info-main:#73b7ff;
			--info-bg:rgba(111,182,255,0.15);
			--info-border-strong:rgba(111,182,255,0.4);
			--info-border:rgba(111,182,255,0.3);
			--info-shadow:rgba(111,182,255,0.2);
			--warning-main:#fdc45a;
			--warning-bg:rgba(253,196,90,0.18);
			--warning-border-strong:rgba(253,196,90,0.45);
			--warning-border:rgba(253,196,90,0.35);
			--warning-shadow:rgba(253,196,90,0.22);
			--error-main:#ff6b81;
			--error-bg:rgba(255,107,129,0.18);
			--error-border-strong:rgba(255,107,129,0.45);
			--error-border:rgba(255,107,129,0.35);
			--error-shadow:rgba(255,107,129,0.25);
			--error-strong:rgba(255,107,129,0.6);
			--settings-section-bg-start:rgba(20,24,46,0.86);
			--settings-section-bg-end:rgba(12,14,28,0.94);
			--settings-section-border:rgba(132,164,255,0.16);
			--settings-section-heading:rgba(173,222,255,0.86);
			--settings-section-row-label:rgba(174,205,255,0.72);
			--settings-section-row-value:rgba(255,255,255,0.96);
			--settings-section-placeholder:rgba(186,204,232,0.66);
		}

		*{box-sizing:border-box; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;}
		::-webkit-scrollbar{width:12px; height:12px;}
		::-webkit-scrollbar:horizontal{height:10px;}
		::-webkit-scrollbar-track{
			background:transparent;
			border-radius:999px;
		}
		::-webkit-scrollbar-thumb{
			background:#ffffff;
			border-radius:999px;
			border:3px solid rgba(0,0,0,0.25);
		}
		::-webkit-scrollbar-thumb:hover{
			background:#f5f5f5;
		}
		::-webkit-scrollbar-corner{background:transparent;}
		html,body{height:100%}
		html{
			padding:0;
			margin:0;
			background:#1a1a2e;
			width:100%;
			height:100%;
			overflow-x:hidden;
			overflow-y:hidden;
			touch-action:pan-y;
			overscroll-behavior-x:none;
			overscroll-behavior-y:none;
			overflow-anchor:auto;
			scrollbar-width:thin;
			scrollbar-color:rgba(0,199,255,0.55) rgba(10,12,26,0.86);
		}
		body{
			margin:0;
			padding:0;
			font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
			color:var(--text);
			background:#1a1a2e;
			min-height:100%;
			overflow-x:hidden;
			overflow-y:auto;
			touch-action:pan-y;
			overscroll-behavior-x:none;
			overscroll-behavior-y:none;
			max-width:100vw;
			scrollbar-gutter:stable both-edges;
		}
		.page-effects-root{
			position:relative;
			min-height:100%;
			width:100%;
		}
		@media (min-width: 1201px){
			body{
				overflow-y:hidden;
			}
		}

		/* Simple loading screen - no backdrop-filter to prevent blur conflicts */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(26, 26, 46, 0.95);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
			opacity: 1;
			transition: opacity 0.6s ease-out;
		}
		
		.loading-overlay.hide {
			opacity: 0;
			pointer-events: none;
		}
		
		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 3px solid rgba(255, 255, 255, 0.1);
			border-top: 3px solid rgba(145, 70, 255, 0.8);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.aurora{
			position:fixed; inset:-20% -20% auto -20%; height:120%;
			background:
				conic-gradient(from 120deg at 60% 40%, rgba(200,200,200,0.28), rgba(140,140,140,0.20), rgba(100,100,100,0.22), rgba(200,200,200,0.28));
			filter:blur(70px) saturate(140%);
			opacity:0.45;
			animation:drift 18s ease-in-out infinite alternate;
			pointer-events:none;
			z-index:0;
		}
		.bg-glass{
			position:fixed;
			top:0; left:0; right:0; bottom:0; /* explicit to ensure full coverage */
			z-index:0; /* below content (.container z-index:1), above page background */
			pointer-events:none;
			background:rgba(10,10,15,0.18);
			backdrop-filter: blur(10px) saturate(115%);
			-webkit-backdrop-filter: blur(10px) saturate(115%);
		}
		@media (max-width: 1024px){
			.bg-glass{
				backdrop-filter:none;
				-webkit-backdrop-filter:none;
				background:rgba(10,10,15,0.45);
			}
		}
		/* Background tint overlay (for solid/gradient theme colors) */
		.bg-tint{
			position:fixed;
			top:0; left:0; right:0; bottom:0; /* explicit to ensure full coverage */
			z-index:0;
			pointer-events:none;
			opacity:0.35;
		}
		.bg-tint.hidden{display:none}
		@keyframes drift{
			0%{transform:translate3d(-3%, -2%, 0) rotate(0deg) scale(1)}
			100%{transform:translate3d(3%, 2%, 0) rotate(4deg) scale(1.05)}
		}

		.container{
			position:relative;
			z-index:1;
			max-width:1100px;
			margin:90px auto 60px;
			padding:0 20px;
		}

		.desktop-shell{
			position:relative;
			z-index:1;
		}
		.short-video-panel{
			display:none;
			z-index:1;
		}
		.short-video-card{
			display:flex;
			flex-direction:column;
			gap:14px;
		}
		.short-video-card h3{
			margin:0;
		}
		.short-video-embed{
			position:relative;
			border-radius:var(--radius);
			overflow:hidden;
			background:linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.015)), var(--card);
			border:1px solid var(--border);
			box-shadow:var(--shadow), 0 0 40px rgba(86,224,255,0.08);
			padding:0;
			min-height:320px;
			display:flex;
			flex-direction:column;
			align-items:stretch;
			justify-content:flex-start;
		}
		.short-video-embed iframe{
			width:100%;
			height:auto;
			border:0;
			aspect-ratio:9/16;
		}
		.short-video-embed blockquote{
			margin:0;
			width:100%;
		}
		.short-video-placeholder{
			text-align:center;
			color:var(--muted);
			font-size:14px;
			line-height:1.6;
			padding:24px 18px;
			display:flex;
			flex-direction:column;
			align-items:center;
			justify-content:center;
			gap:6px;
			margin:auto;
		}
		.short-video-placeholder strong{
			color:var(--text);
			font-size:15px;
		}

		@media (min-width: 1200px){
			.desktop-shell{
				display:flex;
				align-items:stretch;
				flex-wrap:wrap;
				gap:28px;
				max-width:1600px;
				margin:0 auto;
				padding:90px 40px 60px;
			}
			.desktop-shell .container{
				margin:0;
				flex:1 1 0;
				max-width:1100px;
				min-width:0;
			}
			.short-video-panel{
				display:flex;
				flex-direction:column;
				justify-content:flex-end;
				flex:0 0 360px;
				align-self:flex-start;
				transform:translateY(-3px);
			}
			.short-video-card{
				position:relative;
				width:100%;
			}
		}

		.header{
			display:grid;
			grid-template-columns:120px 1fr auto;
			gap:22px;
			align-items:center;
			background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)) , var(--glass);
			border:1px solid var(--border);
			box-shadow:var(--shadow), 0 0 0 1px rgba(145,70,255,0.06) inset, 0 0 80px rgba(145,70,255,0.12);
			backdrop-filter: blur(12px) saturate(130%);
			border-radius:calc(var(--radius) + 4px);
			padding:22px;
			position:relative;
			overflow:hidden;
		}
		.page-logo{
			position:fixed;
			top:0;
			left:60px;
			width:135px;
			height:135px;
			z-index:1000;
			filter:drop-shadow(0 24px 45px rgba(0,0,0,0.45));
		}
		.page-logo img{
			width:100%;
			height:100%;
			object-fit:contain;
			border-radius:6px;
			filter:invert(1);
		}
		/* Allow disabling inversion via body class */
		.logo-no-invert .page-logo img{ filter:none !important; }
		.social-bar{
			position:fixed;
			top:56px;
			right:54px;
			display:flex;
			gap:8px;
			z-index:1000;
			list-style:none;
			margin:0;
			padding:0;
		}
		.social-link{
			width:24px;
			height:24px;
			display:flex;
			align-items:center;
			justify-content:center;
			background:rgba(255,255,255,0.1);
			border-radius:6px;
			transition:all 0.2s ease;
			text-decoration:none;
		}
		.social-link:hover{
			background:rgba(255,255,255,0.2);
			transform:translateY(-1px);
		}
		.social-link img{
			width:14px;
			height:14px;
			object-fit:cover;
			border-radius:2px;
		}
		.header:before{
			content:"";
			position:absolute; inset:0;
			background:radial-gradient(600px 120px at 30% -40%, rgba(180,180,180,0.18), transparent 60%),
						radial-gradient(500px 100px at 85% 0%, rgba(120,120,120,0.14), transparent 60%);
			pointer-events:none;
		}

		.avatar{
			width:120px; height:120px; border-radius:22%;
			border:1px solid rgba(255,255,255,0.14);
			background:
				radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), transparent 40%),
				linear-gradient(135deg, rgba(130,130,130,0.35), rgba(80,80,80,0.25));
			box-shadow:
				0 12px 40px rgba(0,0,0,0.45),
				0 0 0 6px rgba(120,120,120,0.08),
				0 0 0 1px rgba(255,255,255,0.10) inset;
			display:grid; place-items:center; overflow:hidden;
			opacity: 0; /* Initially hidden to prevent flickering */
			transition: opacity 0.3s ease-in-out;
		}
		.avatar.loaded {
			opacity: 1; /* Show once loaded */
		}
		.avatar img{width:100%; height:100%; object-fit:cover; display:block}
		.badges{
			display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;
		}
		.badge{
			font-size:12px; padding:6px 10px; border-radius:999px; color:white;
			background:linear-gradient(90deg, var(--twitch), var(--twitch-2));
			box-shadow:0 6px 20px rgba(145,70,255,0.35), 0 0 0 1px rgba(255,255,255,0.1) inset;
			border:1px solid rgba(255,255,255,0.12);
			letter-spacing:0.2px;
		}

		.title{
			display:flex; align-items:center; gap:12px; flex-wrap:wrap;
		}
		.name{
			font-family:"Space Grotesk",Inter,sans-serif;
			font-size:32px; font-weight:800; letter-spacing:0.3px;
			text-shadow:0 0 30px rgba(145,70,255,0.35);
		}
		.username{color:var(--muted); font-weight:600}
		.bio{color:var(--muted); margin-top:6px; line-height:1.5}
		.stats{
			display:flex; gap:18px; margin-top:14px; flex-wrap:wrap;
			color:#dcdcf3;
		}
		.stat{
			background:rgba(255,255,255,0.05);
			border:1px solid var(--border);
			border-radius:999px; padding:8px 12px;
			box-shadow:inset 0 0 24px rgba(145,70,255,0.09), 0 8px 24px rgba(0,0,0,0.25);
			display:inline-flex; align-items:center; gap:8px;
		}
		.stat svg{width:16px; height:16px; display:block}
		.stat img{width:16px; height:16px; display:block; object-fit:contain; filter:invert(1) grayscale(1) brightness(1.4) contrast(1.6)}

		.actions{
			display:flex; gap:12px; flex-wrap:wrap; justify-self:end;
		}
		.button{
			--c1:var(--twitch); --c2:var(--twitch-2);
			position:relative;
			display:inline-flex; align-items:center; gap:10px;
			padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.12);
			color:#fff; text-decoration:none; font-weight:700;
			background:linear-gradient(90deg, var(--c1), var(--c2));
			box-shadow:0 10px 34px var(--button-glow), 0 0 0 1px rgba(255,255,255,0.08) inset;
			transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
		}
		.button.secondary{
			--c1:rgba(255,255,255,0.08); --c2:rgba(255,255,255,0.08);
			color:#e9e9ff;
			backdrop-filter: blur(6px);
			box-shadow:0 10px 30px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.08);
		}
		.button:hover{transform:translateY(-1px); filter:saturate(1.1)}
		.button:active{transform:translateY(0)}
		.button svg{width:18px; height:18px; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.35))}

		.grid{
			display:grid; gap:20px; margin-top:22px;
			grid-template-columns:2fr 1fr;
		}

		.card{
			background:linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.015)), var(--card);
			border:1px solid var(--border);
			box-shadow:var(--shadow), 0 0 80px rgba(86,224,255,0.08);
			backdrop-filter: blur(10px) saturate(140%);
			border-radius:var(--radius);
			padding:18px;
		}
		.card h3{
			margin:2px 0 14px;
			font-family:"Space Grotesk",Inter,sans-serif;
			letter-spacing:0.3px;
		}

		.gallery{display:grid; grid-template-columns:1fr; gap:14px}
		.thumb{
			position:relative; border-radius:var(--radius-sm); overflow:hidden; aspect-ratio:16/9;
			background:
				radial-gradient(120% 120% at 10% 0%, rgba(180,180,180,0.28), transparent 60%),
				linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
			border:1px solid rgba(255,255,255,0.1);
			box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06), 0 20px 50px rgba(0,0,0,0.4);
			display:grid; place-items:center;
			color:#fff; font-weight:800; letter-spacing:0.5px;
		}
		.thumb #twitch-embed{width:100%; height:100%; visibility:visible}
		.thumb .embed-container{width:100%; height:100%; position:absolute; top:0; left:0}
		.thumb:after{
			content:"LIVE";
			position:absolute; top:10px; right:10px;
			background:linear-gradient(90deg, #3a3a3a, #7a7a7a);
			padding:4px 8px; border-radius:999px; font-size:12px;
			border:1px solid rgba(255,255,255,0.15);
			box-shadow:0 10px 24px rgba(160,160,160,0.35);
		}
		.thumb.hide-live:after{
			display:none;
		}

		.about{
			line-height:1.8; color:#d9d9f2; font-weight:400;
		}
		.about strong{color:#fff}
		.discord-link{display:flex; align-items:center; justify-content:center; gap:10px; width:100%; margin-top:12px; text-decoration:none; color:#ffffff; background:linear-gradient(90deg, #5865F2, #8a95ff); border:1px solid rgba(255,255,255,0.12); padding:12px 14px; border-radius:12px; font-weight:700; transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;}
		.discord-link:hover{transform:translateY(-1px); filter:saturate(1.1)}
		.discord-link:active{transform:translateY(0)}
		.discord-link svg{width:20px; height:20px; display:block; color:#ffffff}
		.discord-link img{width:20px; height:20px; display:block; object-fit:contain; background:transparent; filter:invert(1) grayscale(1) brightness(1.6) contrast(1.8); mix-blend-mode:screen}
		.settings-link{background:linear-gradient(90deg, rgba(88,88,88,0.85), rgba(150,150,150,0.7)); border:1px solid rgba(255,255,255,0.14); color:#ffffff;}
		.settings-link svg{width:20px; height:20px; display:block; color:#ffffff}
		.popup-overlay.game-settings-overlay{
			align-items:center;
			padding:60px 0;
		}
		.popup-content.game-settings-panel{
			width:min(98vw, 1280px);
			max-width:1280px;
			min-height:80vh;
			max-height:calc(100vh - 80px);
			margin:0 auto;
			display:flex;
			flex-direction:column;
		}
		.popup-content.game-settings-panel .popup-body{
			padding:32px;
			overflow-y:hidden;
			overflow-x:auto;
		}
		.popup-content.game-settings-panel .settings-layout{
			display:grid;
			grid-template-columns:240px 1fr;
			gap:24px;
			width:100%;
			min-height:calc(80vh - 120px);
			align-items:stretch;
		}
		.popup-content.game-settings-panel .settings-tabs{
			display:flex;
			flex-direction:column;
			gap:10px;
			margin:-7px 0 0;
			padding:3px 0 6px;
			background:transparent;
			border:none;
		}
		.popup-content.game-settings-panel .settings-tab{
			appearance:none;
			border:none;
			background:rgba(255,255,255,0.04);
			color:var(--text);
			padding:12px 14px;
			border-radius:12px;
			font-weight:600;
			text-align:left;
			cursor:pointer;
			display:flex;
			align-items:center;
			gap:10px;
			transition:all .15s ease;
		}
		.popup-content.game-settings-panel .settings-tab:hover{
			background:rgba(255,255,255,0.22);
			color:#0c1424;
		}
		.popup-content.game-settings-panel .settings-tab.active{
			background:#ffffff;
			color:#0c1424;
			box-shadow:0 10px 26px rgba(0,0,0,0.18);
		}
		.popup-content.game-settings-panel .settings-content{
			position:relative;
			width:100%;
			background:rgba(255,255,255,0.04);
			border:1px solid rgba(255,255,255,0.08);
			border-radius:16px;
			padding:32px;
			min-height:100%;
			display:flex;
			align-items:center;
			justify-content:center;
			overflow:hidden;
		}
		.popup-content.game-settings-panel .settings-content.has-banner{
			padding:0;
		}
		.popup-content.game-settings-panel .settings-content.list-mode{
			display:block;
			overflow:auto;
		}
		.popup-content.game-settings-panel .settings-content.grid-mode{
			display:block;
			overflow:auto;
			padding:28px;
		}
		.popup-content.game-settings-panel .settings-placeholder{
			margin:0;
			color:var(--muted);
			text-align:center;
			line-height:1.6;
		}
		.app-settings-splash{
			position:relative;
			width:100%;
			height:100%;
			min-height:320px;
			background:linear-gradient(180deg, rgba(10,10,20,0.75), rgba(10,10,20,0.9));
			background-size:cover;
			background-position:center;
			display:flex;
			align-items:stretch;
			justify-content:flex-end;
		}
		.app-settings-overlay{
			position:relative;
			width:100%;
			height:100%;
			padding:48px 32px;
			background:linear-gradient(180deg, rgba(5,5,10,0.05) 0%, rgba(5,5,10,0.25) 100%);
			display:flex;
			flex-direction:column;
			align-items:center;
			justify-content:flex-end;
			gap:12px;
			text-align:center;
		}
		.app-settings-logo{
			width:56px;
			height:56px;
			border-radius:14px;
			object-fit:cover;
			box-shadow:0 10px 20px rgba(0,0,0,0.45);
		}
		.app-settings-overlay h4{
			margin:0;
			font-size:20px;
			color:#ffffff;
		}
		.app-settings-overlay p{
			margin:0;
			color:rgba(255,255,255,0.75);
			max-width:360px;
		}
		.settings-manager-grid{
			display:grid;
			grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
			gap:18px;
		}
		.settings-app-card{
			position:relative;
			aspect-ratio:1080 / 1640;
			border-radius:18px;
			border:1px solid rgba(255,255,255,0.08);
			background:rgba(255,255,255,0.04);
			background-size:cover;
			background-position:center;
			display:flex;
			align-items:flex-end;
			justify-content:center;
			overflow:hidden;
			cursor:pointer;
			transition:transform .2s ease, box-shadow .2s ease;
		}
		.settings-app-card:hover{
			transform:translateY(-4px);
			box-shadow:0 20px 38px rgba(0,0,0,0.35);
		}
		.settings-app-card::after{
			content:"";
			position:absolute;
			inset:0;
			background:linear-gradient(180deg, rgba(10,10,20,0.05), rgba(10,10,20,0.8));
			opacity:0;
			transition:opacity .2s ease;
		}
		.settings-app-card:hover::after{
			opacity:1;
		}
		.app-card-overlay{
			position:absolute;
			inset:auto 0 0 0;
			padding:18px 16px;
			display:flex;
			flex-direction:column;
			align-items:center;
			gap:8px;
			justify-content:center;
			text-align:center;
			color:#ffffff;
			font-weight:600;
			opacity:0;
			transform:translateY(20px);
			transition:opacity .2s ease, transform .2s ease;
			z-index:2;
		}
		.app-card-badge{
			display:inline-flex;
			align-items:center;
			gap:6px;
			padding:4px 12px;
			border-radius:999px;
			background:rgba(255,255,255,0.14);
			color:#ffffff;
			font-size:11px;
			font-weight:600;
			letter-spacing:0.4px;
			text-transform:uppercase;
		}
		.settings-app-card:hover .app-card-overlay{
			opacity:1;
			transform:translateY(0);
		}
		.app-card-overlay img{
			width:28px;
			height:28px;
			border-radius:8px;
			object-fit:cover;
			background-color:transparent;
			box-shadow:0 10px 18px rgba(0,0,0,0.3);
		}
		.app-card-overlay .app-card-name{
			font-size:15px;
			font-weight:600;
		}
		.settings-app-card .app-card-name,
		.settings-app-card .app-card-badge{
			color:#ffffff;
			text-shadow:
				0 1px 2px rgba(0,0,0,0.6),
				0 -1px 2px rgba(0,0,0,0.4),
				1px 0 2px rgba(0,0,0,0.4),
				-1px 0 2px rgba(0,0,0,0.4);
			-webkit-text-stroke:0.6px rgba(0,0,0,0.6);
		}
		.app-card-actions{
			display:flex;
			gap:8px;
			flex-wrap:wrap;
			justify-content:center;
		}
		.app-card-action{
			border:none;
			padding:6px 12px;
			border-radius:999px;
			background:rgba(255,255,255,0.14);
			color:#ffffff;
			font-size:12px;
			font-weight:600;
			cursor:pointer;
			transition:background .2s ease, transform .2s ease;
		}
		.app-card-action:hover{
			background:rgba(255,255,255,0.24);
			transform:translateY(-1px);
		}
		.app-card-action.delete{
			background:rgba(255,82,82,0.24);
		}
		.app-card-action.delete:hover{
			background:rgba(255,82,82,0.34);
		}
		.settings-app-card.add-card{
			border:1.5px dashed rgba(255,255,255,0.18);
			background:rgba(255,255,255,0.04);
			color:rgba(255,255,255,0.75);
			justify-content:center;
			align-items:center;
			flex-direction:column;
			gap:12px;
			font-weight:600;
		}
		.settings-app-card.add-card::after{display:none;}
		.settings-app-card.add-card .add-icon{
			width:48px;
			height:48px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.12);
			display:flex;
			align-items:center;
			justify-content:center;
			font-size:28px;
			background:rgba(255,255,255,0.05);
			box-shadow:0 12px 24px rgba(0,0,0,0.25);
		}
		.settings-manager-empty{
			margin:0;
			color:var(--muted);
			text-align:center;
			padding:16px 0;
		}
		.app-form-grid{
			display:grid;
			gap:18px;
		}
		.app-name-field{
			display:grid;
			grid-template-columns:minmax(0, 1fr) auto;
			gap:18px;
			align-items:flex-start;
			background:rgba(255,255,255,0.05);
			border:1px solid rgba(255,255,255,0.16);
			border-radius:16px;
			padding:16px 18px;
			box-shadow:0 18px 28px rgba(0,0,0,0.18);
		}
		.app-name-main{
			display:flex;
			flex-direction:column;
			gap:10px;
		}
		.app-name-label{
			display:flex;
			align-items:center;
			gap:8px;
			font-size:15px;
			font-weight:700;
			letter-spacing:0.4px;
			text-transform:uppercase;
			color:rgba(255,255,255,0.82);
		}
		.app-name-input{
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.12);
			background:linear-gradient(135deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03));
			color:#ffffff;
			font-size:16px;
			font-weight:600;
			outline:none;
			transition:border .2s ease, box-shadow .2s ease;
		}
		.app-name-input::placeholder{color:rgba(255,255,255,0.5);}
		.app-name-input:focus{
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.app-form-previews{
			display:grid;
			grid-template-columns:2fr 1fr;
			gap:18px;
			align-items:start;
		}
		.app-media-block{display:flex; flex-direction:column; gap:10px;}
		.app-media-hint{
			font-size:11px;
			text-transform:uppercase;
			letter-spacing:0.4px;
			color:rgba(255,255,255,0.55);
		}
		.app-media-preview{
			position:relative;
			border-radius:18px;
			border:1px solid rgba(255,255,255,0.12);
			background:rgba(255,255,255,0.04) center / cover no-repeat;
			overflow:hidden;
			transition:border .2s ease, box-shadow .2s ease;
			cursor:pointer;
		}
		.app-media-preview::after{
			content:"";
			position:absolute;
			top:0;
			left:0;
			right:0;
			bottom:0;
			background:linear-gradient(180deg, rgba(7,7,14,0.0) 0%, rgba(7,7,14,0.55) 100%);
			opacity:0;
			transition:opacity .2s ease;
		}
		.app-media-preview:hover::after{opacity:1;}
		.app-media-preview.has-image{box-shadow:0 18px 32px rgba(0,0,0,0.24);}
		.app-form-banner-preview{
			width:100%;
			aspect-ratio:1080 / 1640;
			min-height:0;
			max-height:420px;
		}
		.app-inline-logo{
			display:flex;
			flex-direction:column;
			align-items:center;
			gap:6px;
			min-width:110px;
		}
		.app-inline-logo .app-media-upload{
			width:calc(100% - 16px);
			max-width:none;
			font-size:11px;
			padding:8px 10px;
		}
		.app-form-logo-preview{
			width:92px;
			height:92px;
			background-color:rgba(0,0,0,0.16);
			backdrop-filter:blur(4px);
			border:1px dashed rgba(255,255,255,0.25);
		}
		.app-inline-logo-hint{
			font-size:10px;
			text-transform:uppercase;
			letter-spacing:0.4px;
			color:rgba(255,255,255,0.55);
			text-align:center;
		}
		.app-media-upload{
			position:absolute;
			inset:auto 0 14px 0;
			margin:auto;
			width:70%;
			max-width:220px;
			display:flex;
			align-items:center;
			justify-content:center;
			gap:8px;
			padding:10px 14px;
			border-radius:999px;
			border:none;
			background:rgba(15,15,30,0.72);
			color:#ffffff;
			font-size:13px;
			font-weight:600;
			opacity:0;
			transform:translateY(10px);
			transition:opacity .2s ease, transform .2s ease;
			pointer-events:none;
		}
		.app-media-preview:hover .app-media-upload,
		.app-media-preview:focus-within .app-media-upload{
			opacity:1;
			transform:translateY(0);
			pointer-events:auto;
		}
		.app-media-upload svg{width:16px; height:16px; opacity:0.9;}
		.app-media-input{display:none;}
		.app-media-preview.empty::before{
			content:"Drop or upload";
			position:absolute;
			inset:0;
			display:flex;
			align-items:center;
			justify-content:center;
			font-size:12px;
			color:rgba(255,255,255,0.4);
			pointer-events:none;
		}
		.app-category-field{
			display:flex;
			flex-direction:column;
			gap:10px;
		}
		.app-category-label{
			font-size:14px;
			font-weight:600;
			color:rgba(255,255,255,0.75);
		}
		.app-category-select{
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.4);
			color:#ffffff;
			font-size:14px;
			font-weight:600;
			appearance:none;
			background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpolyline points="6 9 12 15 18 9"/%3E%3C/svg%3E');
			background-repeat:no-repeat;
			background-position:right 14px center;
			background-size:16px;
		}
		.app-category-select:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.app-form-layout{
			display:grid;
			grid-template-columns:minmax(0, 1.6fr) minmax(0, 1fr);
			gap:28px;
			align-items:flex-start;
		}
		.app-settings-editor{
			grid-column:1 / -1;
			display:flex;
			flex-direction:column;
			gap:18px;
			padding:22px;
			border-radius:22px;
			background:linear-gradient(165deg, rgba(20,24,46,0.84) 0%, rgba(12,14,28,0.94) 100%);
			border:1px solid rgba(132,164,255,0.16);
			box-shadow:0 26px 46px rgba(6,10,30,0.32), inset 0 0 0 1px rgba(255,255,255,0.02);
		}
		.app-settings-editor-header{
			display:flex;
			justify-content:space-between;
			align-items:flex-start;
			gap:22px;
		}
		.app-settings-editor-actions{
			display:flex;
			align-items:center;
			gap:12px;
		}
		.app-settings-editor-header h4{
			margin:0;
			font-size:18px;
			font-weight:700;
			letter-spacing:0.4px;
			color:#ffffff;
		}
		.app-settings-editor-header p{
			margin:6px 0 0;
			font-size:13px;
			color:rgba(186,204,232,0.72);
			line-height:1.6;
		}
		.app-settings-editor-body{
			display:grid;
			grid-template-columns:minmax(200px, 280px) minmax(0, 1fr);
			gap:20px;
		}
		.app-settings-tab-list{
			display:flex;
			flex-direction:column;
			gap:12px;
			max-height:480px;
			overflow:auto;
			padding-right:6px;
			scrollbar-width:thin;
			scrollbar-color:rgba(0,199,255,0.48) rgba(6,8,20,0.78);
		}
		.app-settings-tab-list::-webkit-scrollbar{
			width:8px;
		}
		.app-settings-tab-list::-webkit-scrollbar-track{
			background:rgba(6,8,20,0.78);
			border-radius:999px;
		}
		.app-settings-tab-list::-webkit-scrollbar-thumb{
			background:linear-gradient(135deg, rgba(0,199,255,0.68), rgba(0,132,255,0.5));
			border-radius:999px;
			border:2px solid rgba(6,8,18,0.92);
			box-shadow:0 8px 18px rgba(0,0,0,0.28);
		}
		.app-settings-tab-list::-webkit-scrollbar-thumb:hover{
			background:linear-gradient(135deg, rgba(60,224,255,0.82), rgba(12,166,255,0.6));
		}
		.app-settings-tab-item{
			display:flex;
			flex-direction:column;
			gap:12px;
			padding:14px;
			border-radius:16px;
			background:rgba(12,16,32,0.82);
			border:1px solid rgba(132,164,255,0.12);
			box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);
		}
		.app-settings-tab-select{
			display:flex;
			justify-content:space-between;
			align-items:center;
			gap:12px;
			padding:12px 14px;
			border-radius:12px;
			border:none;
			background:rgba(255,255,255,0.05);
			color:#ffffff;
			font-size:14px;
			font-weight:600;
			cursor:pointer;
			transition:all 0.2s ease;
		}
		.app-settings-tab-select.active{
			background:linear-gradient(140deg, rgba(0,199,255,0.32), rgba(0,132,255,0.26));
			box-shadow:0 18px 30px rgba(0,0,0,0.28), inset 0 0 0 1px rgba(0,199,255,0.42);
		}
		.app-settings-tab-select span.status{
			font-size:11px;
			font-weight:600;
			letter-spacing:0.4px;
			text-transform:uppercase;
			color:rgba(173,222,255,0.75);
		}
		.app-settings-tab-fields{
			display:flex;
			flex-direction:column;
			gap:10px;
		}
		.app-settings-tab-fields label{
			display:flex;
			flex-direction:column;
			gap:6px;
			font-size:12px;
			font-weight:600;
			color:rgba(174,205,255,0.7);
		}
		.app-settings-tab-fields input[type="text"]{
			width:100%;
			padding:10px 12px;
			border-radius:10px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.3);
			color:#ffffff;
			font-size:13px;
		}
		.app-settings-tab-fields input[type="text"]:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.app-settings-tab-toggle{
			display:flex;
			align-items:center;
			gap:8px;
			font-size:12px;
			font-weight:600;
			color:rgba(186,204,232,0.75);
		}
		.app-settings-tab-footer{
			display:flex;
			justify-content:flex-end;
			gap:10px;
		}
		.app-settings-tab-footer button{
			padding:6px 10px;
			border-radius:8px;
			border:none;
			font-size:12px;
			font-weight:600;
			cursor:pointer;
		}
		.app-settings-tab-footer .danger{
			background:rgba(255,99,132,0.18);
			color:#ff6b81;
		}
		.app-settings-tab-footer .danger:hover{
			background:rgba(255,99,132,0.32);
		}
		.app-settings-tab-detail{
			display:flex;
			flex-direction:column;
			gap:16px;
			padding:18px;
			border-radius:18px;
			background:rgba(10,14,28,0.78);
			border:1px solid rgba(132,164,255,0.12);
			min-height:320px;
		}
		.app-settings-tab-detail header{
			display:flex;
			justify-content:space-between;
			align-items:center;
			gap:16px;
		}
		.app-settings-tab-detail header h5{
			margin:0;
			font-size:16px;
			font-weight:700;
			color:#ffffff;
		}
		.app-settings-section-list{
			display:flex;
			flex-direction:column;
			gap:14px;
		}
		.app-settings-section-card{
			display:flex;
			flex-direction:column;
			gap:12px;
			padding:16px;
			border-radius:14px;
			background:rgba(12,18,36,0.85);
			border:1px solid rgba(255,255,255,0.08);
		}
		.app-settings-section-card header{
			display:flex;
			justify-content:space-between;
			align-items:center;
			gap:12px;
		}
		.app-settings-section-card header input[type="text"]{
			flex:1 1 auto;
			padding:10px 12px;
			border-radius:10px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.3);
			color:#ffffff;
		}
		.app-settings-section-card header button{
			border:none;
			background:rgba(255,99,132,0.18);
			color:#ff6b81;
			border-radius:10px;
			padding:8px 12px;
			font-size:12px;
			font-weight:600;
			cursor:pointer;
		}
		.app-settings-section-actions{
			display:flex;
			align-items:center;
			gap:10px;
		}
		.app-settings-section-actions select{
			padding:9px 12px;
			border-radius:10px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.35);
			color:#ffffff;
			font-size:13px;
		}
		.app-settings-section-actions select:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.app-settings-option-list{
			display:flex;
			flex-direction:column;
			gap:10px;
		}
		.app-settings-option-row{
			display:grid;
			grid-template-columns:minmax(0, 1fr) minmax(0, 1fr) auto;
			gap:8px;
			align-items:center;
		}
		.app-settings-option-row input[type="text"]{
			padding:9px 11px;
			border-radius:10px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.4);
			color:#ffffff;
			font-size:13px;
		}
		.app-settings-option-row button{
			border:none;
			background:rgba(255,99,132,0.2);
			color:#ff6b81;
			border-radius:8px;
			padding:8px;
			cursor:pointer;
			display:flex;
			align-items:center;
			justify-content:center;
			gap:6px;
		}
		.app-settings-option-row button svg{
			width:14px;
			height:14px;
		}
		.app-settings-option-actions{
			display:flex;
			justify-content:flex-end;
			gap:8px;
		}
		.app-settings-option-actions button{
			border:none;
			border-radius:10px;
			padding:9px 14px;
			font-size:12px;
			font-weight:600;
			cursor:pointer;
		}
		.app-settings-option-actions .add-option{
			background:rgba(0,199,255,0.24);
			color:#ffffff;
		}
		.app-settings-option-actions .add-option:hover{
			background:rgba(0,199,255,0.34);
		}
		.app-settings-empty-state{
			padding:24px;
			border-radius:14px;
			background:rgba(255,255,255,0.04);
			border:1px dashed rgba(255,255,255,0.12);
			text-align:center;
			font-size:14px;
			color:rgba(186,204,232,0.72);
		}
		.app-form-left{
			display:flex;
			flex-direction:column;
			gap:18px;
		}
		.app-form-previews{
			display:grid;
			grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
			gap:18px;
		}
		.app-form-right{
			display:flex;
			flex-direction:column;
			gap:18px;
		}
		.app-special-media{
			display:none;
		}
		.app-special-media.active{
			display:flex;
			flex-direction:column;
			gap:12px;
		}
		.app-special-preview{
			min-height:280px;
		}
		.app-form-footer{
			display:flex;
			justify-content:flex-end;
			align-items:center;
			gap:16px;
			margin-top:12px;
		}
		.special-option-field{
			display:flex;
			flex-direction:column;
			gap:8px;
		}
		.character-name-field{
			display:none;
			flex-direction:column;
			gap:8px;
		}
		.character-name-field.active{
			display:flex;
		}
		.character-trn-config{
			display:none;
			flex-direction:column;
			gap:12px;
		}
		.character-trn-config.active{
			display:flex;
		}
		.character-trn-field{
			display:flex;
			flex-direction:column;
			gap:6px;
		}
		.character-trn-label{
			font-size:14px;
			font-weight:600;
			color:rgba(255,255,255,0.75);
		}
		.character-trn-input,
		.character-trn-select{
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.4);
			color:#ffffff;
			font-size:14px;
			font-weight:600;
		}
		.character-trn-input:focus,
		.character-trn-select:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.character-trn-hint{
			font-size:12px;
			color:rgba(186,204,232,0.7);
		}
		.special-option-label{
			font-size:14px;
			font-weight:600;
			color:rgba(255,255,255,0.75);
		}
		.character-name-label{
			font-size:14px;
			font-weight:600;
			color:rgba(255,255,255,0.75);
		}
		.special-option-select{
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.4);
			color:#ffffff;
			font-size:14px;
			font-weight:600;
		}
		.special-option-select:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.character-name-input{
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid rgba(255,255,255,0.14);
			background:rgba(0,0,0,0.4);
			color:#ffffff;
			font-size:14px;
			font-weight:600;
		}
		.character-name-input:focus{
			outline:none;
			border-color:rgba(0,199,255,0.6);
			box-shadow:0 0 0 3px rgba(0,199,255,0.12);
		}
		.app-form-actions{
			display:flex;
			gap:10px;
			flex-wrap:wrap;
		}
		.app-form-actions .save-app-btn{
			background:#ffffff;
			color:#0d0d19;
			border-color:transparent;
			box-shadow:0 10px 20px rgba(0,0,0,0.18);
		}
		.app-form-actions .save-app-btn:hover{
			transform:translateY(-1px);
			box-shadow:0 14px 26px rgba(0,0,0,0.24);
		}
		.app-form-actions .save-app-btn:focus{
			outline:none;
			box-shadow:0 0 0 3px rgba(255,255,255,0.35);
		}
		@media (max-width: 900px){
			.app-form-layout{grid-template-columns:1fr;}
			.app-name-field{grid-template-columns:1fr;}
			.app-inline-logo{flex-direction:row; justify-content:flex-start; align-items:center; gap:12px; min-width:0; flex-wrap:wrap;}
			.app-inline-logo-hint{width:100%; text-align:left; margin-top:2px;}
			.app-inline-logo-hint{margin:0;}
			.app-settings-editor-body{grid-template-columns:1fr;}
			.app-settings-tab-list{max-height:none;}
		}
		@media (max-width: 640px){
			.app-form-previews{grid-template-columns:1fr;}
			.app-form-logo-preview{justify-self:start;}
			.settings-template-row{grid-template-columns:1fr; gap:6px;}
			.settings-template-hero-overlay{flex-direction:column; align-items:flex-start; gap:12px;}
			.settings-template-badge{margin-left:0;}
			.app-settings-editor{
				padding:18px;
			}
			.app-settings-editor-body{gap:16px;}
			.app-settings-tab-select{font-size:13px;}
			.app-settings-tab-fields input[type="text"]{font-size:12px;}
			.app-settings-section-actions{flex-direction:column; align-items:flex-start; width:100%;}
			.app-settings-section-actions select{width:100%;}
			.app-settings-section-actions button{width:100%;}
			.app-settings-section-card header{flex-direction:column; align-items:stretch;}
			.app-settings-section-card header button{width:100%;}
			.app-settings-option-row{grid-template-columns:1fr;}
			.app-settings-option-row button{justify-self:flex-start;}
		}
		.settings-app-list{
			width:100%;
			display:grid;
			grid-template-columns:repeat(auto-fill, minmax(190px, 1fr));
			gap:16px;
			margin:0;
			padding:4px;
			box-sizing:border-box;
			max-height:100%;
			overflow:auto;
		}
		.settings-grid-hint{
			margin:0 0 18px;
			color:var(--muted);
			font-size:14px;
			text-align:left;
		}
		.settings-app-display{
			position:relative;
			min-height:220px;
			border-radius:18px;
			border:1px solid rgba(255,255,255,0.12);
			background:rgba(255,255,255,0.06);
			background-size:cover;
			background-position:center;
			overflow:hidden;
			display:flex;
			align-items:flex-end;
			justify-content:center;
			width:100%;
			aspect-ratio:1080 / 1640;
			cursor:pointer;
			transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
		}
		.settings-app-display::after{
			content:"";
			position:absolute;
			inset:0;
			background:linear-gradient(180deg, rgba(10,10,20,0.05), rgba(10,10,20,0.85));
			z-index:0;
			pointer-events:none;
		}
		.settings-app-display .app-card-overlay{
			z-index:1;
			opacity:1;
			transform:none;
			padding:22px 18px;
			align-items:center;
			text-align:center;
			gap:10px;
		}
		.settings-app-display .app-card-overlay.static img{
			width:44px;
			height:44px;
			border-radius:12px;
			background-color:transparent;
		}
		.settings-app-display .app-card-overlay.static .app-card-name{
			font-size:16px;
		}
		.settings-app-display.selected{
			border-color:rgba(0,199,255,0.7);
			box-shadow:0 20px 32px rgba(0,0,0,0.35);
			transform:translateY(-4px);
		}
		.settings-app-display.selected::after{
			opacity:0.55;
		}
		.character-trn-panel{
			position:relative;
			display:flex;
			flex-direction:column;
			justify-content:flex-end;
			flex:1 1 auto;
			min-height:440px;
			width:100%;
			height:100%;
			padding:40px 32px 48px;
			border-radius:inherit;
			overflow:hidden;
			background:rgba(10,12,26,0.92) center/cover no-repeat;
			box-shadow:none;
		}
		.character-trn-panel::after{
			content:"";
			position:absolute;
			inset:0;
			background:linear-gradient(190deg, rgba(6,8,18,0.05) 0%, rgba(6,8,18,0.78) 60%, rgba(6,8,18,0.96) 100%);
			z-index:0;
		}
		.character-trn-panel.empty{
			background:linear-gradient(160deg, rgba(26,30,54,0.92), rgba(12,14,28,0.96));
		}
		.character-trn-panel.empty::before{
			content:"Character Portrait";
			position:absolute;
			top:50%;
			left:50%;
			transform:translate(-50%, -50%);
			font-size:14px;
			font-weight:600;
			letter-spacing:0.12em;
			color:rgba(255,255,255,0.6);
			text-transform:uppercase;
			z-index:1;
			pointer-events:none;
		}
		.character-trn-content{
			position:relative;
			z-index:1;
			display:flex;
			flex-direction:column;
			align-items:flex-start;
			justify-content:flex-end;
			gap:24px;
			width:100%;
		}
		.character-trn-name{
			margin:0;
			font-size:34px;
			font-weight:700;
			letter-spacing:-0.02em;
			color:#ffffff;
			text-align:left;
			text-shadow:0 18px 38px rgba(0,0,0,0.55);
		}
		.character-trn-name a{
			color:inherit;
			text-decoration:none;
		}
		.character-trn-name a:hover{
			color:#9ae7ff;
			text-decoration:underline;
		}
		.character-trn-meta{
			display:flex;
			justify-content:flex-start;
			gap:40px;
			flex-wrap:wrap;
		}
		.character-trn-meta-item{
			display:flex;
			flex-direction:column;
			gap:6px;
			align-items:flex-start;
		}
		.character-trn-meta-label{
			font-size:12px;
			font-weight:600;
			letter-spacing:0.36em;
			text-transform:uppercase;
			color:rgba(186,208,255,0.68);
		}
		.character-trn-meta-value{
			font-size:24px;
			font-weight:700;
			color:#ffffff;
			line-height:1.2;
		}
		.character-trn-meta-value a{
			color:#9ae7ff;
			text-decoration:none;
			font-weight:700;
		}
		.character-trn-meta-value a:hover{
			color:#ffffff;
			text-decoration:underline;
		}
		.settings-detail-overlay{
			justify-content:center;
			align-items:flex-start;
			padding:48px clamp(24px, 4vw, 72px);
		}
		.settings-detail-columns{
			display:flex;
			gap:28px;
			align-items:stretch;
			flex-wrap:wrap;
			width:min(1380px, 96vw);
		}
		.settings-detail-overlay:not(.has-character) .settings-detail-columns{
			justify-content:center;
			width:min(980px, 92vw);
		}
		.settings-detail-panel{
			background:linear-gradient(160deg, rgba(20,24,44,0.95) 0%, rgba(12,14,28,0.98) 100%);
			border:1px solid rgba(132,164,255,0.18);
			border-radius:28px;
			padding:0;
			width:min(920px, 72vw);
			display:flex;
			flex-direction:column;
			overflow:hidden;
			box-shadow:0 34px 60px rgba(8,10,24,0.55), inset 0 0 0 1px rgba(255,255,255,0.03);
			backdrop-filter:blur(18px);
		}
		.settings-detail-panel .popup-header{
			padding:30px 38px 22px;
			border-bottom:1px solid rgba(255,255,255,0.08);
			background:linear-gradient(180deg, rgba(6,10,26,0.18) 0%, rgba(6,10,26,0.32) 100%);
			backdrop-filter:blur(18px);
		}
		.settings-detail-panel .popup-body{
			padding:0;
			max-height:calc(82vh - 110px);
			overflow:auto;
			scrollbar-width:none;
			display:flex;
			flex-direction:column;
		}
		.settings-detail-panel .popup-body::-webkit-scrollbar{
			width:0;
		}
		.settings-detail-panel .close-btn{
			top:26px;
			right:28px;
		}
		.character-detail-panel{
			position:relative;
			display:flex;
			flex-direction:column;
			width:min(420px, 26vw);
			padding:0;
			background:transparent;
			border:none;
			border-radius:26px;
			overflow:hidden;
			box-shadow:0 34px 60px rgba(8,10,24,0.55);
		}
		.character-detail-body{
			position:relative;
			flex:1 1 auto;
			min-height:100%;
			width:100%;
			display:flex;
			align-items:stretch;
		}
		.character-detail-panel[aria-hidden="true"]{
			display:none;
		}
		.settings-app-detail{
			display:flex;
			flex-direction:column;
			gap:32px;
			padding:0 0 42px;
			margin:0;
		}
		.settings-app-template{
			display:flex;
			flex-direction:column;
			gap:28px;
		}
		.settings-template-hero{
			position:relative;
			height:260px;
			width:100%;
			border-radius:0;
			overflow:hidden;
			background:rgba(255,255,255,0.06) center/cover no-repeat;
			border-bottom:1px solid rgba(132,164,255,0.18);
		}
		.settings-template-hero::after{
			content:"";
			position:absolute;
			inset:0;
			background:linear-gradient(190deg, rgba(4,6,12,0.02) 0%, rgba(4,6,12,0.25) 100%);
		}
		.settings-template-hero-overlay{
			position:absolute;
			inset:0;
			padding:40px;
			display:flex;
			flex-direction:column;
			align-items:flex-start;
			justify-content:flex-end;
			gap:22px;
			z-index:1;
		}
		.settings-template-body{
			display:flex;
			flex-direction:column;
			gap:0;
		}
		.app-settings-tab-bar{
			display:flex;
			gap:12px;
			padding:10px 38px 6px;
			margin-top:-20px;
			position:relative;
			z-index:2;
			overflow-x:auto;
			scrollbar-width:thin;
			scrollbar-color:#ffffff transparent;
			scroll-snap-type:x proximity;
		}
		.app-settings-tab-bar::-webkit-scrollbar{
			height:8px;
		}
		.app-settings-tab-bar::-webkit-scrollbar-track{
			background:transparent;
		}
		.app-settings-tab-bar::-webkit-scrollbar-thumb{
			background:#ffffff;
			border-radius:999px;
		}
		.app-settings-tab-bar::-webkit-scrollbar-thumb:hover{
			background:#f1f1f1;
		}
		.app-settings-tab-bar.empty{
			min-height:48px;
		}
		.app-settings-tab{
			border:none;
			background:rgba(255,255,255,0.05);
			color:rgba(255,255,255,0.78);
			padding:12px 18px;
			border-radius:14px;
			font-size:13px;
			font-weight:600;
			letter-spacing:0.32px;
			text-transform:uppercase;
			cursor:pointer;
			transition:all 0.2s ease;
			white-space:nowrap;
			scroll-snap-align:center;
			box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06);
		}
		.app-settings-tab:hover{
			background:rgba(0,199,255,0.18);
			color:#ffffff;
			box-shadow:inset 0 0 0 1px rgba(0,199,255,0.36);
		}
		.app-settings-tab.active{
			background:linear-gradient(135deg, rgba(0,199,255,0.32), rgba(0,132,255,0.28));
			color:#ffffff;
			box-shadow:0 18px 32px rgba(0,0,0,0.28), inset 0 0 0 1px rgba(0,199,255,0.46);
			transform:translateY(-2px);
		}
		.settings-template-hero-overlay img,
		.settings-template-logo-fallback{
			width:68px;
			height:68px;
			border-radius:0;
			box-shadow:0 24px 46px rgba(6,10,30,0.55);
			background:rgba(8,10,20,0.72);
			display:flex;
			align-items:center;
			justify-content:center;
			font-size:26px;
			font-weight:700;
			color:#ffffff;
		}
		.settings-template-hero-overlay h4{
			margin:0;
			font-size:26px;
			font-weight:700;
			letter-spacing:0.02em;
			color:#ffffff;
			text-shadow:0 12px 30px rgba(0,0,0,0.45);
		}
		.settings-template-badge{
			display:inline-flex;
			align-items:center;
			padding:8px 16px;
			background:linear-gradient(135deg, rgba(0,199,255,0.26), rgba(0,132,255,0.14));
			border:1px solid rgba(0,199,255,0.32);
			border-radius:999px;
			font-size:11px;
			letter-spacing:0.45px;
			text-transform:uppercase;
			color:#9ae7ff;
			margin-left:auto;
			box-shadow:0 12px 24px rgba(0,122,255,0.24);
		}
		.settings-template-sections{
			display:flex;
			flex-direction:column;
			gap:26px;
			padding:24px 38px 38px;
		}
		.settings-template-section{
			display:flex;
			flex-direction:column;
			gap:18px;
			background:linear-gradient(165deg, var(--settings-section-bg-start) 0%, var(--settings-section-bg-end) 100%);
			border:1px solid var(--settings-section-border);
			border-radius:22px;
			padding:24px 28px 26px;
			box-shadow:0 26px 46px rgba(6,10,30,0.32), inset 0 0 0 1px rgba(255,255,255,0.02);
			backdrop-filter:blur(12px);
		}
		.settings-template-section h5{
			margin:0;
			font-size:14px;
			font-weight:700;
			letter-spacing:0.48px;
			text-transform:uppercase;
			color:var(--settings-section-heading);
		}
		.settings-template-grid{
			display:grid;
			gap:16px;
			margin:0;
		}
		.settings-template-row{
			display:grid;
			grid-template-columns:minmax(140px, 200px) minmax(0, 1fr);
			gap:18px;
			align-items:start;
		}
		.settings-template-row dt{
			margin:0;
			font-size:12px;
			font-weight:600;
			color:var(--settings-section-row-label);
			text-transform:uppercase;
			letter-spacing:0.42px;
			min-width:0;
		}
		.settings-template-row dd{
			margin:0;
			font-size:16px;
			font-weight:600;
			color:var(--settings-section-row-value);
			line-height:1.5;
			word-break:break-word;
			min-width:0;
		}
		.settings-template-placeholder{
			margin:0;
			color:var(--settings-section-placeholder);
			font-size:14px;
		}
		@media (max-width: 1280px){
			.settings-detail-columns{
				flex-direction:column;
				width:min(1000px, 92vw);
			}
			.settings-detail-panel,
			.character-detail-panel{
				width:100%;
			}
		}
		@media (max-width: 900px){
			.settings-detail-overlay{
				padding:36px 20px;
			}
			.settings-template-hero{
				height:220px;
				border-radius:0;
			}
			.settings-template-sections{
				padding:26px 24px 34px;
			}
			.settings-template-row{
				grid-template-columns:1fr;
			}
			.character-trn-panel{
				min-height:360px;
				padding:32px 24px 40px;
			}
			.character-trn-meta{
				gap:32px;
			}
		}
		@media (max-width: 720px){
			.settings-detail-panel .popup-header{
				padding:24px 26px 18px;
				background:linear-gradient(180deg, rgba(6,10,26,0.24) 0%, rgba(6,10,26,0.36) 100%);
			}
			.settings-detail-panel .popup-body{
				padding:0 0 26px;
				max-height:none;
			}
			.app-settings-tab-bar{
				padding:12px 20px;
				gap:8px;
			}
			.app-settings-tab{
				padding:10px 14px;
				font-size:12px;
			}
			.character-trn-panel{
				padding:28px 22px 36px;
			}
			.settings-template-hero-overlay{
				padding:26px;
				flex-direction:column;
				align-items:flex-start;
			}
			.settings-template-sections{
				padding:20px 20px 26px;
			}
			.settings-template-hero-overlay img,
			.settings-template-logo-fallback{
				width:56px;
				height:56px;
			}
			.character-trn-meta{
				gap:26px;
			}
		}
		@media (max-width: 520px){
			.settings-app-detail{
				padding:0 0 30px;
			}
			.settings-template-section{
				padding:20px;
			}
			.settings-template-sections{
				padding:18px 16px 26px;
			}
			.settings-template-hero-overlay h4{
				font-size:22px;
			}
			.character-trn-panel{
				min-height:300px;
				padding:26px 18px 32px;
			}
			.character-trn-meta{
				flex-direction:column;
				gap:18px;
			}
			.character-trn-name{
				font-size:28px;
			}
		}
		@media (max-width: 900px){
			.popup-overlay.game-settings-overlay{
				padding:32px 0;
			}
			.popup-content.game-settings-panel{
				min-height:70vh;
				width:96vw;
				max-height:calc(100vh - 60px);
			}
			.popup-content.game-settings-panel .popup-body{
				padding:24px;
			}
			.popup-content.game-settings-panel .settings-layout{
				grid-template-columns:1fr;
			}
			.popup-content.game-settings-panel .settings-tabs{
				width:100%;
				flex-direction:row;
				flex-wrap:wrap;
				gap:8px;
			}
			.popup-content.game-settings-panel .settings-tab{
				flex:1 1 calc(50% - 8px);
				text-align:center;
				justify-content:center;
			}
			.popup-content.game-settings-panel .settings-content{
				min-height:320px;
			}
			.settings-app-layout{
				grid-template-columns:1fr;
				gap:18px;
			}
			.settings-app-layout .settings-app-detail{
				order:-1;
			}
			.settings-app-list{
				max-height:none;
			}
		}
		
		.stream-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
		.stream-switcher{display:flex; background:rgba(255,255,255,0.08); border-radius:8px; padding:2px; gap:2px}
		.stream-switch{background:transparent; border:none; color:var(--muted); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; transition:all .2s ease}
		.stream-switch.active{background:rgba(255,255,255,0.12); color:var(--text)}
		.stream-switch:hover{background:rgba(255,255,255,0.06); color:var(--text)}
		
		.embed-container{position:relative; width:100%; height:100%}
		.embed-frame{width:100%; height:100%; border:0}
		.embed-frame.hidden{display:none !important;}
		.tags{margin-top:12px; display:flex; flex-wrap:wrap; gap:10px}
		.tag{
			padding:6px 10px; border-radius:999px; font-size:12px;
			background:rgba(255,255,255,0.06);
			border:1px solid rgba(255,255,255,0.1);
			color:#ededff;
		}

		.schedule{display:grid; gap:10px}
		.slot{
			display:flex; justify-content:space-between; align-items:center;
			padding:12px; border-radius:12px;
			background:rgba(255,255,255,0.04);
			border:1px solid rgba(255,255,255,0.08);
			box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
		}
		.slot .day{font-weight:700}
		.slot .time{color:var(--muted)}

		.footer{
			margin-top:25px;
			color:var(--muted);
			font-size:13px;
			position:relative;
			z-index:2;
			width:100%;
			flex:0 0 100%;
			display:flex;
			flex-direction:column;
			align-items:center;
			text-align:center;
			gap:4px;
		}
		#counter{
			position:relative;
			z-index:2;
			display:flex;
			justify-content:center;
			align-items:flex-end;
			gap:4px;
		}

		/* Popup Styles */
		.popup-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(8px);
			-webkit-backdrop-filter: blur(8px);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			overflow:auto;
		}

		/* Ensure Colors Editor sits above Admin Panel */
		#colorsPopup { z-index: 1101; }
		#allSettingsManagerPopup { z-index: 1125; }
		#allSettingsAppFormPopup { z-index: 1135; }
		#settingsAppDetailPopup { z-index: 1145; }

		.popup-content {
			background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)), var(--card);
			border: 1px solid var(--border);
			box-shadow: var(--shadow), 0 0 100px rgba(145,70,255,0.15);
			backdrop-filter: blur(15px) saturate(150%);
			border-radius: calc(var(--radius) + 4px);
			min-width: 400px;
			max-width: 90vw;
			animation: popupSlideIn 0.3s ease-out;
		}

		#colorsPopup .popup-content{
			width:min(640px, 92vw);
			max-height:min(85vh, 780px);
			display:flex;
			flex-direction:column;
		}
		#colorsPopup .popup-body{
			flex:1 1 auto;
			overflow-y:auto;
			display:flex;
			flex-direction:column;
			gap:16px;
			padding:20px 24px 24px;
		}
		#colorsPopup .admin-setting{
			flex:1 1 auto;
			display:flex;
			flex-direction:column;
			gap:16px;
		}
		#colorsPopup .colors-list{
			flex:1 1 auto;
			display:grid;
			gap:12px;
			overflow-y:auto;
			padding-right:8px;
			max-height:none;
		}
		#colorsPopup .colors-actions{
			display:flex;
			flex-wrap:wrap;
			gap:10px;
			margin-top:4px;
			padding-top:12px;
			border-top:1px solid rgba(255,255,255,0.06);
		}
		#colorsPopup .colors-actions button{
			flex:1 1 220px;
			min-width:180px;
		}

		.popup-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 24px 16px;
			border-bottom: 1px solid var(--border);
		}

		.popup-header h3 {
			margin: 0;
			font-family: "Space Grotesk", Inter, sans-serif;
			font-size: 20px;
			font-weight: 700;
			color: var(--text);
		}

		.close-btn {
			background: none;
			border: none;
			color: var(--muted);
			font-size: 24px;
			cursor: pointer;
			padding: 0;
			width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 8px;
			transition: background-color 0.2s ease, color 0.2s ease;
		}

		.close-btn:hover {
			background-color: rgba(255, 255, 255, 0.1);
			color: var(--text);
		}

		.popup-body {
			padding: 20px 24px 24px;
		}

		.popup-body p {
			margin: 0 0 20px;
			color: var(--muted);
			font-size: 16px;
		}

		.popup-buttons {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.popup-button {
			display: flex;
			align-items: center;
			justify-content: flex-start;
			gap: 16px;
			padding: 0 20px;
			border-radius: 12px;
			text-decoration: none;
			color: white;
			font-weight: 600;
			font-size: 15px;
			border: 1px solid rgba(255, 255, 255, 0.12);
			transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
			position: relative;
			overflow: hidden;
			height: 58px;
			box-sizing: border-box;
		}

		.popup-button:hover {
			transform: translateY(-2px);
			filter: saturate(1.2);
		}

		.popup-button:active {
			transform: translateY(0);
		}

		.popup-button img {
			width: 24px;
			height: 24px;
			object-fit: contain;
			filter: invert(1) brightness(1.2) contrast(1.2);
			flex-shrink: 0;
		}

		.popup-button.tiktok img {
			width: 38px;
			height: 38px;
			flex-shrink: 0;
			margin-left: -7px;
			margin-right: -7px;
		}

		.popup-button.guns img {
			filter: brightness(1.2) contrast(1.2);
		}

		.popup-button.kofi img {
			filter: brightness(1.2) contrast(1.2);
		}

		.popup-button.twitch {
			background: linear-gradient(135deg, #9146FF, #7A39E0);
			box-shadow: 0 8px 24px rgba(145, 70, 255, 0.4);
		}

		.popup-button.youtube {
			background: linear-gradient(135deg, #9146FF, #7A39E0);
			box-shadow: 0 8px 24px rgba(145, 70, 255, 0.4);
		}

		.popup-button.twitter {
			background: linear-gradient(135deg, #1DA1F2, #1A8CD8);
			box-shadow: 0 8px 24px rgba(29, 161, 242, 0.4);
		}

		.popup-button.instagram {
			background: linear-gradient(135deg, #E4405F, #CA3A55);
			box-shadow: 0 8px 24px rgba(228, 64, 95, 0.4);
		}

		.popup-button.tiktok {
			background: linear-gradient(135deg, #9146FF, #7A39E0);
			box-shadow: 0 8px 24px rgba(145, 70, 255, 0.4);
		}

		.popup-button.guns {
			background: linear-gradient(135deg, #6B46C1, #5B3DA6);
			box-shadow: 0 8px 24px rgba(107, 70, 193, 0.4);
		}

		.popup-button.kofi {
			background: linear-gradient(135deg, #9146FF, #7A39E0);
			box-shadow: 0 8px 24px rgba(145, 70, 255, 0.4);
		}

		.popup-button.guns {
			background: linear-gradient(135deg, #6b46c1, #9333ea);
			box-shadow: 0 8px 24px rgba(147, 51, 234, 0.4);
		}

		@keyframes popupSlideIn {
			from {
				opacity: 0;
				transform: scale(0.9);
			}
			to {
				const profileLinkEl = panelEl.querySelector('[data-role="tracker-username-link"]');
				if (profileLinkEl) {
					if (profileUrl) {
						if (profileLinkEl.__preventDefaultHandler) {
							profileLinkEl.removeEventListener('click', profileLinkEl.__preventDefaultHandler);
							delete profileLinkEl.__preventDefaultHandler;
						}
						profileLinkEl.href = profileUrl;
					}
					if (username) {
						profileLinkEl.textContent = username;
					}
				}
				gap: 10px;
			}
			
			.popup-button {
				padding: 14px 16px;
				font-size: 14px;
			}
		}

		/* Admin Console Styles */
		.admin-button {
			position: fixed;
			bottom: 20px;
			right: 20px;
			width: 50px;
			height: 50px;
			background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
			border: 1px solid var(--border);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			backdrop-filter: blur(10px);
			box-shadow: var(--shadow);
			transition: all 0.3s ease;
			z-index: 999;
		}

		@media (max-width: 1200px) {
		}

		.admin-button:hover {
			transform: scale(1.1);
			background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
		}

		.admin-button svg {
			width: 20px;
			height: 20px;
			color: var(--text);
		}

		.admin-popup {
			min-width: 500px;
		}

		.admin-panel {
			min-width: 600px;
			max-width: 800px;
		}

		.admin-panel-body {
			max-height: 70vh;
			overflow-y: auto;
			scrollbar-width: none;
		}
		.admin-panel-body::-webkit-scrollbar {
			display: none;
		}
		#allSettingsAppFormPopup .popup-content {
			display:flex;
			flex-direction:column;
			max-height:90vh;
			height:90vh;
		}
		#allSettingsAppFormPopup .popup-header {
			flex:0 0 auto;
		}
		#allSettingsManagerPopup .popup-body {
			overflow-y:auto;
			overflow-x:auto;
		}
		#allSettingsManagerPopup .popup-body::-webkit-scrollbar {
			width:0;
		}
		#allSettingsManagerPopup .popup-body::-webkit-scrollbar:horizontal {
			height:10px;
		}
		#allSettingsAppFormPopup .popup-body {
			flex:1 1 auto;
			min-height:0;
			overflow-y:auto;
			overflow-x:auto;
		}
		#allSettingsAppFormPopup .popup-body::-webkit-scrollbar {
			width:0;
		}
		#allSettingsAppFormPopup .popup-body::-webkit-scrollbar:horizontal {
			height:10px;
		}

		.notification-center {
			position: fixed;
			bottom: 32px;
			right: 32px;
			display: flex;
			flex-direction: column;
			gap: 14px;
			z-index: 1200;
			pointer-events: none;
			width: min(360px, calc(100vw - 24px));
		}

		.notification-card {
			position: relative;
			display: grid;
			grid-template-columns: auto 1fr;
			gap: 16px;
			padding: 16px 18px;
			background: rgba(16, 16, 28, 0.88);
			border: 1px solid rgba(255, 255, 255, 0.12);
			border-radius: 14px;
			box-shadow: 0 18px 38px rgba(0, 0, 0, 0.45);
			backdrop-filter: blur(14px);
			color: var(--text);
			pointer-events: auto;
			opacity: 0;
			transform: translateY(12px) scale(0.98);
			animation: toast-enter 0.35s ease forwards;
		}

		.notification-card.closing {
			animation: toast-exit 0.28s ease forwards;
		}

		.notification-card::after {
			content: '';
			position: absolute;
			inset: 0;
			border-radius: 14px;
			border: 1px solid rgba(255, 255, 255, 0.08);
			pointer-events: none;
		}

		.notification-icon {
			width: 34px;
			height: 34px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			background: rgba(255, 255, 255, 0.06);
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		.notification-icon svg {
			width: 18px;
			height: 18px;
		}

		.notification-text {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}
		.notification-card.single-line .notification-text {
			align-items: center;
			text-align: center;
		}

		.notification-title {
			font-weight: 600;
			color: #ffffff;
			font-size: 15px;
		}

		.notification-message {
			color: rgba(255, 255, 255, 0.78);
			font-size: 14px;
			line-height: 1.4;
		}
		.notification-card.single-line .notification-message {
			text-align: center;
		}

		.notification-input {
			width: 100%;
			margin-top: 12px;
			padding: 10px 12px;
			border-radius: 9px;
			border: 1px solid rgba(255, 255, 255, 0.14);
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			font-size: 14px;
			transition: all 0.2s ease;
		}

		.notification-input::placeholder {
			color: rgba(255, 255, 255, 0.55);
		}

		.notification-input:focus {
			outline: none;
			border-color: rgba(255, 255, 255, 0.32);
			background: rgba(255, 255, 255, 0.08);
			box-shadow: 0 0 0 3px rgba(111, 182, 255, 0.2);
		}

		.notification-input.error {
			border-color: var(--error-strong);
			box-shadow: 0 0 0 3px var(--error-bg);
		}

		.notification-inline-error {
			margin-top: 6px;
			color: var(--error-main);
			font-size: 12px;
			line-height: 1.3;
		}

		.notification-helper {
			margin-top: 10px;
			color: var(--text-subtle);
			font-size: 12px;
			line-height: 1.4;
		}

		.notification-close {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 30px;
			height: 30px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			border: none;
			background: var(--surface-overlay);
			color: var(--text-stronger);
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.notification-close:hover {
			background: var(--surface-overlay-hover);
			color: var(--text);
		}

		.notification-actions {
			grid-column: 1 / -1;
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			margin-top: 12px;
		}

		.notification-action {
			min-width: 96px;
			padding: 9px 16px;
			border-radius: 8px;
			border: 1px solid var(--surface-button-border);
			background: var(--surface-button);
			color: var(--text-stronger);
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.notification-action:hover {
			background: var(--surface-button-hover);
			border-color: var(--surface-button-border-hover);
		}

		.notification-action.primary {
			background: var(--accent);
			border-color: var(--accent);
			color: var(--accent-contrast);
		}

		.notification-action.primary:hover {
			background: var(--accent-hover);
			border-color: var(--accent-hover);
		}

		.notification-card.notification-success .notification-icon {
			background: var(--success-bg);
			border-color: var(--success-border-strong);
			color: var(--success-main);
		}

		.notification-card.notification-info .notification-icon {
			background: var(--info-bg);
			border-color: var(--info-border-strong);
			color: var(--info-main);
		}

		.notification-card.notification-warning .notification-icon {
			background: var(--warning-bg);
			border-color: var(--warning-border-strong);
			color: var(--warning-main);
		}

		.notification-card.notification-error .notification-icon {
			background: var(--error-bg);
			border-color: var(--error-border-strong);
			color: var(--error-main);
		}

		.notification-card.notification-success {
			border-color: var(--success-border);
			box-shadow: 0 18px 38px var(--success-shadow);
		}

		.notification-card.notification-info {
			border-color: var(--info-border);
			box-shadow: 0 18px 38px var(--info-shadow);
		}

		.notification-card.notification-warning {
			border-color: var(--warning-border);
			box-shadow: 0 18px 38px var(--warning-shadow);
		}

		.notification-card.notification-error {
			border-color: var(--error-border);
			box-shadow: 0 18px 38px var(--error-shadow);
		}

		.notification-card.has-actions {
			padding-bottom: 14px;
		}

		@media (max-width: 720px) {
			.notification-center {
				right: 50%;
				transform: translateX(50%);
				bottom: 20px;
				width: min(92vw, 380px);
				align-items: center;
			}

			.notification-card {
				width: 100%;
			}
		}

		@keyframes toast-enter {
			0% {
				opacity: 0;
				transform: translateY(18px) scale(0.96);
			}
			100% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		@keyframes toast-exit {
			0% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
			100% {
				opacity: 0;
				transform: translateY(12px) scale(0.96);
			}
		}

		.admin-user-info {
			display: flex;
			align-items: center;
			gap: 15px;
			font-size: 14px;
			color: var(--muted);
		}

		.admin-logout-btn {
			background: var(--danger-overlay);
			border: 1px solid var(--danger-border);
			color: var(--text);
			padding: 4px 12px;
			border-radius: 6px;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.admin-logout-btn:hover {
			background: var(--danger-overlay-hover);
			color: var(--text);
		}

		.admin-logout-btn.alt-light {
			background: #ffffff;
			border: 1px solid #ffffff;
			color: #111111;
		}

		.admin-logout-btn.alt-light:hover {
			background: rgba(255, 255, 255, 0.85);
		}

		.profile-upload-row {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		.profile-preview {
			position: relative;
			width: 64px;
			height: 64px;
			min-width: 64px;
			border-radius: 12px;
			overflow: hidden;
			border: 1px solid var(--border);
			background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
			background-size: cover;
			background-position: center;
			cursor: pointer;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		.profile-preview:hover {
			transform: translateY(-1px);
			box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
		}

		.profile-preview:focus {
			outline: 2px solid rgba(255, 255, 255, 0.4);
			outline-offset: 3px;
		}

		.profile-preview.empty {
			background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
		}

		.profile-preview-overlay {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(10, 10, 20, 0.55);
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transition: opacity 0.2s ease;
		}

		.profile-preview:hover .profile-preview-overlay,
		.profile-preview:focus .profile-preview-overlay {
			opacity: 1;
		}

		.profile-preview-icon {
			width: 26px;
			height: 26px;
			filter: invert(1);
			opacity: 0.9;
		}

		.profile-input-stack {
			flex: 1;
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.profile-input-stack input {
			flex: 1;
		}

		@media (max-width: 720px) {
			.popup-overlay {
				align-items: flex-start;
				padding-top: 32px;
				padding-bottom: 32px;
			}

			.popup-content {
				width: min(94vw, 520px);
				min-width: 0;
				margin: 0 auto;
			}

			.popup-content.admin-panel,
			.admin-popup,
			.admin-panel {
				width: min(94vw, 520px);
				min-width: 0;
				max-width: 520px;
			}

			.admin-panel-body {
				max-height: calc(100vh - 180px);
				padding-right: 6px;
			}

			.popup-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 12px;
			}

			.popup-header .close-btn {
				align-self: flex-end;
			}

			.admin-user-info {
				flex-direction: column;
				align-items: flex-start;
				gap: 12px;
			}

			.profile-upload-row {
				flex-direction: column;
				align-items: stretch;
			}

			.profile-preview {
				width: 100%;
				height: 160px;
				min-width: 0;
			}

			.profile-input-stack {
				flex-direction: column;
				align-items: stretch;
			}

			.profile-input-stack input,
			.profile-input-stack button,
			.admin-setting input,
			.admin-setting select,
			.admin-setting textarea,
			.admin-setting button {
				width: 100%;
			}

			.admin-setting button {
				justify-content: center;
			}

			.admin-setting > div[style*="display:flex"] {
				flex-direction: column !important;
				align-items: stretch !important;
				gap: 12px !important;
			}

			.admin-setting > div[style*="display:grid"] {
				grid-template-columns: 1fr !important;
			}
		}

		/* Collaborators list */
		.collab-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; background: rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; margin-top:8px}
		.collab-email{color:var(--text); font-size:14px;}
		.collab-remove{background:transparent; border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:6px; cursor:pointer}
		.collab-remove:hover{color:var(--text); border-color: rgba(255,255,255,0.2)}
		.collab-owner{opacity:0.6}

		.google-signin-container {
			display: flex;
			justify-content: center;
			margin: 20px 0;
		}

		.google-signin-btn {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px 24px;
			background: white;
			color: #333;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.google-signin-btn:hover {
			background: #f8f8f8;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.google-signin-btn img {
			width: 20px;
			height: 20px;
		}

		.login-status {
			text-align: center;
			margin-top: 15px;
			padding: 10px;
			border-radius: 6px;
			font-size: 14px;
		}

		.login-status.success {
			background: rgba(0, 255, 0, 0.1);
			color: #00ff00;
			border: 1px solid rgba(0, 255, 0, 0.3);
		}

		.login-status.error {
			background: rgba(255, 0, 0, 0.1);
			color: #ff6b6b;
			border: 1px solid rgba(255, 0, 0, 0.3);
		}

		.admin-section {
			margin-bottom: 30px;
			padding: 20px;
			background: rgba(255,255,255,0.03);
			border: 1px solid var(--border);
			border-radius: 12px;
		}

		.admin-section h4 {
			margin: 0 0 15px 0;
			color: var(--text);
			font-size: 16px;
			font-weight: 600;
		}

		.admin-setting {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.admin-setting label {
			font-size: 14px;
			font-weight: 500;
			color: var(--text);
		}

		.admin-setting input {
			padding: 10px 14px;
			background: rgba(255,255,255,0.05);
			border: 1px solid var(--border);
			border-radius: 8px;
			color: var(--text);
			font-size: 14px;
		}

		.admin-setting input:focus {
			outline: none;
			border-color: rgba(145, 70, 255, 0.5);
			box-shadow: 0 0 0 2px rgba(145, 70, 255, 0.1);
		}

		.admin-setting select {
			padding: 10px 14px;
			background: rgba(255,255,255,0.05);
			border: 1px solid var(--border);
			border-radius: 8px;
			color: var(--text);
			font-size: 14px;
			cursor: pointer;
		}

		.admin-setting select:focus {
			outline: none;
			border-color: rgba(145, 70, 255, 0.5);
			box-shadow: 0 0 0 2px rgba(145, 70, 255, 0.1);
		}

		.admin-setting button {
			padding: 10px 20px;
			background: linear-gradient(90deg, var(--twitch), var(--twitch-2));
			border: 1px solid rgba(255,255,255,0.12);
			border-radius: 8px;
			color: white;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			align-self: flex-start;
		}

		.admin-setting button:hover {
			transform: translateY(-1px);
			filter: saturate(1.1);
		}

		.admin-setting button.admin-upload-btn {
			background: var(--surface-button);
			border: 1px solid var(--surface-button-border);
			color: var(--text);
			filter: none;
		}

		.admin-setting button.admin-upload-btn:hover {
			background: var(--surface-button-hover);
			border-color: var(--surface-button-border-hover);
		}

		.admin-upload-label {
			font-size: 13px;
			color: var(--text-subtle);
		}

		.admin-setting small {
			color: var(--muted);
			font-size: 12px;
			margin-top: -4px;
		}

		.admin-setting.page-logo-settings {
			gap: 0;
		}

		.page-logo-settings-card {
			display: flex;
			gap: 20px;
			padding: 18px;
			background: rgba(12, 12, 18, 0.55);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 14px;
			box-shadow: 0 24px 48px rgba(0, 0, 0, 0.35);
			flex-wrap: wrap;
		}

		.page-logo-previews {
			display: flex;
			gap: 18px;
			flex: 1 1 420px;
			min-width: 0;
		}

		.logo-preview-card {
			flex: 1 1 0;
			display: flex;
			flex-direction: column;
			gap: 10px;
			cursor: pointer;
		}

		.logo-preview-card.large {
			flex: 1.4 1 0;
		}

		.logo-preview-card.small {
			flex: 1 1 0;
		}

		.logo-preview-frame {
			position: relative;
			width: 100%;
			padding-top: 56.25%;
			background: rgba(0, 0, 0, 0.45);
			border: 1px dashed rgba(255, 255, 255, 0.28);
			border-radius: 12px;
			overflow: hidden;
			transition: border-color 0.2s ease, box-shadow 0.2s ease;
		}

		.logo-preview-card.small .logo-preview-frame {
			padding-top: 100%;
		}

		.logo-preview-card:focus .logo-preview-frame,
		.logo-preview-card:hover .logo-preview-frame {
			border-color: rgba(145, 70, 255, 0.8);
			box-shadow: 0 0 0 3px rgba(145, 70, 255, 0.18);
		}

		.logo-preview-frame img {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: none;
			filter: invert(100%);
			transition: transform 0.2s ease;
		}

		.logo-preview-frame.has-image img {
			display: block;
		}

		.logo-preview-placeholder {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			color: rgba(255, 255, 255, 0.6);
			font-size: 14px;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			pointer-events: none;
		}

		.logo-preview-frame.has-image .logo-preview-placeholder {
			opacity: 0;
		}

		.logo-preview-caption {
			font-size: 13px;
			font-weight: 600;
			color: rgba(255, 255, 255, 0.68);
			text-align: center;
		}

		.page-logo-meta {
			flex: 0 0 220px;
			display: flex;
			flex-direction: column;
			gap: 18px;
			min-width: 200px;
		}

		.page-logo-upload {
			display: grid;
			grid-template-columns: 1fr;
			gap: 10px;
		}

		.page-logo-upload .admin-upload-label {
			margin-top: -2px;
		}

		.page-logo-meta-fields {
			display: grid;
			gap: 12px;
		}

		.page-logo-meta-fields label {
			display: block;
		}

		.page-logo-meta-fields input {
			width: 100%;
		}

		.logo-invert-toggle {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 13px;
			color: var(--text);
		}

		.page-logo-actions {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.page-logo-actions button {
			width: 100%;
		}

		@media (max-width: 900px) {
			.page-logo-settings-card {
				flex-direction: column;
			}
			.page-logo-previews {
				flex-direction: column;
			}
			.logo-preview-card.large,
			.logo-preview-card.small {
				flex: none;
			}
			.page-logo-meta {
				flex: 1 1 auto;
				width: 100%;
			}
		}

		.current-settings {
			padding: 15px;
			background: rgba(255,255,255,0.02);
			border-radius: 8px;
		}

		.current-settings p {
			margin: 8px 0;
			font-size: 14px;
			color: var(--muted);
		}

		.current-settings strong {
			color: var(--text);
		}

		/* Responsive */
		@media (max-width: 980px){
			.grid{grid-template-columns:1fr 1fr}
			.gallery{grid-template-columns:1fr}
		}
		@media (max-width: 640px){
			.grid{grid-template-columns:1fr}
			.header{grid-template-columns:80px 1fr; padding:16px}
			.avatar{width:80px; height:80px}
			.actions{grid-column:1 / -1; justify-self:start}
			.name{font-size:24px}
			.gallery{grid-template-columns:1fr}
		}

		/* Mobile and Tablet: Header scrolls with page, not fixed */
		@media (max-width: 1200px) { /* Changed from 980px to include landscape tablets */
			/* Enable scrolling on tablet and mobile */
			html, body {
				overflow-x: hidden;
				overflow-y: auto;
			}
			
			.container {
				margin-top: 150px; /* Create space for logo and social bar */
				padding-top: 20px;
			}
			
			.page-logo {
				position: absolute; /* Change from fixed to absolute so it scrolls */
				width: 100px; /* Bigger logo */
				height: 100px;
				top: 20px; /* Align with social links */
				left: 20px; /* Keep it on the left like desktop */
			}
			
			.social-bar {
				position: absolute; /* Change from fixed to absolute so it scrolls */
				top: 60px; /* Align centers with logo */
				right: 20px; /* Keep it on the right like desktop */
				left: auto;
				gap: 6px;
			}
			
			.social-link {
				width: 20px;
				height: 20px;
			}
		}

		@media (max-width: 640px) {
			.container {
				margin-top: 130px; /* Smaller space on phone */
				padding-top: 15px;
			}
			
			.page-logo {
				position: absolute; /* Change from fixed to absolute so it scrolls */
				width: 80px; /* Bigger on mobile too */
				height: 80px;
				left: 15px;
				top: 15px; /* Align to social links */
			}
			
			.social-bar {
				position: absolute; /* Change from fixed to absolute so it scrolls */
				top: 46px; /* Align centers with logo */
				right: 15px;
			}
			
			.social-link {
				width: 18px;
				height: 18px;
			}
		}

		/* Hide elements until database loads */
		.db-loading .name,
		.db-loading .bio,
		.db-loading .username,
		.db-loading .handle,
		.db-loading .user-handle,
		.db-loading .about,
		.db-loading .stat,
		.db-loading .badge,
		.db-loading .page-logo,
		.db-loading .social-bar,
		.db-loading .button,
		.db-loading .schedule .slot {
			opacity: 0.3;
			pointer-events: none;
		}

		.db-loaded .name,
		.db-loaded .bio,
		.db-loaded .username,
		.db-loaded .handle,
		.db-loaded .user-handle,
		.db-loaded .about,
		.db-loaded .stat,
		.db-loaded .badge,
		.db-loaded .page-logo,
		.db-loaded .social-bar,
		.db-loaded .button,
		.db-loaded .schedule .slot {
			opacity: 1;
			pointer-events: auto;
			transition: opacity 0.5s ease;
		}

		/* Website Effects */
		.effect-color {
			/* Base class kept for compatibility; dynamic hue is applied via JS */
			filter: hue-rotate(45deg) saturate(1.5);
		}
		
		.effect-grayscale {
			/* Grayscale is applied via inline filters when the toggle is active. */
			--effect-grayscale-active: 1;
		}
		
		.effect-sepia {
			filter: sepia(70%);
		}
		
		.effect-invert {
			filter: invert(1);
		}
		
		.effect-brightness {
			filter: brightness(1.3);
		}
		
		.effect-blur-bg {
			/* Deprecated: blur is now controlled via the .bg-glass overlay */
			backdrop-filter: blur(8px);
		}
		
		.effect-blur-bg .container {
			/* Deprecated: see note above */
			background: rgba(0, 0, 0, 0.2);
			backdrop-filter: blur(10px);
		}

		/* Helper state to hide the global glass overlay (used by Blur toggle) */
		.bg-glass.hidden { display: none; }
		
		/* Combined effects support */
		.effect-color.effect-grayscale {
			filter: hue-rotate(45deg) saturate(1.5);
		}
		
		.effect-color.effect-sepia {
			filter: hue-rotate(45deg) saturate(1.5) sepia(70%);
		}
		
		.effect-grayscale.effect-sepia {
			filter: sepia(70%);
		}
		
		.effect-color.effect-brightness {
			filter: hue-rotate(45deg) saturate(1.5) brightness(1.3);
		}
		
		.effect-grayscale.effect-brightness {
			filter: brightness(1.3);
		}
		
		.effect-sepia.effect-brightness {
			filter: sepia(70%) brightness(1.3);
		}
		
		.effect-invert.effect-color {
			filter: invert(1) hue-rotate(45deg) saturate(1.5);
		}
		
		.effect-invert.effect-grayscale {
			filter: invert(1);
		}
		
		.effect-invert.effect-sepia {
			filter: invert(1) sepia(70%);
		}
		
		.effect-invert.effect-brightness {
			filter: invert(1) brightness(1.3);
		}
		
		/* Triple+ effect combinations */
		.effect-color.effect-grayscale.effect-brightness {
			filter: hue-rotate(45deg) saturate(1.5) brightness(1.3);
		}
		
		.effect-color.effect-sepia.effect-brightness {
			filter: hue-rotate(45deg) saturate(1.5) sepia(70%) brightness(1.3);
		}
		
		.effect-grayscale.effect-sepia.effect-brightness {
			filter: sepia(70%) brightness(1.3);
		}

		[data-keep-color="true"],
		[data-keep-color="true"] *,
		[data-preserve-color="true"],
		[data-preserve-color="true"] * {
			filter: none !important;
		}
	</style>
</head>
<body class="db-loading">
	<div class="notification-center" id="notificationCenter" aria-live="polite" aria-atomic="true"></div>
	<!-- Simple loading screen -->
	<div class="loading-overlay" id="loadingOverlay">
		<div class="loading-spinner"></div>
	</div>

	<div id="pageEffectsRoot" class="page-effects-root">
	<div class="page-logo">
		<img id="pageLogoImg" src="https://ilyambr.me/Screenshot_2025-02-06_010238_edited_edited.png" alt="Logo" />
	</div>
	
	<ul class="social-bar" aria-label="Social Bar">
		<li><a id="twitchSocialLink" href="https://www.twitch.tv/ilyambrr" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="Twitch">
			<img alt="Twitch" src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="youtubeSocialLink" href="https://www.youtube.com/@ilyambr" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="Youtube">
			<img alt="Youtube" src="https://static.wixstatic.com/media/11062b_30de4e7217e64dfdadc3ea03beea7b94~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_30de4e7217e64dfdadc3ea03beea7b94~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="tiktokSocialLink" href="https://www.tiktok.com/@ilyambr_" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="TikTok">
			<img alt="TikTok" src="https://static.wixstatic.com/media/11062b_7fc95bac711041dcb9691b6a09192a84~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_7fc95bac711041dcb9691b6a09192a84~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="discordSocialLink" href="https://discord.gg/EK4nvAJPzc" target="_blank" rel="noreferrer noopener" class="social-link discord-social-link" aria-label="Discord">
			<img alt="Discord" src="https://static.wixstatic.com/media/11062b_f642c87820384bd6b2a7c95d10b73a22~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_f642c87820384bd6b2a7c95d10b73a22~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="instagramSocialLink" href="https://www.instagram.com/ilyambr_/" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="Instagram">
			<img alt="Instagram" src="https://static.wixstatic.com/media/11062b_ca1d837ce7194421b781ee7384061a8e~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_ca1d837ce7194421b781ee7384061a8e~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="xSocialLink" href="https://x.com/ilyambrr" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="X">
			<img alt="X" src="https://static.wixstatic.com/media/11062b_bc7125385fcf422cad29fbe20a2b237c~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_bc7125385fcf422cad29fbe20a2b237c~mv2.png" style="filter: invert(100%);">
		</a></li>
		<li><a id="redditSocialLink" href="https://www.reddit.com/user/ilyambr/" target="_blank" rel="noreferrer noopener" class="social-link" aria-label="Reddit">
			<img alt="Reddit" src="https://static.wixstatic.com/media/11062b_1b825ed041384249b8d50464cf9de627~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_1b825ed041384249b8d50464cf9de627~mv2.png" style="filter: invert(100%);">
		</a></li>
	</ul>
	
	<div class="aurora" aria-hidden="true"></div>
	<div class="bg-glass" aria-hidden="true"></div>
	<div class="bg-tint hidden" id="bgTint" aria-hidden="true"></div>

	<div class="desktop-shell">
		<div class="container">
			<header class="header">
			<div class="avatar" aria-label="Avatar">
				<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Profile avatar" />
			</div>
			<div>
				<div class="title">
					<div class="name">&nbsp;</div>
					<div class="username">&nbsp;</div>
				</div>
				<div class="bio" id="bioText">&nbsp;</div>
				<div class="badges">
					<div class="badge twitch-status-badge" id="twitchStatusBadge" style="display: none;">Affiliate</div>
				</div>
				<div class="stats">
					<div class="stat" id="twitchFollowersStat">
						<img src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" alt="Twitch" style="filter: invert(100%);"/>
						&nbsp;
					</div>
					<div class="stat" id="youtubeSubscribersStat">
						<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" alt="YouTube" style="filter: invert(100%);"/>
						&nbsp;
					</div>
					<div class="stat" id="streamingYearStat">&nbsp;</div>
				</div>
			</div>
			<div class="actions">
				<a class="button" id="followButton" href="javascript:void(0)" onclick="openFollowPopup()">
					<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M12 21s-8-4.5-8-11a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 6.5-10 11-10 11z" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					Follow
				</a>
				<a class="button secondary" id="subscribeButton" href="javascript:void(0)" onclick="openSubscribePopup()">
					<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M4 12h16M12 4v16" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
					</svg>
					Subscribe
				</a>
			</div>
				</header>

				<div class="grid">
			<section class="card">
				<div class="stream-header">
					<h3>Recent Streams</h3>
					<div class="stream-switcher">
						<button class="stream-switch active" onclick="switchStream('twitch')">Twitch</button>
						<button class="stream-switch" onclick="switchStream('youtube')">YouTube</button>
					</div>
				</div>
				<div class="gallery">
					<div class="thumb" style="background:
						radial-gradient(140% 140% at 10% 0%, rgba(180,180,180,0.28), transparent 60%),
						radial-gradient(140% 140% at 90% 100%, rgba(100,100,100,0.24), transparent 60%),
						linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));">
						<div class="embed-container" data-keep-color="true">
							<iframe id="twitch-embed" class="embed-frame" src="" data-channel="" frameborder="0" allowfullscreen="true" scrolling="no" data-keep-color="true"></iframe>
							<iframe id="youtube-embed" class="embed-frame hidden" src="" frameborder="0" allowfullscreen data-keep-color="true"></iframe>
						</div>
					</div>
				</div>
			</section>

			<aside class="card">
				<h3>About</h3>
				<div class="about" id="aboutSection">
					<span id="aboutTextContent">&nbsp;</span>
					<a class="discord-link discord-about-link" href="https://ilyambr.me/discord" target="_blank" rel="noopener">
						<img src="https://www.svgrepo.com/show/353655/discord-icon.svg" alt="Discord"/>
						Discord
					</a>
					<a class="discord-link settings-link" href="javascript:void(0)" onclick="openGameSettingsPopup()" aria-label="Open all settings">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
							<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
							<circle cx="12" cy="12" r="3"/>
						</svg>
						All Settings
					</a>
				</div>
				<h3 style="margin-top:18px">Schedule</h3>
				<div class="schedule">
					<div class="slot">
						<span class="day" id="saturdaySchedule">&nbsp;</span>
						<span class="time" id="nextSaturday">&nbsp;</span>
					</div>
					<div class="slot">
						<span class="day" id="sundaySchedule">&nbsp;</span>
						<span class="time" id="nextSunday">&nbsp;</span>
					</div>
				</div>
			</aside>
			</div>
		</div>
		<aside class="short-video-panel" id="shortVideoPanel" aria-label="Featured short video">
				<div class="card short-video-card">
					<h3>Featured Short</h3>
					<div class="short-video-embed" data-keep-color="true">
						<div class="short-video-placeholder" id="shortVideoPlaceholder" data-keep-color="true">
							<strong>No short video yet</strong>
							<span>Paste a TikTok or YouTube Shorts link in the admin panel to showcase it here.</span>
						</div>
						<div id="shortVideoEmbed" data-keep-color="true"></div>
					</div>
				</div>
		</aside>
		<div class="footer">
			<div id="counter"></div>
			© 2025 ilyambr, made with love <3
		</div>
	</div>

		</div>

	<!-- Admin Console Button -->
	<div class="admin-button" role="button" aria-label="Open admin console" onclick="openAdminLogin()">
		<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
			<circle cx="12" cy="12" r="3"/>
		</svg>
	</div>

	<script>
		const pageEffectsRoot = document.getElementById('pageEffectsRoot') || document.body;
		window.pageEffectsRoot = pageEffectsRoot;
		const ABOUT_MAX_LENGTH = 100;

		const clampAboutText = (text = "") => {
			const trimmed = text.trim();
			return trimmed.length > ABOUT_MAX_LENGTH ? trimmed.slice(0, ABOUT_MAX_LENGTH) : trimmed;
		};

		// Twitch API Configuration
		const twitchConfig = {
			// Base64 encoded credentials for security
			clientId: 'dzZyeWFhYmVkbGNtejJzMDJrNjV2NG9iaHA1bDQ3', // Get from https://dev.twitch.tv/console/apps (Base64 encoded)
			clientSecret: 'eHRvOGZkdXAzNnhpa3JzeXo3cWtndGs4d2poZGJz', // Get from https://dev.twitch.tv/console/apps (Base64 encoded)
			username: 'ilyambrr'
		};

		// Counter script - using localStorage for persistence
		function updateCounter() {
			// Get current count from localStorage or start at a base number
			let count = localStorage.getItem('ilyambr-counter');
			if (!count) {
				// Start at a reasonable number since you had visitors before
				count = 1247; // You can adjust this starting number
			} else {
				count = parseInt(count) + 1;
			}
			
			// Save updated count
			localStorage.setItem('ilyambr-counter', count);
			
			// Convert to 5-digit string with leading zeros
			let countStr = count.toString();
			while (countStr.length < 5) {
				countStr = '0' + countStr;
			}
			
			console.log('Counter:', countStr);
			
			// Generate HTML with GIF images
			let html = '';
			countStr.split('').forEach(d => {
				html += '<img src="https://ilyambr.me/counter/' + d + '.gif" style="max-height: 120px;">';
			});
			
			document.getElementById('counter').innerHTML = html;
		}

		// Schedule calculation functions
		function getNextWeekdayDate(targetDay) {
			const today = new Date();
			const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
			
			let daysUntilTarget;
			
			if (targetDay === 6) { // Saturday
				daysUntilTarget = (6 - currentDay + 7) % 7;
				if (daysUntilTarget === 0) daysUntilTarget = 7; // If today is Saturday, get next Saturday
			} else if (targetDay === 0) { // Sunday
				daysUntilTarget = (7 - currentDay) % 7;
				if (daysUntilTarget === 0) daysUntilTarget = 7; // If today is Sunday, get next Sunday
			}
			
			const nextDate = new Date(today);
			nextDate.setDate(today.getDate() + daysUntilTarget);
			
			return nextDate;
		}

		function formatScheduleDate(date) {
			const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
							'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
			
			const month = months[date.getMonth()];
			const day = date.getDate();
			
			// Add ordinal suffix (st, nd, rd, th)
			let suffix = 'th';
			if (day % 10 === 1 && day !== 11) suffix = 'st';
			else if (day % 10 === 2 && day !== 12) suffix = 'nd';
			else if (day % 10 === 3 && day !== 13) suffix = 'rd';
			
			return `${month} ${day}${suffix}`;
		}

		function updateScheduleDates() {
			const nextSaturday = getNextWeekdayDate(6); // 6 = Saturday
			const nextSunday = getNextWeekdayDate(0);   // 0 = Sunday
			
			document.getElementById('nextSaturday').textContent = formatScheduleDate(nextSaturday);
			document.getElementById('nextSunday').textContent = formatScheduleDate(nextSunday);
			
			console.log('📅 Schedule updated:', {
				saturday: formatScheduleDate(nextSaturday),
				sunday: formatScheduleDate(nextSunday)
			});
		}

		// Base64 utility functions
		function base64Encode(str) {
			return btoa(str);
		}

		function base64Decode(str) {
			try {
				return atob(str);
			} catch (e) {
				console.error('Base64 decode error:', e);
				return null;
			}

		}

		// Get decoded Twitch credentials
		function getTwitchCredentials() {
			const clientId = base64Decode(twitchConfig.clientId);
			const clientSecret = base64Decode(twitchConfig.clientSecret);
			
			if (!clientId || !clientSecret || 
				twitchConfig.clientId === 'YOUR_TWITCH_CLIENT_ID_BASE64' ||
				twitchConfig.clientSecret === 'YOUR_TWITCH_CLIENT_SECRET_BASE64') {
				return null;
			}
			
			return { clientId, clientSecret };
		}

		// Twitch API Access Token Management
		let twitchAccessToken = null;
		let twitchTokenExpiry = null;

		// Get Twitch App Access Token (Client Credentials Flow)
		async function getTwitchAccessToken() {
			try {
				// Check if we have a valid token
				if (twitchAccessToken && twitchTokenExpiry && Date.now() < twitchTokenExpiry) {
					return twitchAccessToken;
				}

				const credentials = getTwitchCredentials();
				if (!credentials) {
					throw new Error('Twitch credentials not configured or invalid');
				}

				console.log('🔄 Getting new Twitch access token...');
				
				const response = await fetch('https://id.twitch.tv/oauth2/token', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
					body: new URLSearchParams({
						client_id: credentials.clientId,
						client_secret: credentials.clientSecret,
						grant_type: 'client_credentials'
					})
				});

				if (!response.ok) {
					throw new Error(`Token request failed: ${response.status}`);
				}

				const data = await response.json();
				twitchAccessToken = data.access_token;
				twitchTokenExpiry = Date.now() + (data.expires_in * 1000) - 60000; // Refresh 1 minute early
				
				console.log('✅ Twitch access token obtained');
				return twitchAccessToken;
				
			} catch (error) {
				console.error('❌ Failed to get Twitch access token:', error);
				throw error;
			}
		}

		// Get User ID from username
		async function getTwitchUserId(username) {
			try {
				const credentials = getTwitchCredentials();
				if (!credentials) {
					throw new Error('Twitch credentials not configured');
				}

				const token = await getTwitchAccessToken();
				
				const response = await fetch(`https://api.twitch.tv/helix/users?login=${username}`, {
					headers: {
						'Authorization': `Bearer ${token}`,
						'Client-Id': credentials.clientId
					}
				});

				if (!response.ok) {
					throw new Error(`User lookup failed: ${response.status}`);
				}

				const data = await response.json();
				if (data.data && data.data.length > 0) {
					return data.data[0].id;
				} else {
					throw new Error('User not found');
				}
				
			} catch (error) {
				console.error('❌ Failed to get Twitch user ID:', error);
				throw error;
			}
		}

		let twitchFollowersRetryCount = 0;
		const TWITCH_FOLLOWERS_MAX_RETRIES = 5;

		// Official Twitch API followers function
		async function updateTwitchFollowers() {
			if (typeof loadGlobalSetting !== 'function') {
				if (twitchFollowersRetryCount < TWITCH_FOLLOWERS_MAX_RETRIES) {
					twitchFollowersRetryCount += 1;
					console.warn('⏳ Global settings helpers not ready, retrying Twitch followers... (#' + twitchFollowersRetryCount + ')');
					setTimeout(updateTwitchFollowers, 300 * twitchFollowersRetryCount);
				} else {
					console.error('❌ loadGlobalSetting unavailable after retries, using fallback for Twitch followers');
					updateTwitchFollowersFallback();
				}
				return;
			}

			twitchFollowersRetryCount = 0;
			try {
				// Check if we have valid Twitch credentials
				const credentials = getTwitchCredentials();
				if (!credentials) {
					console.warn('⚠️ Twitch API credentials not configured');
					updateTwitchFollowersFallback();
					return;
				}

				// Get the saved username from settings, fallback to default
				const savedUsername = await loadGlobalSetting('username');
				const savedChannel = await loadGlobalSetting('twitchChannel');
				let usernameForAPI = sanitizeTwitchChannel(savedChannel);
				
				if (!usernameForAPI && savedUsername && savedUsername !== 'N/A') {
					// Clean the username (remove @ if present)
					usernameForAPI = savedUsername.replace('@', '').toLowerCase();
				}
				
				if (!usernameForAPI) {
					usernameForAPI = twitchConfig.username; // default fallback
				}

				console.log('🔄 Fetching Twitch followers using official API...');
				console.log('👤 Username:', usernameForAPI);
				
				// Get user ID first
				const userId = await getTwitchUserId(usernameForAPI);
				console.log('👤 Twitch User ID:', userId);
				
				// Get follower count
				const token = await getTwitchAccessToken();
				console.log('🔑 Got access token:', token ? 'Yes' : 'No');
				
				const response = await fetch(`https://api.twitch.tv/helix/channels/followers?broadcaster_id=${userId}`, {
					headers: {
						'Authorization': `Bearer ${token}`,
						'Client-Id': credentials.clientId
					}
				});

				console.log('📡 Followers API response status:', response.status);

				if (!response.ok) {
					const errorText = await response.text();
					console.error('❌ Followers API error response:', errorText);
					throw new Error(`Followers request failed: ${response.status} - ${errorText}`);
				}

				const data = await response.json();
				console.log('📊 Followers API data:', data);
				
				const followers = data.total || 0;
				const formattedFollowers = formatNumber(followers);
				
				console.log('📈 Raw followers:', followers);
				console.log('📈 Formatted followers:', formattedFollowers);
				
				// Update the followers display
				const followersElement = document.querySelector('.stat img[alt="Twitch"]').parentElement;
				if (followersElement) {
					followersElement.innerHTML = `
						<img src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" alt="Twitch" style="filter: invert(100%);"/>
						${formattedFollowers} followers
					`;
					console.log('✅ Updated Twitch followers display:', formattedFollowers);
				} else {
							const email = (input.value || '').trim().toLowerCase();
					console.error('❌ Could not find Twitch followers element');
				}
				
			} catch (error) {
				console.error('❌ Twitch API error:', error);
				updateTwitchFollowersFallback();
			}
		}
		
		function updateTwitchFollowersFallback() {
			console.log('🔄 Using fallback for Twitch followers');
			const followersElement = document.querySelector('.stat img[alt="Twitch"]').parentElement;
			followersElement.innerHTML = `
				<img src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" alt="Twitch" style="filter: invert(100%);"/>
				N/A followers
			`;
		}

		// Simple obfuscation helpers (not real security, just makes it less obvious)
		function decode(encoded) {
			return atob(encoded.split('').reverse().join(''));
		}

		// YouTube subscribers API function using Google's YouTube Data API v3
		function updateYouTubeSubscribers() {
			// Obfuscated API key - replace with your encoded key
			const obfuscatedApiKey = 'Jh1UYtWS4gzcTpHZHRDWMJjUIhzVmVmQPJle5MEZnhmQ5NVY6lUQ';
			const apiKey = decode(obfuscatedApiKey);
			const channelId = 'UCIT9_QQpyUP2zg_39sLFb8Q';
			
			fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${apiKey}`)
				.then(response => {
					console.log('YouTube API response:', response);
					return response.json();
				})
				.then(data => {
					console.log('YouTube data:', data);
					if (data && data.items && data.items.length > 0) {
						const subscribers = data.items[0].statistics.subscriberCount;
						const formattedSubs = formatNumber(subscribers);
						// Update the subscribers display
						const subsElement = document.querySelector('.stat img[alt="YouTube"]').parentElement;
						subsElement.innerHTML = `
							<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" alt="YouTube" style="filter: invert(100%);"/>
							${formattedSubs} subs
						`;
					}
				})
				.catch(error => {
					console.error('YouTube API error:', error);
					// Keep the current static value if API fails
				});
		}
		// Format number function (e.g., 58200 -> "58.2k")
		function formatNumber(num) {
			if (num >= 1000000) {
				return (num / 1000000).toFixed(1) + 'M';
			}
			if (num >= 1000) {
				return (num / 1000).toFixed(1) + 'k';
			}
			return num.toString();
		}

		const DEFAULT_PROFILE_PIC = 'https://ilyambr.me/img/avatar.webp';
		const twitchHost = (window.location.hostname || 'ilyambr.me').toLowerCase();
		const twitchIframe = document.getElementById('twitch-embed');

		function setProfilePreviewImage(src) {
			const preview = document.getElementById('profilePicturePreview');
			if (!preview) return;
			const effectiveSrc = (src && src !== 'N/A') ? src : DEFAULT_PROFILE_PIC;
			if (effectiveSrc) {
				preview.style.backgroundImage = `url('${effectiveSrc}')`;
				preview.classList.remove('empty');
			} else {
				preview.style.backgroundImage = '';
				preview.classList.add('empty');
			}
		}

		function sanitizeTwitchChannel(channel) {
			if (!channel) return '';
			let clean = String(channel).trim();
			clean = clean.replace(/^https?:\/\/(www\.)?twitch\.tv\//i, '');
			clean = clean.replace(/^@/, '');
			clean = clean.split(/[/?#]/)[0];
			return clean.toLowerCase();
		}

		function applyTwitchChannel(channel) {
			if (!twitchIframe) return;
			const fallback = sanitizeTwitchChannel(twitchIframe?.dataset?.channel) || 'ilyambrr';
			const finalChannel = sanitizeTwitchChannel(channel) || fallback;
			twitchIframe.dataset.channel = finalChannel;
			twitchIframe.src = `https://player.twitch.tv/?channel=${encodeURIComponent(finalChannel)}&parent=${twitchHost}`;
		}

		function formatHandle(value, fallback = '@ilyambrr') {
			const base = (value && value !== 'N/A') ? String(value).trim() : fallback;
			if (!base) return fallback;
			return base.startsWith('@') ? base : `@${base}`;
		}

		function parseShortVideoLink(rawLink) {
			if (!rawLink) return null;
			const trimmed = String(rawLink).trim();
			if (!trimmed) return null;
			let url;
			try {
				url = new URL(trimmed);
			} catch (e) {
				// Allow passing a bare YouTube ID
				if (/^[A-Za-z0-9_-]{8,15}$/.test(trimmed)) {
					return {
						provider: 'youtube',
						id: trimmed,
						embedUrl: `https://www.youtube-nocookie.com/embed/${trimmed}`,
						originalUrl: `https://www.youtube.com/watch?v=${trimmed}`
					};
				}
				return null;
			}

			const host = url.hostname.replace(/^www\./, '').toLowerCase();
			let config = null;

			if (host === 'youtu.be' || host.endsWith('youtube.com')) {
				let videoId = url.searchParams.get('v') || '';
				if (!videoId) {
					const path = url.pathname.replace(/^\//, '');
					const segments = path.split('/');
					if (host === 'youtu.be' && segments[0]) {
						videoId = segments[0];
					} else if (segments[0] === 'shorts' && segments[1]) {
						videoId = segments[1];
					} else if (segments[0] === 'embed' && segments[1]) {
						videoId = segments[1];
					}
				}
				if (videoId && /^[A-Za-z0-9_-]{8,15}$/.test(videoId)) {
					config = {
						provider: 'youtube',
						id: videoId,
						embedUrl: `https://www.youtube.com/embed/${videoId}`,
						originalUrl: trimmed
					};
				}
			} else if (host.endsWith('tiktok.com')) {
				const pathParts = url.pathname.split('/').filter(Boolean);
				let videoId = '';
				let handlePart = pathParts.find(p => p.startsWith('@')) || '';
				const videoIndex = pathParts.indexOf('video');
				if (videoIndex !== -1 && pathParts[videoIndex + 1]) {
					videoId = pathParts[videoIndex + 1].split(/[?&#]/)[0];
				}
				if (!videoId && pathParts.length >= 2) {
					const potentialId = pathParts[pathParts.length - 1].split(/[?&#]/)[0];
					if (/^\d+$/.test(potentialId)) {
						videoId = potentialId;
					}
				}
				if (videoId) {
					const handle = handlePart ? handlePart.replace('@', '') : '';
					const canonicalHandle = handle ? `@${handle}` : handlePart || '';
					const canonicalUrl = canonicalHandle ? `https://www.tiktok.com/${canonicalHandle}/video/${videoId}` : trimmed;
					config = {
						provider: 'tiktok',
						id: videoId,
						embedUrl: canonicalUrl,
						originalUrl: trimmed,
						handle
					};
				}
			}

			return config;
		}

		function normalizeShortVideoConfig(raw) {
			if (!raw || raw === 'N/A') return null;
			if (typeof raw === 'object') {
				const obj = { ...raw };
				if (obj.provider === 'youtube' && obj.id && !obj.embedUrl) {
					obj.embedUrl = `https://www.youtube.com/embed/${obj.id}`;
				}
				if (obj.provider === 'tiktok' && obj.id && !obj.embedUrl) {
					obj.embedUrl = obj.originalUrl || `https://www.tiktok.com/${obj.handle ? '@' + obj.handle : ''}/video/${obj.id}`;
				}
				if (!obj.originalUrl && obj.embedUrl) {
					obj.originalUrl = obj.embedUrl;
				}
				return obj;
			}
			if (typeof raw === 'string') {
				try {
					const parsed = JSON.parse(raw);
					if (parsed && typeof parsed === 'object') return normalizeShortVideoConfig(parsed);
				} catch (e) {
					const parsedLink = parseShortVideoLink(raw);
					if (parsedLink) return parsedLink;
				}
			}
			return null;
		}

		function formatShortVideoLabel(config) {
			if (!config || !config.provider) return 'None';
			const providerLabel = config.provider.charAt(0).toUpperCase() + config.provider.slice(1);
			if (config.provider === 'youtube' && config.id) {
				return `${providerLabel} • ${config.id}`;
			}
			if (config.provider === 'tiktok') {
				return config.handle ? `${providerLabel} • @${config.handle}` : `${providerLabel}`;
			}
			return providerLabel;
		}

		function ensureTikTokEmbedScript() {
			if (!document.getElementById('tiktok-embed-script')) {
				const script = document.createElement('script');
				script.id = 'tiktok-embed-script';
				script.src = 'https://www.tiktok.com/embed.js';
				script.async = true;
				document.body.appendChild(script);
			}
		}

		function applyShortVideoEmbed(config) {
			const embedContainer = document.getElementById('shortVideoEmbed');
			const placeholder = document.getElementById('shortVideoPlaceholder');
			if (!embedContainer || !placeholder) return;

			embedContainer.innerHTML = '';
			if (!config || !config.provider || !config.id) {
				placeholder.style.display = 'flex';
				placeholder.setAttribute('aria-hidden', 'false');
				embedContainer.removeAttribute('data-provider');
				return;
			}

			placeholder.style.display = 'none';
			placeholder.setAttribute('aria-hidden', 'true');
			embedContainer.setAttribute('data-provider', config.provider);

			if (config.provider === 'youtube') {
				const embedUrl = config.embedUrl || `https://www.youtube.com/embed/${config.id}`;
				embedContainer.innerHTML = `
					<iframe class="short-video-frame" src="${embedUrl}" title="Featured short video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
				`;
			} else if (config.provider === 'tiktok') {
				const cite = config.embedUrl || config.originalUrl;
				embedContainer.innerHTML = `
					<blockquote class="tiktok-embed short-video-frame" cite="${cite}" data-video-id="${config.id}" data-embed-from="oembed" style="max-width: 360px; min-width: 260px;">
						<section></section>
					</blockquote>
				`;
				ensureTikTokEmbedScript();
				if (window.tiktokEmbedLoad) {
					window.tiktokEmbedLoad();
				} else {
					setTimeout(() => {
						if (window.tiktokEmbedLoad) window.tiktokEmbedLoad();
					}, 250);
				}
			}
		}

		// Run all functions on page load
		updateCounter();
		updateScheduleDates();
		updateTwitchFollowers();
		updateYouTubeSubscribers();
	</script>

	<script>
		function setBodyScrollState(lock) {
			const isMobile = window.matchMedia('(max-width: 1200px)').matches;
			if (lock) {
				document.body.style.overflow = 'hidden';
			} else {
				document.body.style.overflow = isMobile ? 'auto' : 'hidden';
			}
		}

		// Popup functionality
		function openPopup(popupId) {
			var popup = document.getElementById(popupId);
			if (popup) {
				popup.style.display = 'flex';
				setBodyScrollState(popupId !== 'colorsPopup');
			}
		}

		function closePopup(popupId) {
			var popup = document.getElementById(popupId);
			if (popup) {
				popup.style.display = 'none';
				setBodyScrollState(false);
			}
		}

		let allSettingsApps = [];
		let editingAllSettingsAppId = null;
		let pendingAllSettingsAppMedia = { banner: null, logo: null, character: null };
		let editingAppSettingsTabs = [];
		let activeEditingSettingsTabId = null;
		let appSettingsEditorHandlersBound = false;
		let allSettingsMediaHandlersBound = false;
		let allSettingsSpecialHandlersBound = false;
		const ALL_SETTINGS_SPECIAL_OPTIONS = [
			{ id: 'none', label: 'None' },
			{ id: 'character-trn', label: 'Character (TRN)' }
		];
		const ALL_SETTINGS_TRN_GAMES = [
			{ id: 'valorant', label: 'Valorant' }
		];
		const DEFAULT_TRN_GAME_ID = ALL_SETTINGS_TRN_GAMES[0].id;
		function normalizeTrnGameId(value) {
			const normalized = String(value || '').trim().toLowerCase();
			return ALL_SETTINGS_TRN_GAMES.some(game => game.id === normalized) ? normalized : DEFAULT_TRN_GAME_ID;
		}
		function getTrnGameLabel(gameId) {
			const match = ALL_SETTINGS_TRN_GAMES.find(game => game.id === gameId);
			return match ? match.label : (gameId || '').toUpperCase();
		}
		function populateTrnGameOptions() {
			const select = document.getElementById('allSettingsCharacterTrnGame');
			if (!select) return;
			const existingValues = new Set(Array.from(select.options).map(option => option.value));
			ALL_SETTINGS_TRN_GAMES.forEach(game => {
				if (!existingValues.has(game.id)) {
					const option = document.createElement('option');
					option.value = game.id;
					option.textContent = game.label;
					select.appendChild(option);
				} else {
					Array.from(select.options).forEach(option => {
						if (option.value === game.id) {
							option.textContent = game.label;
						}
					});
				}
			});
			if (!select.value) {
				select.value = DEFAULT_TRN_GAME_ID;
			}
		}
		function generateTrnProfileUrl(gameId, username) {
			const cleanUsername = (username || '').trim();
			if (!cleanUsername) return '';
			const normalizedGame = normalizeTrnGameId(gameId);
			const encodedUsername = encodeURIComponent(cleanUsername);
			return `https://tracker.gg/${normalizedGame}/profile/riot/${encodedUsername}?`;
		}
		function readFileAsDataURL(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result);
				reader.onerror = () => reject(new Error('file-read-failed'));
				reader.readAsDataURL(file);
			});
		}

		const DEFAULT_GAME_SETTINGS_TABS = [
			{ id: 'games', label: 'Games', type: 'default' },
			{ id: 'utility', label: 'Utility', type: 'default' },
			{ id: 'hardware', label: 'Hardware', type: 'default' },
			{ id: 'internet', label: 'Internet', type: 'default' }
		];
		const GAME_SETTINGS_TAB_IDS = DEFAULT_GAME_SETTINGS_TABS.map(tab => tab.id);
		let cachedGameSettingsTabs = [];
		let currentGameSettingsTabId = null;
		let selectedAllSettingsAppId = null;
		const TRACKER_STATS_ENDPOINT = '/data/ilyambr-ttb-tracker.json';
		const TRACKER_STATS_FALLBACK_ENDPOINT = '/data/example-tracker.json';
		let cachedTrackerStatsSnapshot = null;
		let trackerStatsFetchPromise = null;

		function normalizeTrackerUsername(username) {
			return (username || '').trim().toLowerCase();
		}

		async function fetchTrackerStatsSnapshot(force = false) {
			if (!force && cachedTrackerStatsSnapshot) {
				return cachedTrackerStatsSnapshot;
			}
			if (!force && trackerStatsFetchPromise) {
				return trackerStatsFetchPromise;
			}
			const loadSnapshot = async (endpoint) => {
				const response = await fetch(endpoint, { cache: 'no-store' });
				if (!response.ok) {
					throw new Error(`Tracker stats request failed: ${response.status}`);
				}
				return response.json();
			};
			trackerStatsFetchPromise = loadSnapshot(TRACKER_STATS_ENDPOINT)
				.catch(error => {
					console.warn('Primary tracker snapshot unavailable, trying fallback', {
						message: error?.message,
						status: error?.status || null
					});
					return loadSnapshot(TRACKER_STATS_FALLBACK_ENDPOINT);
				})
				.then(data => {
					cachedTrackerStatsSnapshot = data && typeof data === 'object' ? data : null;
					trackerStatsFetchPromise = null;
					return cachedTrackerStatsSnapshot;
				})
				.catch(error => {
					console.error('Failed to load tracker stats snapshot', error);
					trackerStatsFetchPromise = null;
					return null;
				});
			return trackerStatsFetchPromise;
		}

		function resolveTrackerStatsForApp(app) {
			if (!app) return null;
			const desired = normalizeTrackerUsername(app.characterTrnUsername);
			if (!desired) return null;
			const snapshot = cachedTrackerStatsSnapshot;
			if (!snapshot || !snapshot.username) return null;
			const available = normalizeTrackerUsername(snapshot.username);
			return desired === available ? snapshot : null;
		}

		function formatTrackerTimestamp(isoString) {
			if (!isoString) return '';
			try {
				const date = new Date(isoString);
				if (Number.isNaN(date.getTime())) return isoString;
				return date.toLocaleString();
			} catch (error) {
				return isoString;
			}
		}

		function enhanceCharacterPanelWithTrackerStats(panelEl, app) {
			if (!panelEl || !app) return;
			const desired = normalizeTrackerUsername(app.characterTrnUsername);
			if (!desired) return;
			fetchTrackerStatsSnapshot().then(snapshot => {
				if (!snapshot || normalizeTrackerUsername(snapshot.username) !== desired) return;
				const { stats, profileUrl, username } = snapshot;
				const playtime = stats?.timePlayed?.displayValue || null;
				const kdStat = stats?.kDRatio || stats?.kdRatio;
				const kd = kdStat?.displayValue || null;
				const playtimeEl = panelEl.querySelector('[data-role="tracker-playtime"]');
				if (playtimeEl && playtime) {
					playtimeEl.textContent = playtime;
				}
				const kdEl = panelEl.querySelector('[data-role="tracker-kdratio"]');
				if (kdEl && kd) {
					kdEl.textContent = kd;
				}
				const usernameEl = panelEl.querySelector('[data-role="tracker-username"]');
				if (usernameEl && username) {
					if (usernameEl.tagName === 'A') {
						usernameEl.textContent = username;
						if (profileUrl) {
							usernameEl.href = profileUrl;
						}
					} else {
						if (profileUrl) {
							usernameEl.innerHTML = '';
							if (usernameEl.dataset) {
								delete usernameEl.dataset.role;
							}
							const link = document.createElement('a');
							link.href = profileUrl;
							link.target = '_blank';
							link.rel = 'noopener noreferrer';
							link.dataset.role = 'tracker-username';
							link.textContent = username;
							usernameEl.appendChild(link);
						} else {
							usernameEl.textContent = username;
						}
					}
				}
			});
		}

		const DEFAULT_APP_SETTINGS_TABS = [
			{ id: 'general', label: 'General', hidden: false, sections: [] },
			{ id: 'other', label: 'Other', hidden: false, sections: [] },
			{ id: 'controls-actions', label: 'Controls > Actions', hidden: false, sections: [] },
			{ id: 'controls-equipment', label: 'Controls > Equipment', hidden: false, sections: [] },
			{ id: 'crosshair', label: 'Crosshair', hidden: false, sections: [] },
			{ id: 'video-general', label: 'Video > General', hidden: false, sections: [] },
			{ id: 'video-graphics', label: 'Video > Graphics Quality', hidden: false, sections: [] }
		];

		const SETTINGS_SECTION_TEMPLATES = [
			{
				id: 'blank',
				label: 'Blank section',
				build: () => ({
					id: generateSettingsSectionId(),
					title: 'New Section',
					items: []
				})
			},
			{
				id: 'basic-pairs',
				label: 'Value pairs (label + value)',
				build: () => ({
					id: generateSettingsSectionId(),
					title: 'New Section',
					items: [
						{ id: generateSettingsItemId(), label: 'Setting name', value: 'Value' }
					]
				})
			}
		];

		function generateSettingsTabId(label = 'tab') {
			const slug = String(label || 'tab').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || 'tab';
			return `tab-${slug}-${Math.random().toString(36).slice(2, 6)}${Date.now().toString(36).slice(-3)}`;
		}

		function generateSettingsSectionId() {
			return `section-${Math.random().toString(36).slice(2, 8)}${Date.now().toString(36).slice(-4)}`;
		}

		function generateSettingsItemId() {
			return `item-${Math.random().toString(36).slice(2, 8)}${Date.now().toString(36).slice(-4)}`;
		}

		function cloneDefaultAppSettingsTabs() {
			return DEFAULT_APP_SETTINGS_TABS.map(tab => ({
				id: tab.id,
				label: tab.label,
				hidden: !!tab.hidden,
				sections: []
			}));
		}

		function cloneAppSettingsTabs(tabs) {
			return normalizeAppSettingsTabs(tabs || []).map(tab => ({
				id: tab.id,
				label: tab.label,
				hidden: !!tab.hidden,
				sections: (tab.sections || []).map(section => ({
					id: section.id || generateSettingsSectionId(),
					title: section.title || 'Untitled Section',
					items: (section.items || []).map(item => ({
						id: item.id || generateSettingsItemId(),
						label: item.label || '',
						value: item.value || ''
					}))
				}))
			}));
		}

		function normalizeAppSettingsTabs(rawTabs, legacyTemplate = []) {
			const ensureItems = (items) => {
				if (!Array.isArray(items)) return [];
				return items.map(item => ({
					id: item?.id || generateSettingsItemId(),
					label: (item?.label || '').trim(),
					value: (item?.value || '').trim()
				}));
			};
			const ensureSections = (sections) => {
				if (!Array.isArray(sections)) return [];
				return sections.map(section => ({
					id: section?.id || generateSettingsSectionId(),
					title: (section?.title || '').trim() || 'Untitled Section',
					items: ensureItems(section?.items)
				}));
			};
			const fallbackFromLegacy = () => {
				if (!Array.isArray(legacyTemplate) || !legacyTemplate.length) {
					return cloneDefaultAppSettingsTabs();
				}
				const tabClone = cloneDefaultAppSettingsTabs();
				tabClone[0].sections = ensureSections(legacyTemplate);
				return tabClone;
			};
			const source = Array.isArray(rawTabs) && rawTabs.length ? rawTabs : fallbackFromLegacy();
			const normalized = [];
			const seen = new Set();
			source.forEach(tab => {
				const id = (tab?.id || '').trim() || generateSettingsTabId(tab?.label);
				if (seen.has(id)) return;
				seen.add(id);
				normalized.push({
					id,
					label: (tab?.label || '').trim() || 'Untitled Tab',
					hidden: !!tab?.hidden,
					sections: ensureSections(tab?.sections)
				});
			});
			if (!normalized.length) {
				return cloneDefaultAppSettingsTabs();
			}
			return normalized;
		}

		function flattenSettingsTabsToTemplate(tabs) {
			const normalized = normalizeAppSettingsTabs(tabs || []);
			const template = [];
			normalized.forEach(tab => {
				tab.sections.forEach(section => {
					const items = section.items
						.filter(item => item.label || item.value)
						.map(item => ({ label: item.label, value: item.value }));
					if (!items.length) return;
					template.push({
						title: `${tab.label} • ${section.title}`,
						items
					});
				});
			});
			return template;
		}

		function normalizeUrlForCss(url) {
			if (!url) return '';
			try {
				const trimmed = url.trim();
				if (trimmed.startsWith('data:')) {
					return `url("${trimmed}")`;
				}
				const encoded = encodeURI(trimmed);
				return `url("${encoded}")`;
			} catch (e) {
				return `url("${url}")`;
			}
		}

		function applyBackgroundImage(el, url) {
			if (!el) return;
			if (url) {
				el.style.backgroundImage = normalizeUrlForCss(url);
			} else {
				el.style.backgroundImage = '';
			}
		}

		function getAllSettingsTabs() {
			return DEFAULT_GAME_SETTINGS_TABS.slice();
		}

		function resolveGameSettingsTabId(tabId) {
			if (!tabId) return DEFAULT_GAME_SETTINGS_TABS[0].id;
			const normalized = String(tabId).trim().toLowerCase();
			return GAME_SETTINGS_TAB_IDS.includes(normalized) ? normalized : DEFAULT_GAME_SETTINGS_TABS[0].id;
		}

		function getGameSettingsTabLabel(tabId) {
			const canonical = resolveGameSettingsTabId(tabId);
			const match = DEFAULT_GAME_SETTINGS_TABS.find(tab => tab.id === canonical);
			return match ? match.label : tabId;
		}

		function renderGameSettingsTabs(preferredId) {
			const tabsContainer = document.getElementById('gameSettingsTabs');
			if (!tabsContainer) return;

			cachedGameSettingsTabs = getAllSettingsTabs();
			tabsContainer.innerHTML = '';

			cachedGameSettingsTabs.forEach(tab => {
				const button = document.createElement('button');
				button.type = 'button';
				button.className = 'settings-tab';
				button.dataset.section = tab.id;
				button.textContent = tab.label;
				button.addEventListener('click', () => selectGameSettingsTab(tab.id));
				tabsContainer.appendChild(button);
			});

			let initialId = preferredId || currentGameSettingsTabId;
			if (!initialId) {
				initialId = cachedGameSettingsTabs[0]?.id || null;
			} else {
				initialId = resolveGameSettingsTabId(initialId);
			}

			if (initialId) {
				selectGameSettingsTab(initialId);
			} else {
				const content = document.getElementById('gameSettingsContent');
				if (content) {
					content.innerHTML = '';
					content.classList.remove('has-banner', 'list-mode');
				}
			}
		}

		function selectSettingsApp(appId) {
			if (!appId) return;
			const app = (allSettingsApps || []).find(item => item.id === appId);
			if (!app) return;
			selectedAllSettingsAppId = appId;
			setGameSettingsContent(currentGameSettingsTabId);
			openSettingsAppDetailPopup(app);
		}

		function buildSettingsDetail(app) {
			const tabs = normalizeAppSettingsTabs(app?.settingsTabs, app?.settingsTemplate);
			const visibleTabs = tabs.filter(tab => !tab.hidden);
			let activeTabId = visibleTabs[0]?.id || tabs[0]?.id || null;

			const container = document.createElement('section');
			container.className = 'settings-app-template';
			container.dataset.keepColor = 'true';
			container.dataset.appId = app.id;

			const hero = document.createElement('div');
			hero.className = 'settings-template-hero';
			hero.dataset.keepColor = 'true';
			applyBackgroundImage(hero, app.banner);

			const heroOverlay = document.createElement('div');
			heroOverlay.className = 'settings-template-hero-overlay';
			heroOverlay.dataset.keepColor = 'true';

			if (app.logo) {
				const logo = document.createElement('img');
				logo.src = app.logo;
				logo.alt = `${app.name} logo`;
				logo.dataset.keepColor = 'true';
				heroOverlay.appendChild(logo);
			} else {
				const fallback = document.createElement('div');
				fallback.className = 'settings-template-logo-fallback';
				fallback.textContent = (app.name || 'App').charAt(0).toUpperCase();
				fallback.dataset.keepColor = 'true';
				heroOverlay.appendChild(fallback);
			}

			const title = document.createElement('h4');
			title.textContent = app.name || 'Untitled App';
			heroOverlay.appendChild(title);

			const badge = document.createElement('span');
			badge.className = 'settings-template-badge';
			badge.textContent = getGameSettingsTabLabel(resolveGameSettingsTabId(app.tabId));
			heroOverlay.appendChild(badge);

			hero.appendChild(heroOverlay);
			container.appendChild(hero);

			const templateBody = document.createElement('div');
			templateBody.className = 'settings-template-body';
			templateBody.dataset.keepColor = 'true';

			const tabBar = document.createElement('div');
			tabBar.className = 'app-settings-tab-bar';
			tabBar.dataset.keepColor = 'true';
			templateBody.appendChild(tabBar);

			const sectionsWrap = document.createElement('div');
			sectionsWrap.className = 'settings-template-sections';
			sectionsWrap.dataset.keepColor = 'true';
			templateBody.appendChild(sectionsWrap);

			container.appendChild(templateBody);

			const tabButtons = new Map();

			const renderEmptyState = (message) => {
				sectionsWrap.innerHTML = '';
				const placeholder = document.createElement('p');
				placeholder.className = 'settings-template-placeholder';
				placeholder.textContent = message;
				sectionsWrap.appendChild(placeholder);
			};

			const renderTabContent = (tabId) => {
				sectionsWrap.innerHTML = '';
				const tab = tabs.find(item => item.id === tabId) || tabs[0] || null;
				if (!tab) {
					renderEmptyState('No settings configured yet.');
					return;
				}
				if (!tab.sections.length) {
					renderEmptyState('No sections added for this tab yet.');
					return;
				}
				tab.sections.forEach(section => {
					const sectionEl = document.createElement('section');
					sectionEl.className = 'settings-template-section';

					const heading = document.createElement('h5');
					heading.textContent = section.title || 'Untitled Section';
					sectionEl.appendChild(heading);

					const grid = document.createElement('dl');
					grid.className = 'settings-template-grid';

					const items = Array.isArray(section.items) ? section.items : [];
					if (!items.length) {
						const emptyRow = document.createElement('div');
						emptyRow.className = 'settings-template-row';
						emptyRow.innerHTML = '<dt>Details</dt><dd>Not provided yet.</dd>';
						grid.appendChild(emptyRow);
					} else {
						items.forEach(item => {
							const row = document.createElement('div');
							row.className = 'settings-template-row';

							const term = document.createElement('dt');
							term.textContent = item.label || 'Setting';

							const value = document.createElement('dd');
							value.textContent = item.value || '—';

							row.appendChild(term);
							row.appendChild(value);
							grid.appendChild(row);
						});
					}

					sectionEl.appendChild(grid);
					sectionsWrap.appendChild(sectionEl);
				});
			};

			if (!visibleTabs.length) {
				tabBar.classList.add('empty');
				renderEmptyState('All tabs are hidden. Update settings to display content.');
			} else {
				if (!visibleTabs.some(tab => tab.id === activeTabId)) {
					activeTabId = visibleTabs[0]?.id || null;
				}
				visibleTabs.forEach((tab, index) => {
					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'app-settings-tab';
					button.dataset.tabId = tab.id;
					button.textContent = tab.label || 'Untitled Tab';
					if (index === 0 && !activeTabId) {
						activeTabId = tab.id;
					}
					if (tab.id === activeTabId) {
						button.classList.add('active');
					}
					button.addEventListener('click', () => {
						activeTabId = tab.id;
						tabButtons.forEach(btn => btn.classList.toggle('active', btn === button));
						renderTabContent(tab.id);
					});
					tabButtons.set(tab.id, button);
					tabBar.appendChild(button);
				});
				renderTabContent(activeTabId);
			}

			const detailCard = document.createElement('div');
			detailCard.className = 'settings-app-detail';
			detailCard.dataset.keepColor = 'true';
			detailCard.dataset.appId = app.id;
			detailCard.appendChild(container);
			const specialOption = normalizeAllSettingsSpecialOption(app?.specialOption);
			let characterPanel = null;
			if (specialOption === 'character-trn') {
				characterPanel = document.createElement('aside');
				characterPanel.className = 'character-trn-panel';
				characterPanel.dataset.appId = `${app.id}-character`;
				characterPanel.dataset.keepColor = 'true';
				if (app.characterImage) {
					applyBackgroundImage(characterPanel, app.characterImage);
				} else {
					characterPanel.classList.add('empty');
				}
				const content = document.createElement('div');
				content.className = 'character-trn-content';
				const characterName = document.createElement('h4');
				characterName.className = 'character-trn-name';
				const displayName = app.characterName || app.characterTrnUsername || 'Tracker Profile';
				const trackerSnapshot = resolveTrackerStatsForApp(app);
				const trackerProfileUrl = trackerSnapshot?.profileUrl || app.characterTrnProfileUrl || null;
				characterName.textContent = displayName;
				content.appendChild(characterName);
				const meta = document.createElement('div');
				meta.className = 'character-trn-meta';
				const trackerStats = trackerSnapshot?.stats || null;
				const trackerUsername = trackerSnapshot?.username || app.characterTrnUsername || null;
				const statItems = [];
				const playtimeDisplay = trackerStats?.timePlayed?.displayValue || app.characterTrnPlaytime || '—';
				statItems.push({ label: 'Playtime', value: playtimeDisplay, domRole: 'tracker-playtime' });
				const kdDisplay = trackerStats?.kDRatio?.displayValue || trackerStats?.kdRatio?.displayValue || app.characterTrnKd || '—';
				statItems.push({ label: 'K/D Ratio', value: kdDisplay, domRole: 'tracker-kdratio' });
				const usernameDisplay = trackerUsername || '—';
				const usernameHref = trackerProfileUrl && usernameDisplay !== '—' ? trackerProfileUrl : null;
				statItems.push({ label: 'Username', value: usernameDisplay, domRole: 'tracker-username', href: usernameHref });
				statItems.forEach(stat => {
					const item = document.createElement('div');
					item.className = 'character-trn-meta-item';
					const statLabel = document.createElement('span');
					statLabel.className = 'character-trn-meta-label';
					statLabel.textContent = stat.label;
					const statValue = document.createElement('span');
					statValue.className = 'character-trn-meta-value';
					if (stat.href) {
						const link = document.createElement('a');
						link.target = '_blank';
						link.rel = 'noopener noreferrer';
						link.href = stat.href;
						link.textContent = stat.value;
						if (stat.domRole) {
							link.dataset.role = stat.domRole;
						}
						statValue.appendChild(link);
					} else {
						statValue.textContent = stat.value;
						if (stat.domRole) {
							statValue.dataset.role = stat.domRole;
						}
					}
					item.appendChild(statLabel);
					item.appendChild(statValue);
					meta.appendChild(item);
				});
				content.appendChild(meta);
				characterPanel.appendChild(content);
				enhanceCharacterPanelWithTrackerStats(characterPanel, app);
			}
			return { main: detailCard, side: characterPanel };
		}

		function openSettingsAppDetailPopup(app) {
			if (!app) return;
			const popup = document.getElementById('settingsAppDetailPopup');
			const body = document.getElementById('settingsAppDetailBody');
			const characterPanel = document.getElementById('settingsCharacterDetailPanel');
			const characterBody = document.getElementById('settingsCharacterDetailBody');
			const title = document.getElementById('settingsAppDetailTitle');
			const category = document.getElementById('settingsAppDetailCategory');
			if (!popup || !body) return;

			body.innerHTML = '';
			if (characterBody) {
				characterBody.innerHTML = '';
			}
			const detailContent = buildSettingsDetail(app);
			if (detailContent.main) {
				body.appendChild(detailContent.main);
			}
			const hasCharacter = !!detailContent.side;
			if (characterPanel) {
				if (hasCharacter && characterBody) {
					characterPanel.style.display = '';
					characterPanel.removeAttribute('aria-hidden');
					characterBody.appendChild(detailContent.side);
				} else {
					characterPanel.setAttribute('aria-hidden', 'true');
					characterPanel.style.display = 'none';
				}
			}
			popup.classList.toggle('has-character', hasCharacter);

			if (title) {
				title.textContent = app.name || 'App Settings';
			}
			if (category) {
				category.textContent = getGameSettingsTabLabel(resolveGameSettingsTabId(app.tabId));
			}

			popup.style.display = 'flex';
			setBodyScrollState(true);
		}

		function closeSettingsAppDetailPopup(preserveScrollLock = false) {
			const popup = document.getElementById('settingsAppDetailPopup');
			const body = document.getElementById('settingsAppDetailBody');
			const characterPanel = document.getElementById('settingsCharacterDetailPanel');
			const characterBody = document.getElementById('settingsCharacterDetailBody');
			const title = document.getElementById('settingsAppDetailTitle');
			const category = document.getElementById('settingsAppDetailCategory');
			if (!popup) return;

			popup.style.display = 'none';
			if (body) {
				body.innerHTML = '';
			}
			if (characterBody) {
				characterBody.innerHTML = '';
			}
			if (characterPanel) {
				characterPanel.setAttribute('aria-hidden', 'true');
				characterPanel.style.display = 'none';
			}
			popup.classList.remove('has-character');
			if (title) {
				title.textContent = 'App Settings';
			}
			if (category) {
				category.textContent = '\u00A0';
			}

			if (preserveScrollLock) {
				return;
			}
			const mainPopup = document.getElementById('gameSettingsPopup');
			if (mainPopup && mainPopup.style.display === 'flex') {
				setBodyScrollState(true);
			} else {
				setBodyScrollState(false);
			}
		}

		function buildTabAppDisplay(app, isActive = false) {
			const display = document.createElement('article');
			display.className = 'settings-app-display';
			display.dataset.keepColor = 'true';
			display.dataset.appId = app.id;
			display.tabIndex = 0;
			display.setAttribute('role', 'button');
			display.setAttribute('aria-pressed', isActive ? 'true' : 'false');
			display.setAttribute('aria-label', `View ${app.name || 'app'} settings`);
			if (isActive) {
				display.classList.add('selected');
			}
			applyBackgroundImage(display, app.banner);
			const overlay = document.createElement('div');
			overlay.className = 'app-card-overlay static';
			overlay.dataset.keepColor = 'true';
			if (app.logo) {
				const logo = document.createElement('img');
				logo.src = app.logo;
				logo.alt = `${app.name} logo`;
				logo.dataset.keepColor = 'true';
				overlay.appendChild(logo);
			}
			const nameEl = document.createElement('div');
			nameEl.className = 'app-card-name';
			nameEl.textContent = app.name || 'Untitled App';
			overlay.appendChild(nameEl);
			display.appendChild(overlay);
			return display;
		}


		function selectGameSettingsTab(tabId) {
			const tabsContainer = document.getElementById('gameSettingsTabs');
			if (!tabsContainer) return;
			const canonicalId = resolveGameSettingsTabId(tabId);
			const buttons = tabsContainer.querySelectorAll('.settings-tab');
			buttons.forEach(btn => {
				btn.classList.toggle('active', btn.dataset.section === canonicalId);
			});
			currentGameSettingsTabId = canonicalId;
			selectedAllSettingsAppId = null;
			setGameSettingsContent(canonicalId);
		}

		function setGameSettingsContent(tabId) {
			const content = document.getElementById('gameSettingsContent');
			if (!content) return;
			const canonicalId = resolveGameSettingsTabId(tabId);
			const tabData = cachedGameSettingsTabs.find(tab => tab.id === canonicalId);
			content.classList.remove('has-banner', 'list-mode', 'detail-mode', 'grid-mode');
			content.innerHTML = '';
			content.scrollTop = 0;
			if (!tabData) {
				return;
			}
			const appsForTab = (allSettingsApps || [])
				.filter(app => resolveGameSettingsTabId(app.tabId) === canonicalId)
				.sort((a, b) => (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' }));
			if (!appsForTab.length) {
				selectedAllSettingsAppId = null;
				const wrap = document.createElement('div');
				wrap.style.display = 'flex';
				wrap.style.flexDirection = 'column';
				wrap.style.alignItems = 'center';
				wrap.style.gap = '14px';
				const message = document.createElement('div');
				message.className = 'settings-placeholder';
				message.innerHTML = `No apps in <strong>${getGameSettingsTabLabel(canonicalId)}</strong> yet.`;
				wrap.appendChild(message);
				content.appendChild(wrap);
				return;
			}
			content.classList.add('grid-mode');
			const hint = document.createElement('p');
			hint.className = 'settings-grid-hint';
			hint.textContent = 'Select a card to open detailed settings.';
			content.appendChild(hint);
			const grid = document.createElement('div');
			grid.className = 'settings-app-list';
			grid.dataset.keepColor = 'true';
			appsForTab.forEach(app => {
				const tile = buildTabAppDisplay(app, app.id === selectedAllSettingsAppId);
				tile.addEventListener('click', () => selectSettingsApp(app.id));
				tile.addEventListener('keydown', event => {
					if (event.key === 'Enter' || event.key === ' ') {
						event.preventDefault();
						selectSettingsApp(app.id);
					}
				});
				grid.appendChild(tile);
			});
			content.appendChild(grid);
		}

		function initGameSettingsTabs(preferredId) {
			renderGameSettingsTabs(preferredId);
		}

		function openGameSettingsPopup(targetTabId = null) {
			initGameSettingsTabs(targetTabId);
			closeSettingsAppDetailPopup(true);
			const popup = document.getElementById('gameSettingsPopup');
			if (popup) {
				popup.style.display = 'flex';
				setBodyScrollState(true);
			}
		}

		function normalizeAllSettingsApp(raw) {
			if (!raw) return null;
			const sanitizeMedia = (value) => {
				if (!value || value === 'N/A') return '';
				return String(value).trim();
			};
			const normalizedTabs = normalizeAppSettingsTabs(raw?.settingsTabs, raw?.settingsTemplate);
			const normalized = {
				id: String(raw.id || '').trim(),
				name: (raw.name || '').trim(),
				logo: sanitizeMedia(raw.logo),
				banner: sanitizeMedia(raw.banner),
				tabId: resolveGameSettingsTabId(raw.tabId),
				settingsTabs: normalizedTabs,
				settingsTemplate: flattenSettingsTabsToTemplate(normalizedTabs),
				specialOption: normalizeAllSettingsSpecialOption(raw.specialOption),
				characterImage: sanitizeMedia(raw.characterImage),
				characterName: (raw.characterName || '').trim(),
				characterTrnUsername: (raw.characterTrnUsername || '').trim(),
				characterTrnGame: normalizeTrnGameId(raw.characterTrnGame),
				characterTrnProfileUrl: '',
				createdAt: raw.createdAt || Date.now(),
				updatedAt: raw.updatedAt || raw.createdAt || Date.now()
			};
			if (!normalized.id) {
				const base = normalized.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
				const unique = normalized.createdAt ? normalized.createdAt.toString(36) : Date.now().toString(36);
				normalized.id = `${base || 'app'}-${unique}`;
			}
			if (!normalized.name) {
				normalized.name = 'Untitled App';
			}
			if (normalized.specialOption !== 'character-trn') {
				normalized.characterImage = '';
				normalized.characterName = '';
				normalized.characterTrnUsername = '';
				normalized.characterTrnGame = DEFAULT_TRN_GAME_ID;
				normalized.characterTrnProfileUrl = '';
			} else {
				normalized.characterTrnProfileUrl = generateTrnProfileUrl(
					normalized.characterTrnGame,
					normalized.characterTrnUsername
				);
				if (!normalized.characterName && normalized.characterTrnUsername) {
					normalized.characterName = normalized.characterTrnUsername.split('#')[0] || normalized.characterTrnUsername;
				}
			}
			return normalized;
		}

		function generateAllSettingsAppId(name) {
			const base = (name || 'app').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
			return `${base || 'app'}-${Date.now().toString(36)}`;
		}

		const ALL_SETTINGS_MEDIA_CONFIG = {
			banner: { previewId: 'allSettingsAppBannerPreview', inputSelector: '#allSettingsBannerInput' },
			logo: { previewId: 'allSettingsAppLogoPreview', inputSelector: '#allSettingsLogoInput' },
			character: { previewId: 'allSettingsCharacterPreview', inputSelector: '#allSettingsCharacterInput' }
		};

		function normalizeAllSettingsSpecialOption(value) {
			const normalized = String(value || '').trim().toLowerCase();
			return ALL_SETTINGS_SPECIAL_OPTIONS.some(option => option.id === normalized)
				? normalized
				: ALL_SETTINGS_SPECIAL_OPTIONS[0].id;
		}

		function updateAllSettingsSpecialOptionUI(option) {
			const resolved = normalizeAllSettingsSpecialOption(option);
			const isCharacter = resolved === 'character-trn';
			const specialMedia = document.getElementById('allSettingsSpecialMedia');
			if (specialMedia) {
				specialMedia.classList.toggle('active', isCharacter);
			}
			const nameField = document.getElementById('allSettingsCharacterNameField');
			if (nameField) {
				nameField.classList.toggle('active', isCharacter);
				const input = nameField.querySelector('input');
				if (input) {
					input.disabled = !isCharacter;
					if (!isCharacter) input.value = '';
				}
			}
			const trnConfig = document.getElementById('allSettingsCharacterTrnConfig');
			if (trnConfig) {
				trnConfig.classList.toggle('active', isCharacter);
			}
			const trnUsernameInput = document.getElementById('allSettingsCharacterTrnUsername');
			if (trnUsernameInput) {
				trnUsernameInput.disabled = !isCharacter;
				if (!isCharacter) trnUsernameInput.value = '';
			}
			const trnGameSelect = document.getElementById('allSettingsCharacterTrnGame');
			if (trnGameSelect) {
				trnGameSelect.disabled = !isCharacter;
				if (!isCharacter) trnGameSelect.value = DEFAULT_TRN_GAME_ID;
			}
		}

		function ensureAllSettingsSpecialHandlers() {
			if (allSettingsSpecialHandlersBound) return;
			const select = document.getElementById('allSettingsSpecialOption');
			if (select) {
				select.addEventListener('change', event => {
					updateAllSettingsSpecialOptionUI(event.target.value);
				});
			}
			populateTrnGameOptions();
			allSettingsSpecialHandlersBound = true;
		}

		function setAllSettingsMediaPreview(type, value) {
			const config = ALL_SETTINGS_MEDIA_CONFIG[type];
			if (!config) return;
			const preview = document.getElementById(config.previewId);
			if (!preview) return;
			if (value) {
				applyBackgroundImage(preview, value);
				preview.classList.add('has-image');
				preview.classList.remove('empty');
				preview.style.opacity = '1';
			} else {
				preview.style.backgroundImage = '';
				preview.classList.remove('has-image');
				preview.classList.add('empty');
				preview.style.opacity = '0.45';
			}
		}

		function updateAllSettingsAppPreview() {
			setAllSettingsMediaPreview('banner', pendingAllSettingsAppMedia.banner);
			setAllSettingsMediaPreview('logo', pendingAllSettingsAppMedia.logo);
			setAllSettingsMediaPreview('character', pendingAllSettingsAppMedia.character);
		}

		function resolveUniqueTabLabel(baseLabel, tabs) {
			const base = (baseLabel || 'New Tab').trim() || 'New Tab';
			const existing = new Set((tabs || []).map(tab => (tab.label || '').toLowerCase()));
			if (!existing.has(base.toLowerCase())) {
				return base;
			}
			let index = 2;
			while (existing.has(`${base} ${index}`.toLowerCase())) {
				index += 1;
			}
			return `${base} ${index}`;
		}

		function buildSectionFromTemplate(templateId) {
			const template = SETTINGS_SECTION_TEMPLATES.find(item => item.id === templateId) || SETTINGS_SECTION_TEMPLATES[0];
			if (!template) {
				return { id: generateSettingsSectionId(), title: 'New Section', items: [] };
			}
			const section = template.build();
			return {
				id: section.id || generateSettingsSectionId(),
				title: section.title || 'New Section',
				items: Array.isArray(section.items) ? section.items.map(item => ({
					id: item.id || generateSettingsItemId(),
					label: item.label || '',
					value: item.value || ''
				})) : []
			};
		}

		function renderAppSettingsEditor() {
			renderAppSettingsTabList();
			renderAppSettingsTabDetail();
		}

		function renderAppSettingsTabList() {
			const list = document.getElementById('allSettingsSettingsTabList');
			if (!list) return;
			list.innerHTML = '';
			if (!editingAppSettingsTabs.length) {
				const empty = document.createElement('div');
				empty.className = 'app-settings-empty-state';
				empty.textContent = 'No tabs yet. Add one to start configuring settings.';
				list.appendChild(empty);
				return;
			}
			const activeId = activeEditingSettingsTabId;
			editingAppSettingsTabs.forEach(tab => {
				const item = document.createElement('div');
				item.className = 'app-settings-tab-item';
				item.dataset.tabId = tab.id;

				const selectBtn = document.createElement('button');
				selectBtn.type = 'button';
				selectBtn.className = 'app-settings-tab-select';
				if (tab.id === activeId) {
					selectBtn.classList.add('active');
				}
				selectBtn.dataset.action = 'select-tab';
				selectBtn.dataset.tabId = tab.id;
				const labelSpan = document.createElement('span');
				labelSpan.textContent = tab.label || 'Untitled Tab';
				const statusSpan = document.createElement('span');
				statusSpan.className = 'status';
				statusSpan.textContent = tab.hidden ? 'Hidden' : 'Visible';
				selectBtn.appendChild(labelSpan);
				selectBtn.appendChild(statusSpan);
				item.appendChild(selectBtn);

				const fields = document.createElement('div');
				fields.className = 'app-settings-tab-fields';
				const nameLabel = document.createElement('label');
				nameLabel.textContent = 'Tab name';
				const nameInput = document.createElement('input');
				nameInput.type = 'text';
				nameInput.value = tab.label || '';
				nameInput.dataset.role = 'tab-label';
				nameInput.dataset.tabId = tab.id;
				nameLabel.appendChild(nameInput);
				fields.appendChild(nameLabel);

				const toggleLabel = document.createElement('label');
				toggleLabel.className = 'app-settings-tab-toggle';
				const toggleInput = document.createElement('input');
				toggleInput.type = 'checkbox';
				toggleInput.checked = !!tab.hidden;
				toggleInput.dataset.role = 'tab-hidden';
				toggleInput.dataset.tabId = tab.id;
				toggleLabel.appendChild(toggleInput);
				const toggleText = document.createElement('span');
				toggleText.textContent = 'Hide this tab';
				toggleLabel.appendChild(toggleText);
				fields.appendChild(toggleLabel);

				item.appendChild(fields);

				const footer = document.createElement('div');
				footer.className = 'app-settings-tab-footer';
				const deleteBtn = document.createElement('button');
				deleteBtn.type = 'button';
				deleteBtn.className = 'danger';
				deleteBtn.dataset.action = 'delete-tab';
				deleteBtn.dataset.tabId = tab.id;
				deleteBtn.textContent = 'Delete';
				deleteBtn.setAttribute('aria-label', `Delete ${tab.label || 'tab'}`);
				footer.appendChild(deleteBtn);
				item.appendChild(footer);

				list.appendChild(item);
			});
		}

		function renderAppSettingsTabDetail() {
			const detail = document.getElementById('allSettingsSettingsTabDetail');
			if (!detail) return;
			detail.innerHTML = '';
			if (!editingAppSettingsTabs.length) {
				const placeholder = document.createElement('div');
				placeholder.className = 'app-settings-empty-state';
				placeholder.textContent = 'Add a tab to start managing sections and options.';
				detail.appendChild(placeholder);
				return;
			}
			let tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
			if (!tab) {
				tab = editingAppSettingsTabs[0];
				activeEditingSettingsTabId = tab?.id || null;
			}
			if (!tab) {
				const placeholder = document.createElement('div');
				placeholder.className = 'app-settings-empty-state';
				placeholder.textContent = 'No tab selected.';
				detail.appendChild(placeholder);
				return;
			}

			const header = document.createElement('header');
			const heading = document.createElement('h5');
			heading.textContent = `${tab.label || 'Untitled Tab'} sections`;
			header.appendChild(heading);
			const sectionActions = document.createElement('div');
			sectionActions.className = 'app-settings-section-actions';
			const templateSelect = document.createElement('select');
			templateSelect.dataset.role = 'section-template';
			SETTINGS_SECTION_TEMPLATES.forEach(template => {
				const opt = document.createElement('option');
				opt.value = template.id;
				opt.textContent = template.label;
				templateSelect.appendChild(opt);
			});
			const addSectionBtn = document.createElement('button');
			addSectionBtn.type = 'button';
			addSectionBtn.className = 'admin-logout-btn alt-light';
			addSectionBtn.dataset.action = 'add-section';
			addSectionBtn.textContent = 'Add section';
			sectionActions.appendChild(templateSelect);
			sectionActions.appendChild(addSectionBtn);
			header.appendChild(sectionActions);
			detail.appendChild(header);

			if (!tab.sections.length) {
				const placeholder = document.createElement('div');
				placeholder.className = 'app-settings-empty-state';
				placeholder.textContent = 'No sections yet. Use the dropdown above to add one.';
				detail.appendChild(placeholder);
				return;
			}

			const sectionList = document.createElement('div');
			sectionList.className = 'app-settings-section-list';
			tab.sections.forEach(section => {
				const card = document.createElement('div');
				card.className = 'app-settings-section-card';
				card.dataset.sectionId = section.id;

				const cardHeader = document.createElement('header');
				const sectionTitleInput = document.createElement('input');
				sectionTitleInput.type = 'text';
				sectionTitleInput.value = section.title || '';
				sectionTitleInput.dataset.role = 'section-title';
				sectionTitleInput.dataset.sectionId = section.id;
				cardHeader.appendChild(sectionTitleInput);

				const removeSectionBtn = document.createElement('button');
				removeSectionBtn.type = 'button';
				removeSectionBtn.dataset.action = 'delete-section';
				removeSectionBtn.dataset.sectionId = section.id;
				removeSectionBtn.textContent = 'Remove section';
				removeSectionBtn.setAttribute('aria-label', 'Remove this section');
				cardHeader.appendChild(removeSectionBtn);
				card.appendChild(cardHeader);

				const optionList = document.createElement('div');
				optionList.className = 'app-settings-option-list';
				if (!section.items.length) {
					const emptyOption = document.createElement('div');
					emptyOption.className = 'app-settings-empty-state';
					emptyOption.textContent = 'No options yet. Add one below.';
					optionList.appendChild(emptyOption);
				} else {
					section.items.forEach(item => {
						const row = document.createElement('div');
						row.className = 'app-settings-option-row';
						row.dataset.itemId = item.id;

						const labelInput = document.createElement('input');
						labelInput.type = 'text';
						labelInput.value = item.label || '';
						labelInput.placeholder = 'Setting';
						labelInput.dataset.role = 'option-field';
						labelInput.dataset.field = 'label';
						labelInput.dataset.sectionId = section.id;
						labelInput.dataset.itemId = item.id;

						const valueInput = document.createElement('input');
						valueInput.type = 'text';
						valueInput.value = item.value || '';
						valueInput.placeholder = 'Value';
						valueInput.dataset.role = 'option-field';
						valueInput.dataset.field = 'value';
						valueInput.dataset.sectionId = section.id;
						valueInput.dataset.itemId = item.id;

						const deleteOptionBtn = document.createElement('button');
						deleteOptionBtn.type = 'button';
						deleteOptionBtn.dataset.action = 'delete-option';
						deleteOptionBtn.dataset.sectionId = section.id;
						deleteOptionBtn.dataset.itemId = item.id;
						deleteOptionBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6l1-3h4l1 3"/></svg>';
						deleteOptionBtn.setAttribute('aria-label', 'Remove option');

						row.appendChild(labelInput);
						row.appendChild(valueInput);
						row.appendChild(deleteOptionBtn);
						optionList.appendChild(row);
					});
				}
				card.appendChild(optionList);

				const optionActions = document.createElement('div');
				optionActions.className = 'app-settings-option-actions';
				const addOptionBtn = document.createElement('button');
				addOptionBtn.type = 'button';
				addOptionBtn.className = 'add-option';
				addOptionBtn.dataset.action = 'add-option';
				addOptionBtn.dataset.sectionId = section.id;
				addOptionBtn.textContent = 'Add option';
				optionActions.appendChild(addOptionBtn);
				card.appendChild(optionActions);

				sectionList.appendChild(card);
			});
			detail.appendChild(sectionList);
		}

		function ensureAppSettingsEditorHandlers() {
			if (appSettingsEditorHandlersBound) return;
			const editor = document.getElementById('allSettingsAppSettingsEditor');
			if (!editor) return;
			editor.addEventListener('input', handleAppSettingsEditorInput);
			editor.addEventListener('change', handleAppSettingsEditorChange);
			editor.addEventListener('click', handleAppSettingsEditorClick);
			const addTabBtn = document.getElementById('addSettingsTabBtn');
			if (addTabBtn) {
				addTabBtn.addEventListener('click', () => {
					addNewAppSettingsTab();
				});
			}
			appSettingsEditorHandlersBound = true;
		}

		function handleAppSettingsEditorInput(event) {
			const target = event.target;
			if (!target) return;
			const role = target.dataset.role;
			if (role === 'tab-label') {
				const tabId = target.dataset.tabId;
				const tab = editingAppSettingsTabs.find(item => item.id === tabId);
				if (tab) {
					tab.label = target.value;
					const selectBtn = document.querySelector(`.app-settings-tab-select[data-tab-id="${tabId}"] span:first-child`);
					if (selectBtn) {
						selectBtn.textContent = target.value || 'Untitled Tab';
					}
					if (tabId === activeEditingSettingsTabId) {
						const detailHeader = document.querySelector('#allSettingsSettingsTabDetail header h5');
						if (detailHeader) {
							detailHeader.textContent = `${tab.label || 'Untitled Tab'} sections`;
						}
					}
				}
			}
			if (role === 'section-title') {
				const sectionId = target.dataset.sectionId;
				const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
				if (!tab) return;
				const section = tab.sections.find(item => item.id === sectionId);
				if (section) {
					section.title = target.value;
				}
			}
			if (role === 'option-field') {
				const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
				if (!tab) return;
				const section = tab.sections.find(item => item.id === target.dataset.sectionId);
				if (!section) return;
				const item = section.items.find(option => option.id === target.dataset.itemId);
				if (!item) return;
				if (target.dataset.field === 'label') {
					item.label = target.value;
				} else if (target.dataset.field === 'value') {
					item.value = target.value;
				}
			}
		}

		function handleAppSettingsEditorChange(event) {
			const target = event.target;
			if (!target) return;
			const role = target.dataset.role;
			if (role === 'tab-hidden') {
				const tab = editingAppSettingsTabs.find(item => item.id === target.dataset.tabId);
				if (tab) {
					tab.hidden = target.checked;
					renderAppSettingsTabList();
				}
			}
		}

		function handleAppSettingsEditorClick(event) {
			const actionTarget = event.target.closest('[data-action]');
			if (!actionTarget) return;
			const action = actionTarget.dataset.action;
			switch(action) {
				case 'select-tab': {
					const tabId = actionTarget.dataset.tabId;
					setActiveEditingTab(tabId);
					break;
				}
				case 'delete-tab': {
					const tabId = actionTarget.dataset.tabId;
					removeAppSettingsTab(tabId);
					break;
				}
				case 'add-section': {
					const detail = document.getElementById('allSettingsSettingsTabDetail');
					const select = detail ? detail.querySelector('select[data-role="section-template"]') : null;
					const templateId = select ? select.value : SETTINGS_SECTION_TEMPLATES[0].id;
					addSectionToActiveTab(templateId);
					break;
				}
				case 'delete-section': {
					const sectionId = actionTarget.dataset.sectionId;
					removeSectionFromActiveTab(sectionId);
					break;
				}
				case 'add-option': {
					const sectionId = actionTarget.dataset.sectionId;
					addOptionToSection(sectionId);
					break;
				}
				case 'delete-option': {
					const sectionId = actionTarget.dataset.sectionId;
					const itemId = actionTarget.dataset.itemId;
					removeOptionFromSection(sectionId, itemId);
					break;
				}
			}
		}

		function setActiveEditingTab(tabId) {
			if (!tabId) return;
			if (!editingAppSettingsTabs.some(tab => tab.id === tabId)) return;
			activeEditingSettingsTabId = tabId;
			renderAppSettingsEditor();
		}

		function addNewAppSettingsTab() {
			const label = resolveUniqueTabLabel('New Tab', editingAppSettingsTabs);
			const newTab = {
				id: generateSettingsTabId(label),
				label,
				hidden: false,
				sections: []
			};
			editingAppSettingsTabs.push(newTab);
			activeEditingSettingsTabId = newTab.id;
			renderAppSettingsEditor();
		}

		function removeAppSettingsTab(tabId) {
			if (!tabId) return;
			if (editingAppSettingsTabs.length <= 1) {
				if (typeof notify !== 'undefined' && typeof notify.warning === 'function') {
					notify.warning('Keep at least one tab. Hide it if you do not want to show it.');
				} else {
					console.warn('Keep at least one tab. Hide it if you do not want to show it.');
				}
				return;
			}
			const tab = editingAppSettingsTabs.find(item => item.id === tabId);
			const shouldRemove = window.confirm ? window.confirm(`Remove the “${tab?.label || 'Untitled Tab'}” tab?`) : true;
			if (!shouldRemove) return;
			editingAppSettingsTabs = editingAppSettingsTabs.filter(item => item.id !== tabId);
			if (!editingAppSettingsTabs.some(item => item.id === activeEditingSettingsTabId)) {
				activeEditingSettingsTabId = editingAppSettingsTabs[0]?.id || null;
			}
			renderAppSettingsEditor();
		}

		function addSectionToActiveTab(templateId) {
			const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
			if (!tab) return;
			const section = buildSectionFromTemplate(templateId);
			tab.sections.push(section);
			renderAppSettingsTabDetail();
		}

		function removeSectionFromActiveTab(sectionId) {
			const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
			if (!tab) return;
			tab.sections = tab.sections.filter(section => section.id !== sectionId);
			renderAppSettingsTabDetail();
		}

		function addOptionToSection(sectionId) {
			const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
			if (!tab) return;
			const section = tab.sections.find(item => item.id === sectionId);
			if (!section) return;
			section.items.push({ id: generateSettingsItemId(), label: '', value: '' });
			renderAppSettingsTabDetail();
		}

		function removeOptionFromSection(sectionId, itemId) {
			const tab = editingAppSettingsTabs.find(item => item.id === activeEditingSettingsTabId);
			if (!tab) return;
			const section = tab.sections.find(item => item.id === sectionId);
			if (!section) return;
			section.items = section.items.filter(item => item.id !== itemId);
			renderAppSettingsTabDetail();
		}

		function initializeAppSettingsEditor(initialTabs, legacyTemplate = []) {
			const normalized = normalizeAppSettingsTabs(initialTabs, legacyTemplate);
			editingAppSettingsTabs = cloneAppSettingsTabs(normalized.length ? normalized : cloneDefaultAppSettingsTabs());
			if (!editingAppSettingsTabs.length) {
				editingAppSettingsTabs = cloneDefaultAppSettingsTabs();
			}
			activeEditingSettingsTabId = editingAppSettingsTabs[0]?.id || null;
			renderAppSettingsEditor();
			ensureAppSettingsEditorHandlers();
		}

		function triggerAllSettingsMediaInput(type) {
			const config = ALL_SETTINGS_MEDIA_CONFIG[type];
			if (!config) return;
			const input = document.querySelector(config.inputSelector);
			if (input) input.click();
		}

		async function onAllSettingsMediaInputChange(event) {
			const input = event.target;
			const type = input?.dataset?.mediaType;
			if (!type || !ALL_SETTINGS_MEDIA_CONFIG[type]) return;
			const file = input.files && input.files[0];
			if (!file) return;
			try {
				const dataUrl = await readFileAsDataURL(file);
				pendingAllSettingsAppMedia[type] = dataUrl;
				setAllSettingsMediaPreview(type, pendingAllSettingsAppMedia[type]);
			} catch (error) {
				console.error('Failed to process media upload:', error);
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Could not process that image. Try again with a different file.');
				}
			} finally {
				if (input) input.value = '';
			}
		}

		function ensureAllSettingsMediaHandlers() {
			if (allSettingsMediaHandlersBound) return;
			const triggers = document.querySelectorAll('[data-media-trigger]');
			triggers.forEach(button => {
				button.addEventListener('click', event => {
					event.preventDefault();
					const type = button.dataset.mediaTrigger;
					triggerAllSettingsMediaInput(type);
				});
			});
			const previews = document.querySelectorAll('.app-media-preview');
			previews.forEach(preview => {
				const type = preview.dataset.mediaType;
				preview.addEventListener('click', () => triggerAllSettingsMediaInput(type));
				preview.addEventListener('keydown', event => {
					if (event.key === 'Enter' || event.key === ' ') {
						event.preventDefault();
						triggerAllSettingsMediaInput(type);
					}
				});
			});
			const inputs = document.querySelectorAll('.app-media-input');
			inputs.forEach(input => {
				input.addEventListener('change', onAllSettingsMediaInputChange);
			});
			allSettingsMediaHandlersBound = true;
		}

		function resetAllSettingsAppForm() {
			editingAllSettingsAppId = null;
			const nameInput = document.getElementById('allSettingsAppName');
			if (nameInput) nameInput.value = '';
			const categorySelect = document.getElementById('allSettingsAppCategory');
			if (categorySelect) categorySelect.value = DEFAULT_GAME_SETTINGS_TABS[0].id;
			const specialSelect = document.getElementById('allSettingsSpecialOption');
			if (specialSelect) specialSelect.value = ALL_SETTINGS_SPECIAL_OPTIONS[0].id;
			const characterNameInput = document.getElementById('allSettingsCharacterNameInput');
			if (characterNameInput) characterNameInput.value = '';
			const trnUsernameInput = document.getElementById('allSettingsCharacterTrnUsername');
			if (trnUsernameInput) trnUsernameInput.value = '';
			const trnGameSelect = document.getElementById('allSettingsCharacterTrnGame');
			if (trnGameSelect) trnGameSelect.value = DEFAULT_TRN_GAME_ID;
			pendingAllSettingsAppMedia = { banner: null, logo: null, character: null };
			updateAllSettingsAppPreview();
			updateAllSettingsSpecialOptionUI(ALL_SETTINGS_SPECIAL_OPTIONS[0].id);
			initializeAppSettingsEditor([]);
			const title = document.querySelector('#allSettingsAppFormPopup .popup-header h3');
			if (title) title.textContent = 'Add App to All Settings';
		}

		function openAllSettingsManager() {
			renderAllSettingsManagerGrid();
			openPopup('allSettingsManagerPopup');
		}

		function closeAllSettingsManager() {
			closePopup('allSettingsManagerPopup');
		}

		function openAddAllSettingsAppPopup(appId = null) {
			const title = document.querySelector('#allSettingsAppFormPopup .popup-header h3');
			editingAllSettingsAppId = appId || null;
			ensureAllSettingsMediaHandlers();
			ensureAllSettingsSpecialHandlers();
			if (appId) {
				const app = allSettingsApps.find(item => item.id === appId);
				if (app) {
					const nameInput = document.getElementById('allSettingsAppName');
					if (nameInput) nameInput.value = app.name || '';
					const categorySelect = document.getElementById('allSettingsAppCategory');
					if (categorySelect) categorySelect.value = resolveGameSettingsTabId(app.tabId);
					const specialSelect = document.getElementById('allSettingsSpecialOption');
					if (specialSelect) specialSelect.value = normalizeAllSettingsSpecialOption(app.specialOption);
					const characterNameInput = document.getElementById('allSettingsCharacterNameInput');
					if (characterNameInput) characterNameInput.value = app.characterName || '';
					const trnUsernameInput = document.getElementById('allSettingsCharacterTrnUsername');
					if (trnUsernameInput) trnUsernameInput.value = app.characterTrnUsername || '';
					const trnGameSelect = document.getElementById('allSettingsCharacterTrnGame');
					if (trnGameSelect) trnGameSelect.value = normalizeTrnGameId(app.characterTrnGame);
					pendingAllSettingsAppMedia = {
						banner: (app.banner && app.banner !== 'N/A') ? app.banner : null,
						logo: (app.logo && app.logo !== 'N/A') ? app.logo : null,
						character: (app.characterImage && app.characterImage !== 'N/A') ? app.characterImage : null
					};
					initializeAppSettingsEditor(app.settingsTabs, app.settingsTemplate);
					updateAllSettingsSpecialOptionUI(specialSelect ? specialSelect.value : ALL_SETTINGS_SPECIAL_OPTIONS[0].id);
					if (title) title.textContent = `Edit ${app.name || 'App'}`;
				} else {
					resetAllSettingsAppForm();
				}
			} else {
				resetAllSettingsAppForm();
			}
			updateAllSettingsAppPreview();
			if (!appId) {
				updateAllSettingsSpecialOptionUI(ALL_SETTINGS_SPECIAL_OPTIONS[0].id);
			}
			openPopup('allSettingsAppFormPopup');
		}

		function closeAddAllSettingsAppPopup() {
			resetAllSettingsAppForm();
			closePopup('allSettingsAppFormPopup');
		}

		function buildSettingsAppCard(app) {
			const card = document.createElement('div');
			card.className = 'settings-app-card';
			card.dataset.appId = app.id;
			card.tabIndex = 0;
			card.setAttribute('role', 'button');
			card.setAttribute('aria-label', `Edit ${app.name}`);
			applyBackgroundImage(card, app.banner);
			const overlay = document.createElement('div');
			overlay.className = 'app-card-overlay';
			if (app.logo) {
				const logo = document.createElement('img');
				logo.src = app.logo;
				logo.alt = `${app.name} logo`;
				logo.dataset.keepColor = 'true';
				overlay.appendChild(logo);
			}
			const nameEl = document.createElement('div');
			nameEl.className = 'app-card-name';
			nameEl.textContent = app.name || 'Untitled App';
			overlay.appendChild(nameEl);
			const badge = document.createElement('span');
			badge.className = 'app-card-badge';
			badge.textContent = getGameSettingsTabLabel(resolveGameSettingsTabId(app.tabId));
			overlay.appendChild(badge);
			const actions = document.createElement('div');
			actions.className = 'app-card-actions';
			const deleteBtn = document.createElement('button');
			deleteBtn.type = 'button';
			deleteBtn.className = 'app-card-action delete';
			deleteBtn.textContent = 'Remove';
			deleteBtn.addEventListener('click', event => {
				event.stopPropagation();
				event.preventDefault();
				deleteAllSettingsApp(app.id);
			});
			actions.appendChild(deleteBtn);
			overlay.appendChild(actions);
			card.appendChild(overlay);
			card.addEventListener('click', event => {
				if (event.target.closest('.app-card-actions')) {
					return;
				}
				openAddAllSettingsAppPopup(app.id);
			});
			card.addEventListener('keydown', event => {
				if (event.key === 'Enter' || event.key === ' ') {
					event.preventDefault();
					openAddAllSettingsAppPopup(app.id);
				}
			});
			return card;
		}

		function buildAddAppCard() {
			const card = document.createElement('div');
			card.className = 'settings-app-card add-card';
			card.tabIndex = 0;
			card.setAttribute('role', 'button');
			card.setAttribute('aria-label', 'Add new app');
			const icon = document.createElement('div');
			icon.className = 'add-icon';
			icon.textContent = '+';
			const label = document.createElement('span');
			label.textContent = 'Add new app';
			card.appendChild(icon);
			card.appendChild(label);
			card.addEventListener('click', () => openAddAllSettingsAppPopup());
			card.addEventListener('keydown', event => {
				if (event.key === 'Enter' || event.key === ' ') {
					event.preventDefault();
					openAddAllSettingsAppPopup();
				}
			});
			return card;
		}

		function renderAllSettingsManagerGrid() {
			const grid = document.getElementById('allSettingsAppGrid');
			const emptyState = document.getElementById('allSettingsEmptyState');
			if (!grid) return;
			grid.innerHTML = '';
			const apps = Array.isArray(allSettingsApps) ? allSettingsApps.slice() : [];
			const tabOrder = DEFAULT_GAME_SETTINGS_TABS.map(tab => tab.id);
			apps.sort((a, b) => {
				const aTab = resolveGameSettingsTabId(a.tabId);
				const bTab = resolveGameSettingsTabId(b.tabId);
				const aIndex = tabOrder.indexOf(aTab);
				const bIndex = tabOrder.indexOf(bTab);
				if (aIndex !== bIndex) return aIndex - bIndex;
				return (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' });
			});
			grid.appendChild(buildAddAppCard());
			if (emptyState) {
				emptyState.style.display = apps.length ? 'none' : 'block';
			}
			apps.forEach(app => {
				const normalized = normalizeAllSettingsApp(app);
				if (!normalized) return;
				grid.appendChild(buildSettingsAppCard(normalized));
			});
		}

		async function persistAllSettingsApps() {
			try {
				await saveGlobalSetting('allSettingsApps', JSON.stringify(allSettingsApps));
			} catch (error) {
				console.error('Failed to persist All Settings apps:', error);
				throw error;
			}
		}

		async function saveAllSettingsApp() {
			const nameInput = document.getElementById('allSettingsAppName');
			const categorySelect = document.getElementById('allSettingsAppCategory');
			const specialSelect = document.getElementById('allSettingsSpecialOption');
			const characterNameInput = document.getElementById('allSettingsCharacterNameInput');
			const characterTrnUsernameInput = document.getElementById('allSettingsCharacterTrnUsername');
			const characterTrnGameSelect = document.getElementById('allSettingsCharacterTrnGame');
			const name = (nameInput?.value || '').trim();
			const logo = pendingAllSettingsAppMedia.logo || '';
			const banner = pendingAllSettingsAppMedia.banner || '';
			const tabId = resolveGameSettingsTabId(categorySelect?.value);
			const specialOption = normalizeAllSettingsSpecialOption(specialSelect?.value);
			let characterName = (characterNameInput?.value || '').trim();
			let characterImage = pendingAllSettingsAppMedia.character || '';
			let characterTrnUsername = (characterTrnUsernameInput?.value || '').trim();
			let characterTrnGame = normalizeTrnGameId(characterTrnGameSelect?.value);
			let characterTrnProfileUrl = '';
			if (specialOption !== 'character-trn') {
				characterImage = '';
				characterName = '';
				characterTrnUsername = '';
				characterTrnGame = DEFAULT_TRN_GAME_ID;
				characterTrnProfileUrl = '';
			} else {
				if (!characterTrnUsername) {
					if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
						notify.error('Enter your Tracker username (including the tagline).');
					}
					characterTrnUsernameInput?.focus();
					return;
				}
				characterTrnProfileUrl = generateTrnProfileUrl(characterTrnGame, characterTrnUsername);
			}
			if (!name) {
				notify.error('Give the app a name before saving.');
				nameInput?.focus();
				return;
			}
			const settingsTabs = cloneAppSettingsTabs(editingAppSettingsTabs);
			const settingsTemplate = flattenSettingsTabsToTemplate(settingsTabs);
			let targetId = editingAllSettingsAppId;
			const timestamp = Date.now();
			if (editingAllSettingsAppId) {
				const existingIndex = allSettingsApps.findIndex(app => app.id === editingAllSettingsAppId);
				if (existingIndex !== -1) {
					allSettingsApps[existingIndex] = {
						...allSettingsApps[existingIndex],
						name,
						logo,
						banner,
						tabId,
						settingsTabs,
						settingsTemplate,
						specialOption,
						characterImage,
						characterName,
						characterTrnUsername,
						characterTrnGame,
						characterTrnProfileUrl,
						updatedAt: timestamp
					};
				} else {
					// treat as new if missing
					targetId = generateAllSettingsAppId(name);
					allSettingsApps.push({
						id: targetId,
						name,
						logo,
						banner,
						tabId,
						settingsTabs,
						settingsTemplate,
						specialOption,
						characterImage,
						characterName,
						characterTrnUsername,
						characterTrnGame,
						characterTrnProfileUrl,
						createdAt: timestamp,
						updatedAt: timestamp
					});
				}
			} else {
				targetId = generateAllSettingsAppId(name);
				allSettingsApps.push({
					id: targetId,
					name,
					logo,
					banner,
					tabId,
					settingsTabs,
					settingsTemplate,
					specialOption,
					characterImage,
					characterName,
					characterTrnUsername,
					characterTrnGame,
					characterTrnProfileUrl,
					createdAt: timestamp,
					updatedAt: timestamp
				});
			}
			// Deduplicate by id and normalize ordering
			const deduped = [];
			const seen = new Set();
			allSettingsApps.forEach(app => {
				const normalized = normalizeAllSettingsApp(app);
				if (!normalized || seen.has(normalized.id)) return;
				seen.add(normalized.id);
				deduped.push(normalized);
			});
			allSettingsApps = deduped;
			editingAllSettingsAppId = null;
			try {
				await persistAllSettingsApps();
			} catch (error) {
				notify.error('Could not save this app. Please try again.');
				return;
			}
			renderAllSettingsManagerGrid();
			renderGameSettingsTabs(tabId);
			closeAddAllSettingsAppPopup();
			notify.success('App saved to All Settings.');
		}

		async function deleteAllSettingsApp(appId) {
			const app = allSettingsApps.find(item => item.id === appId);
			if (!app) return;
			let confirmed = true;
			const promptMessage = `Remove ${app.name}?`;
			if (typeof showConfirm === 'function') {
				try {
					confirmed = await showConfirm(promptMessage, {
						title: 'Remove settings app',
						confirmText: 'Remove',
						cancelText: 'Keep',
						type: 'warning'
					});
				} catch (error) {
					console.warn('Custom confirm failed, falling back to browser confirm.', error);
					confirmed = window.confirm(promptMessage);
				}
			} else {
				confirmed = window.confirm(promptMessage);
			}
			if (!confirmed) return;
			const previousApps = allSettingsApps.slice();
			allSettingsApps = allSettingsApps.filter(item => item.id !== appId);
			renderAllSettingsManagerGrid();
			renderGameSettingsTabs(currentGameSettingsTabId);
			try {
				await persistAllSettingsApps();
			} catch (error) {
				notify.error('Could not remove the app. Please try again.');
				allSettingsApps = previousApps;
				renderAllSettingsManagerGrid();
				renderGameSettingsTabs(currentGameSettingsTabId);
				return;
			}
			notify.success(`${app.name} removed.`);
		}

		function closeGameSettingsPopup() {
			closeSettingsAppDetailPopup(true);
			const popup = document.getElementById('gameSettingsPopup');
			if (popup) {
				popup.style.display = 'none';
				setBodyScrollState(false);
			}
		}

		// Close popup when clicking outside
		document.addEventListener('click', function(event) {
			var followPopup = document.getElementById('followPopup');
			var subscribePopup = document.getElementById('subscribePopup');
			var colorsPopup = document.getElementById('colorsPopup');
			var gameSettingsPopup = document.getElementById('gameSettingsPopup');
			var settingsDetailPopup = document.getElementById('settingsAppDetailPopup');
			
			if (event.target === followPopup) {
				closePopup('followPopup');
			}
			if (event.target === subscribePopup) {
				closePopup('subscribePopup');
			}
			if (event.target === colorsPopup) {
				closePopup('colorsPopup');
			}
			if (event.target === gameSettingsPopup) {
				closeGameSettingsPopup();
			}
			if (event.target === settingsDetailPopup) {
				closeSettingsAppDetailPopup();
			}
		});

		// Close popup with Escape key
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				const detailPopup = document.getElementById('settingsAppDetailPopup');
				if (detailPopup && detailPopup.style.display === 'flex') {
					closeSettingsAppDetailPopup();
					return;
				}
				closeGameSettingsPopup();
				closePopup('followPopup');
				closePopup('subscribePopup');
				closePopup('colorsPopup');
			}
		});
	</script>

	<!-- Follow Popup -->
	<div id="followPopup" class="popup-overlay">
		<div class="popup-content">
			<div class="popup-header">
				<h3 id="followPopupTitle">Follow ilyambr</h3>
				<button class="close-btn" onclick="closePopup('followPopup')">&times;</button>
			</div>
			<div class="popup-body">
				<p>Choose where you'd like to follow:</p>
				<div class="popup-buttons" id="followPopupButtons"></div>
			</div>
		</div>
	</div>

	<!-- Subscribe Popup -->
	<div id="subscribePopup" class="popup-overlay">
		<div class="popup-content">
			<div class="popup-header">
				<h3 id="subscribePopupTitle">Subscribe to ilyambr</h3>
				<button class="close-btn" onclick="closePopup('subscribePopup')">&times;</button>
			</div>
			<div class="popup-body">
				<p>Choose where you'd like to subscribe:</p>
				<div class="popup-buttons" id="subscribePopupButtons"></div>
			</div>
		</div>
	</div>

	<!-- Colors Editor Popup -->
	<div id="colorsPopup" class="popup-overlay" data-keep-color="true">
		<div class="popup-content" data-keep-color="true">
			<div class="popup-header">
				<h3>Edit Site Colors</h3>
				<button class="close-btn" onclick="closePopup('colorsPopup')">&times;</button>
			</div>
			<div class="popup-body" data-keep-color="true">
				<div class="admin-setting" data-keep-color="true">
					<div id="colorsList" class="colors-list" data-keep-color="true"></div>
					<div class="colors-actions" data-keep-color="true">
						<button onclick="saveColorsToDb()" style="background: linear-gradient(90deg, #00d2d3, #54a0ff);">Save Colors Globally</button>
						<button onclick="resetColorsToDefaults()" style="background: linear-gradient(90deg, #ff6b6b, #ee5a24);">Reset Colors</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- All Settings Popup -->
	<div id="gameSettingsPopup" class="popup-overlay game-settings-overlay" data-keep-color="true">
		<div class="popup-content game-settings-panel" data-keep-color="true">
			<div class="popup-header">
				<div>
					<h3>All Settings</h3>
					<small style="color:var(--muted);">View <span id="gameSettingsUsername">@ilyambrr</span>'s settings and configurations for everything.</small>
				</div>
				<button class="close-btn" onclick="closeGameSettingsPopup()" aria-label="Close all settings">&times;</button>
			</div>
			<div class="popup-body" id="gameSettingsBody" data-keep-color="true">
				<div class="settings-layout" data-keep-color="true">
					<nav class="settings-tabs" id="gameSettingsTabs" aria-label="Settings categories" data-keep-color="true"></nav>
					<div class="settings-content" id="gameSettingsContent" data-keep-color="true"></div>
				</div>
			</div>
		</div>
	</div>

	<div id="settingsAppDetailPopup" class="popup-overlay settings-detail-overlay" data-keep-color="true">
		<div class="settings-detail-columns" id="settingsDetailColumns" data-keep-color="true">
			<div class="popup-content settings-detail-panel" id="settingsDetailMainPanel" data-keep-color="true">
				<div class="popup-header">
					<div>
						<h3 id="settingsAppDetailTitle">App Settings</h3>
						<small id="settingsAppDetailCategory" style="color:var(--muted); display:block;">&nbsp;</small>
					</div>
					<button class="close-btn" onclick="closeSettingsAppDetailPopup()" aria-label="Close app settings detail">&times;</button>
				</div>
				<div class="popup-body" data-keep-color="true">
					<div id="settingsAppDetailBody" data-keep-color="true"></div>
				</div>
			</div>
			<div class="popup-content character-detail-panel" id="settingsCharacterDetailPanel" aria-hidden="true" data-keep-color="true">
				<div class="character-detail-body" id="settingsCharacterDetailBody" data-keep-color="true"></div>
			</div>
		</div>
	</div>

		<!-- All Settings Manager Popup -->
		<div id="allSettingsManagerPopup" class="popup-overlay">
			<div class="popup-content admin-popup" style="max-width:920px;">
				<div class="popup-header">
					<h3>All Settings Apps</h3>
					<button class="close-btn" onclick="closeAllSettingsManager()" aria-label="Close all settings manager">&times;</button>
				</div>
				<div class="popup-body" style="max-height:70vh; overflow-y:auto; display:flex; flex-direction:column; gap:18px;">
					<p class="settings-manager-empty" id="allSettingsEmptyState" style="display:none;">No custom apps yet. Tap the banner card to add your first one.</p>
					<div class="settings-manager-grid" id="allSettingsAppGrid"></div>
				</div>
			</div>
		</div>

		<!-- Add All Settings App Popup -->
		<div id="allSettingsAppFormPopup" class="popup-overlay">
			<div class="popup-content admin-popup" style="max-width:960px; max-height:90vh;">
				<div class="popup-header">
					<h3>Add App to All Settings</h3>
					<button class="close-btn" onclick="closeAddAllSettingsAppPopup()" aria-label="Close add app popup">&times;</button>
				</div>
				<div class="popup-body" style="display:flex; flex-direction:column; gap:22px; overflow-y:auto;">
					<div class="app-form-grid">
						<div class="app-name-field">
							<div class="app-name-main">
								<label for="allSettingsAppName" class="app-name-label">App Name</label>
								<input type="text" id="allSettingsAppName" class="app-name-input" placeholder="Valorant" maxlength="60">
							</div>
							<div class="app-inline-logo">
								<div class="app-form-logo-preview app-media-preview empty" id="allSettingsAppLogoPreview" data-media-type="logo" data-keep-color="true" tabindex="0" role="button" aria-label="Upload logo image">
									<button class="app-media-upload" type="button" data-media-trigger="logo" aria-label="Upload logo image">
										<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><polyline points="7 9 12 4 17 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
										Upload
									</button>
									<input type="file" accept="image/*" id="allSettingsLogoInput" class="app-media-input" data-media-type="logo">
								</div>
								<span class="app-inline-logo-hint">Logo • 512 × 512</span>
							</div>
						</div>
						<div class="app-category-field">
							<label for="allSettingsAppCategory" class="app-category-label">Tab</label>
							<select id="allSettingsAppCategory" class="app-category-select">
								<option value="games">Games</option>
								<option value="utility">Utility</option>
								<option value="hardware">Hardware</option>
								<option value="internet">Internet</option>
							</select>
						</div>
					</div>
					<div class="app-form-layout">
						<div class="app-form-left">
							<div class="app-form-previews">
								<div class="app-media-block">
									<span class="app-media-hint">Banner • 1080 × 1640</span>
									<div class="app-form-banner-preview app-media-preview empty" id="allSettingsAppBannerPreview" data-media-type="banner" data-keep-color="true" tabindex="0" role="button" aria-label="Upload banner image">
										<button class="app-media-upload" type="button" data-media-trigger="banner" aria-label="Upload banner image">
											<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><polyline points="7 9 12 4 17 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
											Upload
										</button>
										<input type="file" accept="image/*" id="allSettingsBannerInput" class="app-media-input" data-media-type="banner">
									</div>
								</div>
							</div>
						</div>
						<div class="app-form-right">
							<div class="special-option-field">
								<label for="allSettingsSpecialOption" class="special-option-label">Special Option</label>
								<select id="allSettingsSpecialOption" class="special-option-select">
									<option value="none">None</option>
									<option value="character-trn">Character (TRN)</option>
								</select>
							</div>
							<div class="character-name-field" id="allSettingsCharacterNameField">
								<label for="allSettingsCharacterNameInput" class="character-name-label">Display Name (optional)</label>
								<input type="text" id="allSettingsCharacterNameInput" class="character-name-input" placeholder="Jett" maxlength="60" autocomplete="off">
							</div>
							<div class="character-trn-config" id="allSettingsCharacterTrnConfig">
								<div class="character-trn-field">
									<label for="allSettingsCharacterTrnUsername" class="character-trn-label">Tracker Username</label>
									<input type="text" id="allSettingsCharacterTrnUsername" class="character-trn-input" placeholder="ilyambr#ttb" autocomplete="off" maxlength="80">
									<span class="character-trn-hint">Use your in-game ID exactly as shown, including the tagline.</span>
								</div>
								<div class="character-trn-field">
									<label for="allSettingsCharacterTrnGame" class="character-trn-label">Game</label>
									<select id="allSettingsCharacterTrnGame" class="character-trn-select">
										<option value="valorant">Valorant</option>
									</select>
								</div>
							</div>
							<div class="app-special-media" id="allSettingsSpecialMedia">
								<div class="app-media-block">
									<span class="app-media-hint">Character Image • 1080 × 1440</span>
									<div class="app-special-preview app-media-preview empty" id="allSettingsCharacterPreview" data-media-type="character" data-keep-color="true" tabindex="0" role="button" aria-label="Upload character image">
										<button class="app-media-upload" type="button" data-media-trigger="character" aria-label="Upload character image">
											<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><polyline points="7 9 12 4 17 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
											Upload
										</button>
										<input type="file" accept="image/*" id="allSettingsCharacterInput" class="app-media-input" data-media-type="character">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="app-settings-editor" id="allSettingsAppSettingsEditor">
						<div class="app-settings-editor-header">
							<div>
								<h4>Settings Tabs & Sections</h4>
								<p>Organize every tab, control visibility, and add sections and options for each configuration page.</p>
							</div>
							<div class="app-settings-editor-actions">
								<button type="button" class="admin-logout-btn alt-light" id="addSettingsTabBtn">Add Tab</button>
							</div>
						</div>
						<div class="app-settings-editor-body">
							<aside class="app-settings-tab-list" id="allSettingsSettingsTabList" aria-label="Settings tabs"></aside>
							<section class="app-settings-tab-detail" id="allSettingsSettingsTabDetail" aria-live="polite"></section>
						</div>
					</div>
					<div class="app-form-footer">
						<div class="app-form-actions">
							<button class="admin-logout-btn alt-light" type="button" onclick="closeAddAllSettingsAppPopup()">Cancel</button>
							<button class="admin-logout-btn save-app-btn" type="button" onclick="saveAllSettingsApp()">Save App</button>
						</div>
					</div>
				</div>
			</div>
		</div>

	<!-- Admin Login Popup -->
	<div id="adminLoginPopup" class="popup-overlay">
		<div class="popup-content admin-popup">
			<div class="popup-header">
				<h3>Admin Login</h3>
				<button class="close-btn" onclick="closeAdminPopup('adminLoginPopup')">&times;</button>
			</div>
			<div class="popup-body">
				<p>Sign in with your Google account to access admin panel:</p>
				<div class="google-signin-container">
					<button id="googleSignIn" class="google-signin-btn">
						<img src="https://developers.google.com/identity/images/g-logo.png" alt="Google"/>
						Sign in with Google
					</button>
				</div>
				<div id="loginStatus" class="login-status"></div>
			</div>
		</div>
	</div>

	<!-- Admin Panel Popup -->
	<div id="adminPanelPopup" class="popup-overlay">
		<div class="popup-content admin-popup admin-panel">
			<div class="popup-header">
				<h3>Admin Panel</h3>
				<div class="admin-user-info">
					<span id="adminUserName">Welcome, Admin</span>
					<div style="margin-bottom:10px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
						<button class="admin-logout-btn" onclick="signOut()">Logout</button>
						<button class="admin-logout-btn alt-light" onclick="openColorsPopup()">Edit Colors</button>
						<button class="admin-logout-btn alt-light" onclick="openAllSettingsManager()">Manage All Settings</button>
						<small>Edit global CSS theme variables</small>
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
						<div id="colorEffectCell" style="display:none;"></div>
					</div>
				</div>
				<button class="close-btn" onclick="closeAdminPopup('adminPanelPopup')">&times;</button>
			</div>
			<div class="popup-body admin-panel-body">
				<div class="admin-section">
					<h4>Profile Settings</h4>
					<div class="admin-setting">
						<label for="profilePicture">Profile Picture URL:</label>
						<div class="profile-upload-row">
							<div class="profile-preview empty" id="profilePicturePreview" role="button" tabindex="0" aria-label="Upload profile picture" title="Upload image" onclick="triggerProfileUpload()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();triggerProfileUpload();}">
								<div class="profile-preview-overlay">
									<img src="https://raw.githubusercontent.com/themesberg/flowbite-icons/refs/heads/main/src/outline/general/upload.svg" alt="" class="profile-preview-icon" aria-hidden="true" />
								</div>
							</div>
							<div class="profile-input-stack">
								<input type="url" id="profilePicture" placeholder="https://example.com/image.jpg">
								<button onclick="updateProfilePicture()">Update</button>
							</div>
							<input type="file" id="profilePictureUploadFile" accept="image/*" style="display:none" onchange="handleProfileUploadFile(this)">
						</div>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Name Settings</h4>
					<div class="admin-setting">
						<label for="displayName">Display Name:</label>
						<input type="text" id="displayName" placeholder="ilyambr" maxlength="50">
						<button onclick="updateDisplayName()">Update</button>
						<small>This is shown as your main name on the website</small>
					</div>
					<div class="admin-setting">
						<label for="username">Username:</label>
						<input type="text" id="username" placeholder="@ilyambrr" maxlength="30">
						<button onclick="updateUsername()">Update</button>
						<small>This is your handle/username (include @ if desired)</small>
					</div>
				</div>


				
				<div class="admin-section">
					<h4>Twitch Status</h4>
					<div class="admin-setting">
						<label for="twitchStatus">Twitch Status:</label>
						<select id="twitchStatus" onchange="updateTwitchStatus()">
							<option value="">None</option>
							<option value="affiliate">Affiliate</option>
							<option value="partner">Partner</option>
							<option value="verified">Verified <img src="https://ilyambr.me/img/checkmark.svg" style="width: 12px; height: 12px; margin-left: 4px; filter: invert(1); vertical-align: middle;" alt="✓"></option>
						</select>
						<small>Choose your Twitch account status</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Page Logo Settings</h4>
					<div class="admin-setting page-logo-settings">
						<div class="page-logo-settings-card">
							<div class="page-logo-previews">
								<div class="logo-preview-card large" role="button" tabindex="0" aria-label="Upload large logo" onclick="triggerPageLogoUpload('large')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();triggerPageLogoUpload('large');}">
									<div class="logo-preview-frame" id="pageLogoLargeFrame">
										<img id="pageLogoAdminPreviewLarge" alt="Large logo preview" />
										<span class="logo-preview-placeholder">upload</span>
									</div>
									<div class="logo-preview-caption">Preview - Large Logo</div>
								</div>
								<div class="logo-preview-card small" role="button" tabindex="0" aria-label="Upload small logo" onclick="triggerPageLogoUpload('small')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();triggerPageLogoUpload('small');}">
									<div class="logo-preview-frame" id="pageLogoSmallFrame">
										<img id="pageLogoAdminPreviewSmall" alt="Small logo preview" />
										<span class="logo-preview-placeholder">upload</span>
									</div>
									<div class="logo-preview-caption">Preview - Small Logo</div>
								</div>
							</div>
							<div class="page-logo-meta">
								<div class="page-logo-meta-fields">
									<input type="text" id="pageLogoResolution" placeholder="1920x1080" title="Large logo source resolution (e.g., 1920x1080)">
									<input type="text" id="pageLogoSize" placeholder="135x135" title="Small logo display size (widthxheight in px)">
								</div>
								<label class="logo-invert-toggle" for="logoInvertToggle">
									<input type="checkbox" id="logoInvertToggle" checked onchange="updateLogoInvert()">
									<span>Invert Logo (white on dark background)</span>
								</label>
								<div class="page-logo-actions">
									<button type="button" onclick="updatePageLogo()">Update Logo</button>
								</div>
							</div>
						</div>
						<input type="hidden" id="pageLogoLarge">
						<input type="hidden" id="pageLogoSmall">
						<input type="file" id="pageLogoLargeUploadFile" accept="image/*" style="display:none" onchange="handlePageLogoUploadFile(this, 'large')">
						<input type="file" id="pageLogoSmallUploadFile" accept="image/*" style="display:none" onchange="handlePageLogoUploadFile(this, 'small')">
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Bio & About Settings</h4>
					<div class="admin-setting">
						<label for="bioTextInput">Bio:</label>
						<input type="text" id="bioTextInput" placeholder="just give me a year max....." maxlength="100">
						<button onclick="updateBio()">Update</button>
						<small>Short bio text under your name</small>
					</div>
					<div class="admin-setting">
						<label for="aboutText">About Me:</label>
						<textarea id="aboutText" placeholder="i make stuff, i stream, that's it really..." maxlength="100" rows="3"></textarea>
						<button onclick="updateAboutText()">Update</button>
						<small>About section description</small>
					</div>
					<div class="admin-setting">
						<label for="streamingYear">Started Streaming Year:</label>
						<input type="number" id="streamingYear" placeholder="2024" min="2000" max="2030">
						<button onclick="updateStreamingYear()">Update</button>
						<small>Year you started streaming</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Stats Settings</h4>
					<div class="admin-setting">
						<label for="followerCount">Twitch Followers:</label>
						<input type="number" id="followerCount" placeholder="1234" min="0">
						<button onclick="updateFollowerCount()">Update</button>
						<small>Custom follower count (leave empty for API)</small>
					</div>
					<div class="admin-setting">
						<label for="subscriberCount">YouTube Subscribers:</label>
						<input type="number" id="subscriberCount" placeholder="5678" min="0">
						<button onclick="updateSubscriberCount()">Update</button>
						<small>Custom subscriber count (leave empty for API)</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Social Links</h4>
					<div class="admin-setting">
						<label for="twitchLink">Twitch URL:</label>
						<input type="url" id="twitchLink" placeholder="https://twitch.tv/ilyambrr">
						<button onclick="updateTwitchLink()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="youtubeLink">YouTube URL:</label>
						<input type="url" id="youtubeLink" placeholder="https://www.youtube.com/@ilyambr">
						<button onclick="updateYouTubeLink()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="tiktokLink">TikTok URL:</label>
						<input type="url" id="tiktokLink" placeholder="https://www.tiktok.com/@ilyambr_">
						<button onclick="updateTikTokLink()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="instagramLink">Instagram URL:</label>
						<input type="url" id="instagramLink" placeholder="https://www.instagram.com/ilyambr">
						<button onclick="updateInstagramLink()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="xLink">X (Twitter) URL:</label>
						<input type="url" id="xLink" placeholder="https://x.com/ilyambr">
						<button onclick="updateXLink()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="redditLink">Reddit URL:</label>
						<input type="url" id="redditLink" placeholder="https://reddit.com/u/ilyambr">
						<button onclick="updateRedditLink()">Update</button>
					</div>
				</div>

				<div class="admin-section">
					<h4>Twitch Player Settings</h4>
					<div class="admin-setting">
						<label for="twitchChannel">Player Channel Name:</label>
						<input type="text" id="twitchChannel" placeholder="ilyambrr" maxlength="50">
						<button onclick="updateTwitchChannel()">Update</button>
						<small>Updates the embedded Twitch player. Enter just the username, no URL or @.</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Action Buttons</h4>
					<div class="admin-setting">
						<label for="followButtonText">Follow Button Text:</label>
						<input type="text" id="followButtonText" placeholder="Follow" maxlength="20">
						<button onclick="updateFollowButton()">Update</button>
					</div>
					<div class="admin-setting">
						<label for="subscribeButtonText">Subscribe Button Text:</label>
						<input type="text" id="subscribeButtonText" placeholder="Subscribe" maxlength="20">
						<button onclick="updateSubscribeButton()">Update</button>
					</div>
				</div>

				<!-- Follow popup links management (inside panel) -->
				<div class="admin-section">
					<h4>Follow Popup Links</h4>
					<div class="admin-setting">
						<div style="display:flex; gap:10px; align-items:center;">
							<input type="text" id="followAddHelper" placeholder="Use Add to choose logo, name, and link" disabled style="flex:1; opacity:.7;">
							<button onclick="openAddActionLinkPopup('follow')">Add</button>
							<button style="background: rgba(255,59,107,0.2); border-color: rgba(255,59,107,0.3);" onclick="clearActionLinks('follow')">Clear All</button>
						</div>
						<div id="followLinksList" style="margin-top:8px;"></div>
						<small>Manage the links shown in the Follow popup.</small>
					</div>
				</div>

				<!-- Subscribe popup links management (inside panel) -->
				<div class="admin-section">
					<h4>Subscribe Popup Links</h4>
					<div class="admin-setting">
						<div style="display:flex; gap:10px; align-items:center;">
							<input type="text" id="subscribeAddHelper" placeholder="Use Add to choose logo, name, and link" disabled style="flex:1; opacity:.7;">
							<button onclick="openAddActionLinkPopup('subscribe')">Add</button>
							<button style="background: rgba(255,59,107,0.2); border-color: rgba(255,59,107,0.3);" onclick="clearActionLinks('subscribe')">Clear All</button>
						</div>
						<div id="subscribeLinksList" style="margin-top:8px;"></div>
						<small>Manage the links shown in the Subscribe popup.</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Schedule Settings</h4>
					<div class="admin-setting">
						<label for="streamDay1">First Stream Day:</label>
						<div style="display: flex; gap: 10px; align-items: center;">
							<select id="streamDay1" style="flex: 1;">
								<option value="0">Sunday</option>
								<option value="1">Monday</option>
								<option value="2">Tuesday</option>
								<option value="3">Wednesday</option>
								<option value="4">Thursday</option>
								<option value="5">Friday</option>
								<option value="6" selected>Saturday</option>
							</select>
							<input type="text" id="streamTime1" placeholder="5:00PM" style="flex: 1;">
							<select id="streamDateMode1" style="flex: 1;">
								<option value="auto">Auto (Next Week)</option>
								<option value="custom">Custom Date</option>
							</select>
							<input type="date" id="streamCustomDate1" style="flex: 1; display: none;">
						</div>
						<button onclick="updateStreamSchedule(1)">Update</button>
						<small>Choose day of week, time (e.g., 5:00PM), and date mode</small>
					</div>
					<div class="admin-setting">
						<label for="streamDay2">Second Stream Day:</label>
						<div style="display: flex; gap: 10px; align-items: center;">
							<select id="streamDay2" style="flex: 1;">
								<option value="0" selected>Sunday</option>
								<option value="1">Monday</option>
								<option value="2">Tuesday</option>
								<option value="3">Wednesday</option>
								<option value="4">Thursday</option>
								<option value="5">Friday</option>
								<option value="6">Saturday</option>
							</select>
							<input type="text" id="streamTime2" placeholder="6:00PM" style="flex: 1;">
							<select id="streamDateMode2" style="flex: 1;">
								<option value="auto">Auto (Next Week)</option>
								<option value="custom">Custom Date</option>
							</select>
							<input type="date" id="streamCustomDate2" style="flex: 1; display: none;">
						</div>
						<button onclick="updateStreamSchedule(2)">Update</button>
						<small>Choose day of week, time (e.g., 6:00PM), and date mode</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Discord Settings</h4>
					<div class="admin-setting">
						<label for="discordLink">Discord Invite Link:</label>
						<input type="url" id="discordLink" placeholder="https://discord.gg/YourInviteCode or any link">
						<button onclick="updateDiscordLink()">Update</button>
						<small>Enter any Discord link or URL</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Background Settings</h4>
					<div class="admin-setting">
						<label for="backgroundImage">Background Image URL:</label>
						<div style="display:flex; gap:10px; align-items:center;">
							<input type="url" id="backgroundImage" placeholder="https://example.com/background.jpg" style="flex:1;">
							<div role="button" title="Upload image" onclick="triggerBackgroundUpload()" style="width:42px; height:42px; min-width:42px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); background: rgba(255,255,255,0.05); border-radius:8px; cursor:pointer;">
								<img src="https://raw.githubusercontent.com/themesberg/flowbite-icons/refs/heads/main/src/outline/general/upload.svg" alt="Upload" style="width:22px; height:22px; filter: invert(1); opacity:0.9;" />
							</div>
							<button onclick="updateBackgroundImage()">Update</button>
							<input type="file" id="backgroundImageUploadFile" accept="image/*" style="display:none" onchange="handleBackgroundUploadFile(this)">
						</div>
					</div>
				</div>

				<div class="admin-section">
					<h4>Theme Tint</h4>
					<div class="admin-setting">
						<label>Background Tint:</label>
						<div style="display:grid; gap:10px;">
							<select id="tintMode" style="max-width:220px;">
								<option value="none">None</option>
								<option value="solid">Solid Color</option>
								<option value="gradient">Gradient</option>
							</select>
							<div id="tintSolidRow" style="display:none; gap:10px; align-items:center;">
								<input type="color" id="tintColor1" value="#9146ff">
								<input type="range" id="tintOpacity" min="0" max="100" value="35" title="Opacity %">
							</div>
							<div id="tintGradientRow" style="display:none; gap:10px; align-items:center;">
								<input type="color" id="tintColorG1" value="#9146ff">
								<input type="color" id="tintColorG2" value="#3a86ff">
								<select id="tintDirection" style="max-width:140px;">
									<option value="to bottom">To Bottom</option>
									<option value="to right">To Right</option>
									<option value="135deg">135°</option>
									<option value="225deg">225°</option>
								</select>
								<input type="range" id="tintOpacityG" min="0" max="100" value="35" title="Opacity %">
							</div>
							<button onclick="applyThemeTint()">Apply Tint</button>
							<button onclick="saveThemeTint()" style="background: linear-gradient(90deg, #00d2d3, #54a0ff);">Save Tint Globally</button>
						</div>
						<small>Applies a color overlay on top of the background image (tints the image too).</small>
					</div>
				</div>

				<div class="admin-section">
					<h4>Collaborators</h4>
					<div class="admin-setting">
						<label for="collabEmail">Add collaborator email:</label>
						<div style="display:flex; gap:10px; align-items:center;">
							<input type="email" id="collabEmail" placeholder="user@example.com" style="flex:1;">
							<button onclick="addCollaborator()">Add</button>
						</div>
						<div id="collabList" style="margin-top:8px;"></div>
						<small>Collaborators can access the admin panel with Google Sign-In. Owner email is fixed.</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>YouTube Settings</h4>
					<div class="admin-setting">
						<label for="youtubeVideoId">YouTube Video ID:</label>
						<input type="text" id="youtubeVideoId" placeholder="dQw4w9WgXcQ">
						<button onclick="updateYouTubeVideo()">Update</button>
						<small>Enter just the video ID from the YouTube URL</small>
					</div>
				</div>

				<div class="admin-section">
					<h4>Featured Short Video</h4>
					<div class="admin-setting">
						<label for="shortVideoLink">Short Video Link:</label>
						<div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
							<input type="url" id="shortVideoLink" placeholder="https://www.youtube.com/shorts/... or https://www.tiktok.com/@user/video/..." style="flex:1 1 260px;">
							<button onclick="updateShortVideoEmbed()">Save</button>
							<button style="background: rgba(255,59,107,0.2); border-color: rgba(255,59,107,0.3);" onclick="clearShortVideoEmbed()">Clear</button>
						</div>
						<small>Supports YouTube Shorts and TikTok links. We'll convert the link to an embed automatically.</small>
					</div>
				</div>
				
				<div class="admin-section">
					<h4>Current Settings</h4>
					<div class="current-settings">
						<p><strong>Display Name:</strong> <span id="currentDisplayName">N/A</span></p>
						<p><strong>Username:</strong> <span id="currentUsername">N/A</span></p>
						<p><strong>Bio:</strong> <span id="currentBio">N/A</span></p>
						<p><strong>About Text:</strong> <span id="currentAboutText">N/A</span></p>
						<p><strong>Streaming Year:</strong> <span id="currentStreamingYear">N/A</span></p>
						<p><strong>Page Logo:</strong> <span id="currentPageLogo">N/A</span></p>
						<p><strong>Page Logo (Small):</strong> <span id="currentPageLogoSmall">N/A</span></p>
						<p><strong>Twitch Status:</strong> <span id="currentTwitchStatus">None</span></p>
						<p><strong>Twitch Channel:</strong> <span id="currentTwitchChannel">ilyambrr</span></p>
						<p><strong>Follower Count:</strong> <span id="currentFollowerCount">API</span></p>
						<p><strong>Subscriber Count:</strong> <span id="currentSubscriberCount">API</span></p>
						<p><strong>Discord Link:</strong> <span id="currentDiscordLink">N/A</span></p>
						<p><strong>Profile Picture:</strong> <span id="currentProfilePic">N/A</span></p>
						<p><strong>Background:</strong> <span id="currentBackground">N/A</span></p>
						<p><strong>YouTube Video:</strong> <span id="currentYouTubeVideo">N/A</span></p>
						<p><strong>Short Video:</strong> <span id="currentShortVideo">None</span></p>
						<p><strong>Firebase Database:</strong> <span id="currentFirebaseUrl">Loading...</span></p>
					</div>
					
					<div class="admin-setting">
						<h3>🔥 Firebase Database Settings</h3>
						<label for="firebaseDatabaseUrl">Database URL:</label>
						<div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
							<input type="text" id="firebaseDatabaseUrl" placeholder="https://your-project-default-rtdb.firebaseio.com" style="flex:2; min-width:260px;" />
							<select id="firebaseSiteName" style="flex:1; min-width:180px; max-width:240px;">
								<option value="auto">Auto (this host)</option>
								<option value="ilyambr.me">ilyambr.me</option>
								<option value="behindthebonnet.me">behindthebonnet.me</option>
								<option value="localhost">localhost</option>
								<option value="custom">Custom…</option>
							</select>
							<input type="text" id="firebaseSiteCustom" placeholder="example.com" style="flex:1; min-width:180px; max-width:240px; display:none;" />
							<button onclick="updateFirebaseDatabase()">Add to History</button>
						</div>
						<div id="firebaseDbHistory" style="margin-top:8px;"></div>
						<div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 12px;">
							<strong>ℹ️ Note:</strong> Adding to history does NOT switch immediately. Click "Activate" on an entry below to apply it for everyone. Activation reloads the page.<br>
							<strong>🔐 Security:</strong> History and active selection are stored in Firebase; your browser stores only an encrypted copy of the active URL after activation.
						</div>
					</div>
					
					<div class="admin-setting">
						<h3>🎨 Website Effects</h3>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="colorEffectToggle" onchange="toggleColorEffect()">
									<span>🌈 Color Effect</span>
								</label>
								<div id="colorHueRow" style="display:flex; align-items:center; gap:8px; margin-top:8px; padding-left:26px;">
									<input type="range" id="colorHueSlider" min="0" max="360" value="45" oninput="updateColorHue(this.value)" style="flex:1;">
									<input type="number" id="colorHueInput" min="0" max="360" value="45" oninput="updateColorHue(this.value)" style="width:70px; padding:6px 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 8px;">
								</div>
							</div>
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="grayscaleToggle" onchange="toggleGrayscale()">
									<span>⚫ Grayscale</span>
								</label>
							</div>
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="blurToggle" checked onchange="toggleBlur()">
									<span>🌫️ Blur Background</span>
								</label>
							</div>
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="sepiaToggle" onchange="toggleSepia()">
									<span>📸 Sepia Effect</span>
								</label>
							</div>
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="invertToggle" onchange="toggleInvert()">
									<span>🔄 Invert Colors</span>
								</label>
							</div>
							<div>
								<label style="display: flex; align-items: center; gap: 8px;">
									<input type="checkbox" id="brightnessToggle" onchange="toggleBrightness()">
									<span>☀️ High Brightness</span>
								</label>
							</div>
						</div>
						<div style="display: flex; gap: 10px;">
							<button onclick="resetAllEffects()" style="background: linear-gradient(90deg, #ff6b6b, #ee5a24); flex: 1;">
								Reset All Effects
							</button>
							<button onclick="saveEffectsGlobally()" style="background: linear-gradient(90deg, #00d2d3, #54a0ff); flex: 1;">
								Save Effects Globally
							</button>
						</div>
					</div>
					
					<div class="admin-setting" style="margin-top: 15px;">
						<button onclick="resetToDefaults()" style="background: linear-gradient(90deg, #ff4757, #ff3838); border-color: rgba(255, 71, 87, 0.3);">
							Reset All to Defaults
						</button>
					</div>
					</div>
				</div>
			</div>

	<!-- Add Action Link Popup -->
	<div id="actionLinkPopup" class="popup-overlay">
		<div class="popup-content">
			<div class="popup-header">
				<h3 id="actionLinkPopupTitle">Add Link</h3>
				<button class="close-btn" onclick="closePopup('actionLinkPopup')">&times;</button>
			</div>
			<div class="popup-body">
				<div class="admin-setting" style="gap:12px;">
					<label>Logo image:</label>
					<input type="file" id="actionLogoFile" accept="image/*" onchange="handleActionLogoFile(this)">
					<div id="actionLogoPreviewWrap" style="display:none; align-items:center; gap:10px;">
						<img id="actionLogoPreview" alt="Logo preview" style="width:40px; height:40px; object-fit:contain; background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:8px;" />
						<small>Preview</small>
					</div>
					<label style="display:flex; align-items:center; gap:8px; user-select:none;">
						<input type="checkbox" id="actionLogoInvert" />
						<span>Invert logo in popup</span>
					</label>
					<label for="actionLinkName">Name:</label>
					<input type="text" id="actionLinkName" placeholder="Follow on Twitch" maxlength="40">
					<label for="actionLinkUrl">Link URL:</label>
					<input type="url" id="actionLinkUrl" placeholder="https://example.com/your-link">
					<div style="display:flex; gap:10px; margin-top:10px;">
						<button onclick="saveActionLinkFromPopup()">Save</button>
						<button style="background:rgba(255,255,255,0.08)" onclick="closePopup('actionLinkPopup')">Cancel</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function openPopup(popupId) {
			document.getElementById(popupId).style.display = 'flex';
			setBodyScrollState(true);
		}

		function closePopup(popupId) {
			document.getElementById(popupId).style.display = 'none';
			setBodyScrollState(false);
		}

		// Colors Editor
		const COLOR_VARS = [
			{ key: '--bg-1', type: 'hex' },
			{ key: '--bg-2', type: 'hex' },
			{ key: '--twitch', type: 'hex' },
			{ key: '--twitch-2', type: 'hex' },
			{ key: '--pink', type: 'hex' },
			{ key: '--cyan', type: 'hex' },
			{ key: '--glow', type: 'hex' },
			{ key: '--text', type: 'hex' },
			{ key: '--muted', type: 'hex' },
			{ key: '--card', type: 'hex' },
			{ key: '--glass', type: 'rgba' },
			{ key: '--border', type: 'rgba' },
			{ key: '--button-glow', type: 'rgba' },
			{ key: '--accent', type: 'hex' },
			{ key: '--accent-hover', type: 'hex' },
			{ key: '--accent-contrast', type: 'hex' },
			{ key: '--surface-overlay', type: 'rgba' },
			{ key: '--surface-overlay-hover', type: 'rgba' },
			{ key: '--surface-button', type: 'rgba' },
			{ key: '--surface-button-border', type: 'rgba' },
			{ key: '--surface-button-hover', type: 'rgba' },
			{ key: '--surface-button-border-hover', type: 'rgba' },
			{ key: '--text-subtle', type: 'rgba' },
			{ key: '--text-stronger', type: 'rgba' },
			{ key: '--danger-overlay', type: 'rgba' },
			{ key: '--danger-overlay-hover', type: 'rgba' },
			{ key: '--danger-border', type: 'rgba' },
			{ key: '--success-main', type: 'hex' },
			{ key: '--success-bg', type: 'rgba' },
			{ key: '--success-border-strong', type: 'rgba' },
			{ key: '--success-border', type: 'rgba' },
			{ key: '--success-shadow', type: 'rgba' },
			{ key: '--info-main', type: 'hex' },
			{ key: '--info-bg', type: 'rgba' },
			{ key: '--info-border-strong', type: 'rgba' },
			{ key: '--info-border', type: 'rgba' },
			{ key: '--info-shadow', type: 'rgba' },
			{ key: '--warning-main', type: 'hex' },
			{ key: '--warning-bg', type: 'rgba' },
			{ key: '--warning-border-strong', type: 'rgba' },
			{ key: '--warning-border', type: 'rgba' },
			{ key: '--warning-shadow', type: 'rgba' },
			{ key: '--error-main', type: 'hex' },
			{ key: '--error-bg', type: 'rgba' },
			{ key: '--error-border-strong', type: 'rgba' },
			{ key: '--error-border', type: 'rgba' },
			{ key: '--error-shadow', type: 'rgba' },
			{ key: '--error-strong', type: 'rgba' },
			{ key: '--settings-section-bg-start', type: 'rgba' },
			{ key: '--settings-section-bg-end', type: 'rgba' },
			{ key: '--settings-section-border', type: 'rgba' },
			{ key: '--settings-section-heading', type: 'rgba' },
			{ key: '--settings-section-row-label', type: 'rgba' },
			{ key: '--settings-section-row-value', type: 'rgba' },
			{ key: '--settings-section-placeholder', type: 'rgba' }
		];

		function getCssVar(key) {
			return getComputedStyle(document.documentElement).getPropertyValue(key).trim();
		}
		function setCssVar(key, value) {
			document.documentElement.style.setProperty(key, value);
		}

		// --- Color helpers ---
		function clampByte(n){ n = Number(n); if (isNaN(n)) return 0; return Math.max(0, Math.min(255, Math.round(n))); }
		function clampAlpha(a){ a = Number(a); if (isNaN(a)) return 1; return Math.max(0, Math.min(1, a)); }
		function rgbToHex(r,g,b){
			const toHex = (x) => x.toString(16).padStart(2,'0');
			return '#' + toHex(clampByte(r)) + toHex(clampByte(g)) + toHex(clampByte(b));
		}
		function hexToRgb(hex){
			if (!hex) return {r:0,g:0,b:0,a:1};
			hex = hex.trim();
			if (hex[0] === '#') hex = hex.slice(1);
			if (hex.length === 3){
				const r = parseInt(hex[0]+hex[0],16);
				const g = parseInt(hex[1]+hex[1],16);
				const b = parseInt(hex[2]+hex[2],16);
				return {r,g,b,a:1};
			}
			if (hex.length >= 6){
				const r = parseInt(hex.slice(0,2),16);
				const g = parseInt(hex.slice(2,4),16);
				const b = parseInt(hex.slice(4,6),16);
				return {r,g,b,a:1};
			}
			return {r:0,g:0,b:0,a:1};
		}
		function parseCssColor(val){
			if (!val) return {r:0,g:0,b:0,a:1};
			val = (''+val).trim();
			if (val.startsWith('#')) return hexToRgb(val);
			const mRgba = val.match(/^rgba\(([^)]+)\)$/i);
			if (mRgba){
				const parts = mRgba[1].split(',').map(s=>s.trim());
				return { r: clampByte(parts[0]), g: clampByte(parts[1]), b: clampByte(parts[2]), a: clampAlpha(parts[3]) };
			}
			const mRgb = val.match(/^rgb\(([^)]+)\)$/i);
			if (mRgb){
				const parts = mRgb[1].split(',').map(s=>s.trim());
				return { r: clampByte(parts[0]), g: clampByte(parts[1]), b: clampByte(parts[2]), a: 1 };
			}
			return hexToRgb(val);
		}
		function buildCssFromType(type, hexOrRgb, keepAlphaFrom){
			if (type === 'rgba'){
				const rgb = typeof hexOrRgb === 'string' ? hexToRgb(hexOrRgb) : hexOrRgb;
				let a = 1;
				if (keepAlphaFrom){
					const p = parseCssColor(keepAlphaFrom);
					a = clampAlpha(p.a);
				}
				return `rgba(${clampByte(rgb.r)}, ${clampByte(rgb.g)}, ${clampByte(rgb.b)}, ${a})`;
			}
			// hex
			if (typeof hexOrRgb === 'string') return hexOrRgb;
			return rgbToHex(hexOrRgb.r, hexOrRgb.g, hexOrRgb.b);
		}
		function openColorsPopup() {
			const list = document.getElementById('colorsList');
			if (!list) return;
			list.innerHTML = '';
			COLOR_VARS.forEach(v => {
				const row = document.createElement('div');
				row.style.display = 'grid';
				row.style.gridTemplateColumns = '160px 1fr 110px';
				row.style.gap = '10px';
				row.dataset.keepColor = 'true';
				const label = document.createElement('label');
				label.textContent = v.key;
				label.style.color = 'var(--muted)';
				label.dataset.keepColor = 'true';
				const input = document.createElement('input');
				input.type = 'text';
				input.value = getCssVar(v.key);
				input.style.background = 'rgba(255,255,255,0.05)';
				input.style.border = '1px solid var(--border)';
				input.style.color = 'var(--text)';
				input.style.borderRadius = '8px';
				input.dataset.keepColor = 'true';
				input.oninput = (e) => {
					setCssVar(v.key, e.target.value);
					// keep color input in sync if user types a value
					const typed = (e.target.value || '').trim();
					try {
						const rgb = parseCssColor(typed);
						color.value = rgbToHex(rgb.r, rgb.g, rgb.b);
						preview.style.background = typed;
					} catch {}
				};
				const preview = document.createElement('div');
				preview.style.height = '34px';
				preview.style.border = '1px solid var(--border)';
				preview.style.borderRadius = '6px';
				preview.style.background = getCssVar(v.key);
				preview.style.cursor = 'pointer';
				preview.title = 'Click to pick color';
				preview.dataset.keepColor = 'true';
				preview.tabIndex = 0;
				preview.setAttribute('role', 'button');
				preview.setAttribute('aria-label', `Pick color for ${v.key}`);

				// hidden color input to open the native picker
				const color = document.createElement('input');
				color.type = 'color';
				color.style.position = 'fixed';
				color.style.left = '16px';
				color.style.top = '16px';
				color.style.width = '1px';
				color.style.height = '1px';
				color.style.opacity = '0';
				color.style.pointerEvents = 'none';
				color.setAttribute('tabindex', '-1');
				color.setAttribute('aria-hidden', 'true');
				color.dataset.keepColor = 'true';
				// initialize color input from current value (convert to hex, ignore alpha)
				try {
					const rgb = parseCssColor(input.value);
					color.value = rgbToHex(rgb.r, rgb.g, rgb.b);
				} catch { color.value = '#ffffff'; }

				const openPicker = () => {
					if (typeof color.focus === 'function') {
						try {
							color.focus({ preventScroll: true });
						} catch {
							color.focus();
						}
					}
					color.click();
				};
				preview.addEventListener('click', openPicker);
				preview.addEventListener('keydown', event => {
					if (event.key === 'Enter' || event.key === ' ') {
						event.preventDefault();
						openPicker();
					}
				});
				color.addEventListener('blur', () => {
					if (typeof preview.focus === 'function') {
						try {
							preview.focus({ preventScroll: true });
						} catch {
							preview.focus();
						}
					}
				});
				color.addEventListener('input', () => {
					const pickedHex = color.value; // #rrggbb
					if (v.type === 'hex') {
						setCssVar(v.key, pickedHex);
						input.value = pickedHex;
						preview.style.background = pickedHex;
					} else {
						// rgba: preserve current alpha, update rgb
						const current = (input.value || getCssVar(v.key) || '').trim();
						const newCss = buildCssFromType('rgba', pickedHex, current);
						setCssVar(v.key, newCss);
						input.value = newCss;
						preview.style.background = newCss;
					}
				});
				const syncPreview = () => { preview.style.background = input.value; };
				input.addEventListener('input', syncPreview);
				row.appendChild(label); row.appendChild(input); row.appendChild(preview);
				row.appendChild(color);
				list.appendChild(row);
			});
			openPopup('colorsPopup');
		}

		async function saveColorsToDb() {
			const payload = {};
			COLOR_VARS.forEach(v => { payload[v.key] = getCssVar(v.key); });
			await saveGlobalSetting('siteColors', JSON.stringify(payload));
			notify.success('Colors saved globally for all visitors.');
		}

		async function resetColorsToDefaults() {
			const confirmed = await showConfirm('Reset colors to defaults?', {
				title: 'Reset site colors',
				confirmText: 'Reset colors',
				cancelText: 'Keep current',
				type: 'warning'
			});
			if (!confirmed) return;
			// defaults align with current CSS at top
			const defaults = {
				'--bg-1':'#0b0b12','--bg-2':'#0e0b1a','--twitch':'#3a3a3a','--twitch-2':'#777777','--pink':'#666666','--cyan':'#888888','--glow':'#9a9a9a',
				'--text':'#e8e8f0','--muted':'#b8b8c7','--card':'#121226cc','--glass':'rgba(18,18,38,0.55)','--border':'rgba(255,255,255,0.08)',
				'--button-glow':'rgba(145,70,255,0.35)','--accent':'#63a4ff','--accent-hover':'#7ab4ff','--accent-contrast':'#0c1424',
				'--surface-overlay':'rgba(255,255,255,0.05)','--surface-overlay-hover':'rgba(255,255,255,0.12)','--surface-button':'rgba(255,255,255,0.08)',
				'--surface-button-border':'rgba(255,255,255,0.16)','--surface-button-hover':'rgba(255,255,255,0.16)','--surface-button-border-hover':'rgba(255,255,255,0.22)',
				'--text-subtle':'rgba(255,255,255,0.6)','--text-stronger':'rgba(255,255,255,0.75)','--danger-overlay':'rgba(255,59,107,0.2)',
				'--danger-overlay-hover':'rgba(255,59,107,0.3)','--danger-border':'rgba(255,59,107,0.3)','--success-main':'#49c977',
				'--success-bg':'rgba(73,201,119,0.15)','--success-border-strong':'rgba(73,201,119,0.4)','--success-border':'rgba(73,201,119,0.35)',
				'--success-shadow':'rgba(73,201,119,0.25)','--info-main':'#73b7ff','--info-bg':'rgba(111,182,255,0.15)',
				'--info-border-strong':'rgba(111,182,255,0.4)','--info-border':'rgba(111,182,255,0.3)','--info-shadow':'rgba(111,182,255,0.2)',
				'--warning-main':'#fdc45a','--warning-bg':'rgba(253,196,90,0.18)','--warning-border-strong':'rgba(253,196,90,0.45)',
				'--warning-border':'rgba(253,196,90,0.35)','--warning-shadow':'rgba(253,196,90,0.22)','--error-main':'#ff6b81',
				'--error-bg':'rgba(255,107,129,0.18)','--error-border-strong':'rgba(255,107,129,0.45)','--error-border':'rgba(255,107,129,0.35)',
				'--error-shadow':'rgba(255,107,129,0.25)','--error-strong':'rgba(255,107,129,0.6)',
				'--settings-section-bg-start':'rgba(20,24,46,0.86)','--settings-section-bg-end':'rgba(12,14,28,0.94)',
				'--settings-section-border':'rgba(132,164,255,0.16)','--settings-section-heading':'rgba(173,222,255,0.86)',
				'--settings-section-row-label':'rgba(174,205,255,0.72)','--settings-section-row-value':'rgba(255,255,255,0.96)',
				'--settings-section-placeholder':'rgba(186,204,232,0.66)'
			};
			Object.entries(defaults).forEach(([k,v])=>setCssVar(k,v));
			await saveGlobalSetting('siteColors', JSON.stringify(defaults));
			notify.success('Colors reset to the default palette for everyone.');
		}

		// Close popup when clicking outside
		window.onclick = function(event) {
			const followPopup = document.getElementById('followPopup');
			const subscribePopup = document.getElementById('subscribePopup');
			if (event.target == followPopup) {
				closePopup('followPopup');
			}
			if (event.target == subscribePopup) {
				closePopup('subscribePopup');
			}
		}

		// Close popup with Escape key
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closePopup('followPopup');
				closePopup('subscribePopup');
				closePopup('actionLinkPopup');
			}
		});
	</script>
	<script>
		let youtubeVideoLoaded = false;
		
		function switchStream(platform) {
			const twitchEmbed = document.getElementById('twitch-embed');
			const youtubeEmbed = document.getElementById('youtube-embed');
			const switches = document.querySelectorAll('.stream-switch');
			const thumbContainer = document.querySelector('.thumb');
			const heading = document.querySelector('.stream-header h3');
			
			// Update switch states
			switches.forEach(sw => sw.classList.remove('active'));
			event.target.classList.add('active');
			
			if (platform === 'twitch') {
				twitchEmbed.classList.remove('hidden');
				youtubeEmbed.classList.add('hidden');
				thumbContainer.classList.remove('hide-live'); // Show LIVE badge
				heading.textContent = 'Recent Streams'; // Change text to streams
			} else if (platform === 'youtube') {
				twitchEmbed.classList.add('hidden');
				youtubeEmbed.classList.remove('hidden');
				thumbContainer.classList.add('hide-live'); // Hide LIVE badge
				heading.textContent = 'Recent Videos'; // Change text to videos
				
				// Load YouTube video if not already loaded
				if (!youtubeVideoLoaded) {
					loadLatestYouTubeVideo();
					youtubeVideoLoaded = true;
				}
			}
		}
		
		async function loadLatestYouTubeVideo() {
			try {
				// Use the same API approach that works for subscriber count
				const obfuscatedApiKey = 'Jh1UYtWS4gzcTpHZHRDWMJjUIhzVmVmQPJle5MEZnhmQ5NVY6lUQ';
				const apiKey = decode(obfuscatedApiKey);
				const channelId = 'UCIT9_QQpyUP2zg_39sLFb8Q';
				
				const response = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${apiKey}&channelId=${channelId}&part=snippet&order=date&maxResults=1&type=video`);
				
				if (!response.ok) {
					throw new Error('YouTube API request failed');
				}
				
				const data = await response.json();
				console.log('YouTube video data:', data);
				
				if (data.items && data.items.length > 0) {
					const videoId = data.items[0].id.videoId;
					const youtubeEmbed = document.getElementById('youtube-embed');
					
					// Use the same iframe format as admin panel with all specified parameters
					youtubeEmbed.outerHTML = `
						<iframe 
							id="youtube-embed"
							class="embed-frame hidden" 
							width="100%" 
							height="100%" 
							src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=0&controls=1&cc_load_policy=0&enablejsapi=0&fs=1&hd=1&iv_load_policy=3&modestbranding=1&playsinline=1&rel=0&vq=hd1080" 
							frameborder="0" 
							allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
							allowfullscreen>
						</iframe>
					`;
					console.log('✅ Loaded latest video ID:', videoId);
					youtubeVideoLoaded = true; // Mark as loaded
				} else {
					console.log('No YouTube videos found');
					const youtubeEmbed = document.getElementById('youtube-embed');
					youtubeEmbed.src = 'about:blank';
				}
			} catch (error) {
				console.error('Error loading YouTube video:', error);
				const youtubeEmbed = document.getElementById('youtube-embed');
				youtubeEmbed.src = 'about:blank';
			}
		}
	</script>

	<script>
		// Simple encryption/decryption functions for Firebase URL
		function encryptUrl(url) {
			// Simple Base64 encoding with additional obfuscation
			const encoded = btoa(url);
			return encoded.split('').reverse().join('') + 'fb_enc';
		}
		
		function decryptUrl(encryptedUrl) {
			try {
				if (!encryptedUrl.endsWith('fb_enc')) return null;
				const reversed = encryptedUrl.slice(0, -6).split('').reverse().join('');
				return atob(reversed);
			} catch (e) {
				return null;
			}
		}
		
		// Firebase Configuration (from your Firebase project)
		// Check for encrypted custom database URL in localStorage
		const encryptedUrl = localStorage.getItem('encryptedFirebaseUrl');
		const customDatabaseUrl = encryptedUrl ? decryptUrl(encryptedUrl) : null;
		const defaultDatabaseUrl = "https://ilyambr-45403-default-rtdb.firebaseio.com";

		const notificationCenterEl = (() => {
			const existing = document.getElementById('notificationCenter');
			if (existing) {
				return existing;
			}
			const node = document.createElement('div');
			node.id = 'notificationCenter';
			node.className = 'notification-center';
			node.setAttribute('aria-live', 'polite');
			node.setAttribute('aria-atomic', 'true');
			document.body.appendChild(node);
			return node;
		})();

		const notificationIcons = {
			info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><line x1="12" y1="8" x2="12" y2="12"></line><circle cx="12" cy="16" r="0.9"></circle></svg>',
			success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="9"></circle></svg>',
			warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v5"></path><circle cx="12" cy="17" r="0.9"></circle><path d="M12 3l9 16H3z"></path></svg>',
			error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>'
		};

		function showNotification(message, options = {}) {
			if (!notificationCenterEl) return null;

			const {
				title = null,
				type = 'info',
				duration = 4500,
				sticky = false,
				actions = [],
				role = 'status',
				onClose = null
			} = options;

			const card = document.createElement('div');
			card.className = `notification-card notification-${type}`;
			card.setAttribute('role', role);
			card.setAttribute('tabindex', '-1');
			if (!title && (!actions || actions.length === 0)) {
				card.classList.add('single-line');
			}

			const iconWrap = document.createElement('div');
			iconWrap.className = 'notification-icon';
			iconWrap.innerHTML = notificationIcons[type] || notificationIcons.info;

			const textWrap = document.createElement('div');
			textWrap.className = 'notification-text';

			if (title) {
				const titleEl = document.createElement('div');
				titleEl.className = 'notification-title';
				titleEl.textContent = title;
				textWrap.appendChild(titleEl);
			}

			const messageEl = document.createElement('div');
			messageEl.className = 'notification-message';
			messageEl.textContent = message;
			textWrap.appendChild(messageEl);

			let dismissTimer = null;
			let closed = false;

			const dismiss = () => {
				if (closed) return;
				closed = true;
				if (dismissTimer) {
					clearTimeout(dismissTimer);
				}
				card.classList.add('closing');
				setTimeout(() => {
					card.remove();
					if (typeof onClose === 'function') {
						onClose();
					}
				}, 260);
			};

			const closeBtn = document.createElement('button');
			closeBtn.type = 'button';
			closeBtn.className = 'notification-close';
			closeBtn.setAttribute('aria-label', 'Close notification');
			closeBtn.innerHTML = '&times;';
			closeBtn.addEventListener('click', dismiss);

			card.appendChild(iconWrap);
			card.appendChild(textWrap);
			card.appendChild(closeBtn);

			const actionButtons = [];

			if (actions.length > 0) {
				card.classList.add('has-actions');
				const actionsWrap = document.createElement('div');
				actionsWrap.className = 'notification-actions';

				actions.forEach((action, index) => {
					const btn = document.createElement('button');
					btn.type = 'button';
					btn.className = 'notification-action';
					if (action?.primary) {
						btn.classList.add('primary');
					}
					btn.textContent = action?.label ?? `Option ${index + 1}`;

					btn.addEventListener('click', () => {
						let result;
						if (typeof action?.onClick === 'function') {
							result = action.onClick({ close: dismiss, element: card });
						}
						if (result !== false) {
							dismiss();
						}
					});

					actionsWrap.appendChild(btn);
					actionButtons.push(btn);
				});

				card.appendChild(actionsWrap);
			}

			if (!sticky && duration > 0) {
				dismissTimer = setTimeout(dismiss, duration);
				card.addEventListener('mouseenter', () => {
					if (dismissTimer) {
						clearTimeout(dismissTimer);
					}
				});
				card.addEventListener('mouseleave', () => {
					dismissTimer = setTimeout(dismiss, 1500);
				});
			}

			card.addEventListener('keydown', (event) => {
				if (event.key === 'Escape') {
					dismiss();
				}
			});

			notificationCenterEl.appendChild(card);
			if (role === 'alertdialog' || actions.length > 0) {
				requestAnimationFrame(() => {
					card.focus({ preventScroll: true });
				});
			}

			return {
				element: card,
				close: dismiss,
				focusFirstAction: () => {
					if (actionButtons.length > 0) {
						actionButtons[0].focus();
					}
				},
				focusLastAction: () => {
					if (actionButtons.length > 0) {
						actionButtons[actionButtons.length - 1].focus();
					}
				}
			};
		}

		const notify = {
			info: (message, options = {}) => showNotification(message, { ...options, type: 'info' }),
			success: (message, options = {}) => showNotification(message, { ...options, type: 'success' }),
			warning: (message, options = {}) => showNotification(message, { ...options, type: 'warning' }),
			error: (message, options = {}) => showNotification(message, { ...options, type: 'error' })
		};

		function showConfirm(message, options = {}) {
			const {
				title = 'Are you sure?',
				type = 'warning',
				confirmText = 'Confirm',
				cancelText = 'Cancel'
			} = options;

			let handled = false;

			return new Promise((resolve) => {
				const note = showNotification(message, {
					title,
					type,
					sticky: true,
					duration: 0,
					role: 'alertdialog',
					onClose: () => {
						if (!handled) {
							handled = true;
							resolve(false);
						}
					},
					actions: [
						{
							label: cancelText,
							onClick: () => {
								if (!handled) {
									handled = true;
									resolve(false);
								}
							}
						},
						{
							label: confirmText,
							primary: true,
							onClick: () => {
								if (!handled) {
									handled = true;
									resolve(true);
								}
							}
						}
					]
				});

				if (!note) {
					resolve(false);
					return;
				}

				if (note.element) {
					note.element.setAttribute('aria-modal', 'true');
					note.element.setAttribute('aria-live', 'assertive');
					const messageNode = note.element.querySelector('.notification-message');
					if (messageNode) {
						const describedbyId = `notification-${Date.now()}`;
						messageNode.id = describedbyId;
						note.element.setAttribute('aria-describedby', describedbyId);
					}
					requestAnimationFrame(() => {
						note.focusLastAction?.();
					});
				}
			});
		}

		function showPrompt(message, options = {}) {
			const {
				title = 'Input required',
				type = 'info',
				confirmText = 'Submit',
				cancelText = 'Cancel',
				placeholder = '',
				defaultValue = '',
				inputType = 'text',
				allowEmpty = false,
				validate,
				helperText
			} = options;

			let handled = false;
			let inputRef = null;
			let errorRef = null;

			const setError = (msg) => {
				if (errorRef) {
					errorRef.textContent = msg || '';
				}
				if (inputRef) {
					if (msg) {
						inputRef.classList.add('error');
					} else {
						inputRef.classList.remove('error');
					}
				}
			};

			return new Promise((resolve) => {
				const note = showNotification(message, {
					title,
					type,
					sticky: true,
					duration: 0,
					role: 'dialog',
					onClose: () => {
						if (!handled) {
							handled = true;
							resolve(null);
						}
					},
					actions: [
						{
							label: cancelText,
							onClick: () => {
								if (!handled) {
									handled = true;
									resolve(null);
								}
							}
						},
						{
							label: confirmText,
							primary: true,
							onClick: () => {
								const value = inputRef ? inputRef.value.trim() : '';
								if (!allowEmpty && !value) {
									setError('Please enter a value.');
									inputRef?.focus();
									return false;
								}
								if (typeof validate === 'function') {
									const validation = validate(value);
									if (validation !== true) {
										setError(typeof validation === 'string' ? validation : 'Please enter a valid value.');
										inputRef?.focus();
										return false;
									}
								}
								setError('');
								if (!handled) {
									handled = true;
									resolve(value);
								}
							}
						}
					]
				});

				if (!note) {
					resolve(null);
					return;
				}

				if (note.element) {
					note.element.setAttribute('aria-modal', 'true');
					note.element.setAttribute('aria-live', 'assertive');
					const messageNode = note.element.querySelector('.notification-message');
					const textWrap = note.element.querySelector('.notification-text');
					if (messageNode && textWrap) {
						const describedbyId = `notification-${Date.now()}`;
						messageNode.id = describedbyId;
						note.element.setAttribute('aria-describedby', describedbyId);
						inputRef = document.createElement('input');
						inputRef.type = inputType;
						inputRef.className = 'notification-input';
						inputRef.placeholder = placeholder;
						inputRef.value = defaultValue;
						messageNode.after(inputRef);

						errorRef = document.createElement('div');
						errorRef.className = 'notification-inline-error';
						errorRef.setAttribute('aria-live', 'polite');
						textWrap.appendChild(errorRef);

						if (helperText) {
							const helperEl = document.createElement('div');
							helperEl.className = 'notification-helper';
							helperEl.textContent = helperText;
							textWrap.appendChild(helperEl);
						}

						const cancelBtn = note.element.querySelector('.notification-action:not(.primary)');
						const confirmBtn = note.element.querySelector('.notification-action.primary');

						inputRef.addEventListener('input', () => {
							if (inputRef?.classList.contains('error')) {
								setError('');
							}
						});
						inputRef.addEventListener('keydown', (event) => {
							if (event.key === 'Enter') {
								event.preventDefault();
								confirmBtn?.click();
							} else if (event.key === 'Escape') {
								event.preventDefault();
								cancelBtn?.click();
							}
						});

						requestAnimationFrame(() => {
							inputRef?.focus();
							inputRef?.select?.();
						});
					}
				}
			});
		}
		
		const firebaseConfig = {
			apiKey: "AIzaSyCTyk_sZYCXFsFOQK_faVQ5KQiQNtK1Q0",
			authDomain: "ilyambr-45403.firebaseapp.com",
			databaseURL: customDatabaseUrl || defaultDatabaseUrl,
			projectId: "ilyambr-45403",
			storageBucket: "ilyambr-45403.firebasestorage.app",
			messagingSenderId: "826687105713",
			appId: "1:826687105713:web:a5e0b97818a2bf91da5098"
		};

		console.log('🔥 Using Firebase database:', firebaseConfig.databaseURL);

		// Initialize Firebase
		let database = null;
		try {
			if (typeof firebase !== 'undefined') {
				firebase.initializeApp(firebaseConfig);
				database = firebase.database();
				console.log('🔥 Firebase initialized successfully!');
				// After initial init, check if there's a globally configured DB override and switch for everyone
				ensureGlobalDatabaseUrl();
			}
		} catch (error) {
			console.log('Firebase not available, using localStorage fallback');
		}

		// Use an explicitly selected (active) DB from history for all visitors.
		// Probe the DEFAULT database as the source of truth; if an active entry exists there, apply it.
		async function ensureGlobalDatabaseUrl() {
			try {
				if (!firebase) return;
				const hostKey = normalizeHost(window.location.hostname || '');
				// 1) Read ACTIVE MAP from DEFAULT DB (canonical).
				let defaultMap = null;
				try {
					const defaultAppName = 'defaultProbe';
					const existing = firebase.apps?.find(a => a.name === defaultAppName);
					const defaultApp = existing || firebase.initializeApp({ ...firebaseConfig, databaseURL: defaultDatabaseUrl }, defaultAppName);
					const defaultDb = defaultApp.database();
					const snap = await defaultDb.ref('siteSettings/firebaseDbActiveMap').once('value');
					defaultMap = parseMaybeJson(snap.val());
				} catch (e) {
					console.warn('Default DB probe failed:', e);
				}

				// 2) Read ACTIVE MAP from CURRENT DB as fallback
				let currentMap = null;
				try {
					if (database) {
						const snap2 = await database.ref('siteSettings/firebaseDbActiveMap').once('value');
						currentMap = parseMaybeJson(snap2.val());
					}
				} catch (e) {
					console.warn('Current DB probe failed:', e);
				}

				const desiredUrl = getUrlForHostFromMap(defaultMap, hostKey) || getUrlForHostFromMap(currentMap, hostKey);
				if (desiredUrl && desiredUrl !== firebaseConfig.databaseURL) {
					console.log('🌍 Applying global Firebase DB override:', desiredUrl);
					localStorage.setItem('encryptedFirebaseUrl', encryptUrl(desiredUrl));
					window.location.reload();
				}
			} catch (e) {
				console.warn('Could not check/apply global database URL override:', e);
			}
		}

		function normalizeHost(h){
			try { return (h||'').toLowerCase().replace(/^www\./,''); } catch { return h || ''; }
		}
		function parseMaybeJson(val){
			if (!val) return null;
			if (typeof val === 'object') return val;
			try { return JSON.parse(val); } catch { return null; }
		}
		function getUrlForHostFromMap(map, host){
			if (!map) return null;
			const key = host || normalizeHost(window.location.hostname||'');
			return (map[key]?.url) || (map['*']?.url) || (map['auto']?.url) || null;
		}

		// Admin Console Functionality (moved here to be available immediately)
		let isAdminLoggedIn = false;
		let adminUser = null;
		const GOOGLE_CLIENT_ID = '1012238246699-5fknt3dtu6gbo42j5fvdonqsct81tfbp.apps.googleusercontent.com';
		const AUTHORIZED_EMAIL_ENCODED = 'YW1iZXJycGFubkBnbWFpbC5jb20=';
		const AUTHORIZED_EMAIL = (() => {
			if (typeof atob === 'function') {
				return atob(AUTHORIZED_EMAIL_ENCODED);
			}
			if (typeof Buffer !== 'undefined') {
				try {
					return Buffer.from(AUTHORIZED_EMAIL_ENCODED, 'base64').toString('utf-8');
				} catch (err) {
					console.warn('Buffer base64 decode failed, falling back to encoded email.', err);
				}
			}
			return 'amberrpann@gmail.com';
		})();
		// Collaborators list (hoisted early to avoid TDZ)
		let collaborators = [];

		function openAdminLogin() {
			console.log('🔧 Admin button clicked!');
			console.log('📊 isAdminLoggedIn:', isAdminLoggedIn);
			
			if (isAdminLoggedIn) {
				console.log('✅ User is logged in, opening admin panel');
				loadCurrentSettings();
				renderCollaborators();
				updateTintRows();
				renderActionLinksList('follow');
				renderActionLinksList('subscribe');
				const adminPanel = document.getElementById('adminPanelPopup');
				if (adminPanel) {
					adminPanel.style.display = 'flex';
				}
				setBodyScrollState(true);
			} else {
				console.log('🔐 User not logged in, opening login popup');
				const loginPopup = document.getElementById('adminLoginPopup');
				if (loginPopup) {
					loginPopup.style.display = 'flex';
					setBodyScrollState(true);
					console.log('✅ Login popup should be visible now');
				} else {
					console.error('❌ adminLoginPopup element not found!');
				}
			}
		}

		function closeAdminPopup(popupId) {
			const popup = document.getElementById(popupId);
			if (!popup) return;
			popup.style.display = 'none';
			setBodyScrollState(false);
		}

		// Global settings management
		async function saveGlobalSetting(key, value) {
			try {
				if (database) {
					// Save to Firebase for all users
					await database.ref('siteSettings/' + key).set(value);
					console.log(`🌍 Global setting ${key} saved to Firebase for ALL users!`);
				} else {
					// Fallback to localStorage
					localStorage.setItem('admin-' + key, value);
					console.log(`💾 Setting ${key} saved to localStorage (fallback)`);
				}
			} catch (error) {
				console.error('Failed to save setting:', error);
				// Fallback to localStorage
				localStorage.setItem('admin-' + key, value);
			}
		}

		async function loadGlobalSetting(key) {
			try {
				if (database) {
					// Load from Firebase
					const snapshot = await database.ref('siteSettings/' + key).once('value');
					const value = snapshot.val();
					console.log(`🌍 Global setting ${key} loaded from Firebase:`, value);
					return value;
				} else {
					// Fallback to localStorage
					const value = localStorage.getItem('admin-' + key);
					console.log(`💾 Setting ${key} loaded from localStorage:`, value);
					return value;
				}
			} catch (error) {
				console.error('Failed to load setting:', error);
				// Fallback to localStorage
				return localStorage.getItem('admin-' + key);
			}
		}

		// Initialize Google Sign-In when the page loads
		window.onload = async function() {
			console.log('🔑 Initializing OAuth system...');
			
			// Check for existing valid session first
			checkExistingSession();
			
			// Wait a bit for Google API to fully load
			setTimeout(() => {
				console.log('🔍 Checking Google API availability...');
				console.log('Google object exists:', typeof google !== 'undefined');
				console.log('Google accounts exists:', typeof google !== 'undefined' && google.accounts);
				
				// Now we have a valid Google Client ID, so use proper Google OAuth
				if (typeof google !== 'undefined' && google.accounts) {
					console.log('✅ Google API loaded successfully, initializing OAuth...');
					
					try {
						google.accounts.id.initialize({
							client_id: GOOGLE_CLIENT_ID,
							callback: handleCredentialResponse,
							auto_select: false,
							cancel_on_tap_outside: false
						});

						console.log('✅ Google OAuth initialized successfully');

						const signInElement = document.getElementById("googleSignIn");
						if (signInElement) {
							google.accounts.id.renderButton(
								signInElement,
								{ 
									theme: "outline", 
									size: "large",
									text: "sign_in_with",
									width: 250
								}
							);
							console.log('✅ Google Sign-In button rendered');
						} else {
							console.error('❌ Google Sign-In element not found');
						}
					} catch (error) {
						console.error('❌ Error initializing Google OAuth:', error);
						setupFallbackAuth();
					}
				} else {
					console.warn('⚠️ Google API not available, using fallback');
					setupFallbackAuth();
				}
			}, 1000); // Wait 1 second for Google API to load
			
			// Bind tint mode change
			const tm = document.getElementById('tintMode');
			if (tm) tm.addEventListener('change', updateTintRows);

			// Load existing settings from Firebase/localStorage (now properly awaited)
			try {
				await loadExistingSettings();
				console.log('✅ Settings loaded successfully');
			} catch (error) {
				console.error('❌ Error loading settings:', error);
			}

			// Init Firebase DB UI helpers
			try {
				const siteSel = document.getElementById('firebaseSiteName');
				if (siteSel) {
					siteSel.addEventListener('change', onFirebaseSiteChange);
					onFirebaseSiteChange();
				}
				renderFirebaseHistory();
			} catch (e) { console.warn('DB UI init failed:', e); }
			
			// Do not force any default effects here; loadGlobalEffects() will apply saved state
		};

		function setupFallbackAuth() {
			console.log('🔄 Setting up fallback authentication...');
			const signInElement = document.getElementById("googleSignIn");
			if (signInElement) {
				signInElement.onclick = fallbackGoogleSignIn;
				signInElement.innerHTML = `
					<img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="width: 20px; height: 20px; margin-right: 8px;"/>
					Sign in with Google (Fallback)
				`;
				signInElement.style.display = 'flex';
				signInElement.style.alignItems = 'center';
				signInElement.style.justifyContent = 'center';
				signInElement.style.padding = '10px 20px';
				signInElement.style.border = '1px solid #dadce0';
				signInElement.style.borderRadius = '4px';
				signInElement.style.backgroundColor = '#fff';
				signInElement.style.color = '#3c4043';
				signInElement.style.cursor = 'pointer';
				console.log('✅ Fallback auth button set up');
			}
		}

		function checkExistingSession() {
			const sessionData = sessionStorage.getItem('admin-session');
			if (sessionData) {
				try {
					const session = JSON.parse(sessionData);
					const now = Date.now();
					
					// Check if session is still valid (not expired)
					if (session.tokenExp && session.tokenExp > now) {
						// Session is valid
						adminUser = session.user;
						isAdminLoggedIn = true;
						
						// Set up auto-logout when token expires
						const timeUntilExpiry = session.tokenExp - now;
						setTimeout(() => {
							signOut();
							notify.warning('Session expired. Please sign in again.', { title: 'Signed out' });
						}, timeUntilExpiry);
						
						return true;
					} else {
						// Session expired, clear it
						sessionStorage.removeItem('admin-session');
					}
				} catch (error) {
					console.error('Invalid session data:', error);
					sessionStorage.removeItem('admin-session');
				}
			}
			return false;
		}

		async function fallbackGoogleSignIn() {
			console.log('🔄 Attempting fallback Google Sign-In...');
			
			// For file:// protocol, show a message about domain restrictions
			if (window.location.protocol === 'file:') {
				const useDemo = await showConfirm('Google OAuth cannot verify credentials from a file:// URL. Use demo admin access instead?', {
					title: 'OAuth limitation detected',
					confirmText: 'Use demo access',
					cancelText: 'Enter email manually',
					type: 'warning'
				});
				
				if (useDemo) {
					// Simulate successful admin login for testing
					const simulatedUser = {
						name: 'Admin (Demo)',
						email: AUTHORIZED_EMAIL,
						picture: 'https://via.placeholder.com/40'
					};
					
					console.log('🔧 Using simulated admin login for testing');
					adminUser = simulatedUser;
					isAdminLoggedIn = true;
					showLoginSuccess();
					setTimeout(() => {
						closeAdminPopup('adminLoginPopup');
						openAdminLogin(); // This will now open the admin panel
					}, 1000);
					return;
				}
			}
			
			// Manual email verification for demonstration/testing
			const currentDomain = window.location.origin || `${window.location.protocol}//${window.location.host}`;
			const email = await showPrompt(`Enter your email for admin access. Only approved collaborators will be allowed.`, {
				title: 'Manual admin verification',
				type: 'warning',
				inputType: 'email',
				confirmText: 'Verify email',
				cancelText: 'Cancel',
				placeholder: 'name@example.com',
				defaultValue: AUTHORIZED_EMAIL,
				validate: (value) => value ? true : 'Email is required.',
				helperText: `Authorized email: ${AUTHORIZED_EMAIL}. Current domain: ${currentDomain}. Ensure this domain is in your Google Cloud authorized origins and served over HTTPS.`
			});
			
			// Load collaborators before checking
			await loadCollaborators();
			const normalizedEmail = (email || '').trim().toLowerCase();
			if (normalizedEmail && isAuthorizedEmail(normalizedEmail)) {
				adminUser = { email: normalizedEmail, name: "Admin User (Manual)" };
				isAdminLoggedIn = true;
				showLoginSuccess();
				setTimeout(() => {
					closeAdminPopup('adminLoginPopup');
					openAdminLogin(); // This will now open the admin panel
				}, 1000);
			} else if (normalizedEmail) {
				showLoginError(`Unauthorized email address.`);
			}
		}

		async function handleCredentialResponse(response) {
			// More secure client-side verification
			try {
				// Verify token structure
				const tokenParts = response.credential.split('.');
				if (tokenParts.length !== 3) {
					throw new Error('Invalid token format');
				}

				const payload = JSON.parse(atob(tokenParts[1]));
				
				// Verify token hasn't expired
				const now = Math.floor(Date.now() / 1000);
				if (payload.exp && payload.exp < now) {
					throw new Error('Token expired');
				}

				// Verify token is from correct client ID
				if (payload.aud !== GOOGLE_CLIENT_ID) {
					throw new Error('Invalid audience');
				}

				// Verify issuer
				if (payload.iss !== 'accounts.google.com' && payload.iss !== 'https://accounts.google.com') {
					throw new Error('Invalid issuer');
				}

				// Check email verification
				if (!payload.email_verified) {
					throw new Error('Email not verified');
				}

				// Check authorized email or collaborator
				await loadCollaborators();
				if (isAuthorizedEmail(payload.email)) {
					adminUser = {
						email: payload.email,
						name: payload.name,
						picture: payload.picture
					};
					isAdminLoggedIn = true;
					showLoginSuccess();
					
					// Optional: Store session with expiry
					const sessionData = {
						user: adminUser,
						loginTime: Date.now(),
						tokenExp: payload.exp * 1000 // Convert to milliseconds
					};
					sessionStorage.setItem('admin-session', JSON.stringify(sessionData));
					
					setTimeout(() => {
						closeAdminPopup('adminLoginPopup');
						openAdminLogin();
					}, 1000);
				} else {
					showLoginError("Unauthorized email address");
				}
			} catch (error) {
				console.error('Token verification failed:', error);
				showLoginError("Login verification failed: " + error.message);
			}
		}

		function showLoginSuccess() {
			const status = document.getElementById('loginStatus');
			status.className = 'login-status success';
			status.textContent = `Successfully signed in as ${adminUser.name}`;
		}

		function showLoginError(message) {
			const status = document.getElementById('loginStatus');
			status.className = 'login-status error';
			status.textContent = message;
		}

		function signOut() {
			isAdminLoggedIn = false;
			adminUser = null;
			closeAdminPopup('adminPanelPopup');
			
			// Clear session data
			sessionStorage.removeItem('admin-session');
			
			if (typeof google !== 'undefined' && google.accounts) {
				google.accounts.id.disableAutoSelect();
			}
			
			document.getElementById('loginStatus').textContent = '';
		}

		// Admin Panel Functions
		// ---- Action Links (Follow/Subscribe) ----
		let actionLinkContext = 'follow'; // current context for add/edit
		let followLinks = []; // {name, url, img, invert}
		let subscribeLinks = [];

		function openAddActionLinkPopup(context) {
			actionLinkContext = context;
			document.getElementById('actionLinkPopupTitle').textContent = context === 'follow' ? 'Add Follow Link' : 'Add Subscribe Link';
			document.getElementById('actionLogoFile').value = '';
			document.getElementById('actionLogoPreviewWrap').style.display = 'none';
			document.getElementById('actionLinkName').value = '';
			document.getElementById('actionLinkUrl').value = '';
			const inv = document.getElementById('actionLogoInvert');
			if (inv) inv.checked = false;
			openPopup('actionLinkPopup');
		}

		async function handleActionLogoFile(input) {
			const file = input.files && input.files[0];
			if (!file) return;
			const preview = document.getElementById('actionLogoPreview');
			const wrap = document.getElementById('actionLogoPreviewWrap');
			try {
				const dataUrl = await readFileAsDataURL(file);
				if (preview) preview.src = dataUrl;
				if (wrap) wrap.style.display = 'flex';
			} catch (error) {
				console.error('Failed to process action logo:', error);
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Could not process that logo. Try a different image.');
				}
				if (preview) preview.removeAttribute('src');
				if (wrap) wrap.style.display = 'none';
			} finally {
				if (input) input.value = '';
			}
		}

		async function saveActionLinkFromPopup() {
			const name = (document.getElementById('actionLinkName').value || '').trim();
			const url = (document.getElementById('actionLinkUrl').value || '').trim();
			const img = document.getElementById('actionLogoPreview').src || '';
			const invert = !!document.getElementById('actionLogoInvert').checked;
			if (!name || !url || !img) { notify.error('Provide a logo, name, and URL before saving.'); return; }
			const entry = { name, url, img, invert };
			if (actionLinkContext === 'follow') {
				followLinks.push(entry);
				await saveGlobalSetting('followLinks', JSON.stringify(followLinks));
				renderActionLinksList('follow');
				renderActionPopupButtons('follow');
			} else {
				subscribeLinks.push(entry);
				await saveGlobalSetting('subscribeLinks', JSON.stringify(subscribeLinks));
				renderActionLinksList('subscribe');
				renderActionPopupButtons('subscribe');
			}
			closePopup('actionLinkPopup');
		}

		function renderActionLinksList(context) {
			const data = context === 'follow' ? followLinks : subscribeLinks;
			const container = document.getElementById(context === 'follow' ? 'followLinksList' : 'subscribeLinksList');
			if (!container) return;
			container.innerHTML = '';
			data.forEach((item, idx) => {
				const div = document.createElement('div');
				div.className = 'collab-item';
				div.innerHTML = `
					<div style="display:flex; align-items:center; gap:10px;">
						<img src="${item.img}" alt="logo" style="width:20px; height:20px; object-fit:contain; border-radius:4px; background:rgba(255,255,255,0.08); ${item.invert ? 'filter: invert(1);' : ''}"/>
						<span class="collab-email">${item.name} — ${item.url}</span>
					</div>
				`;
				const btn = document.createElement('button');
				btn.className = 'collab-remove';
				btn.textContent = 'Remove';
				btn.onclick = async () => {
					if (context === 'follow') {
						followLinks.splice(idx, 1);
						await saveGlobalSetting('followLinks', JSON.stringify(followLinks));
						renderActionLinksList('follow');
						renderActionPopupButtons('follow');
					} else {
						subscribeLinks.splice(idx, 1);
						await saveGlobalSetting('subscribeLinks', JSON.stringify(subscribeLinks));
						renderActionLinksList('subscribe');
						renderActionPopupButtons('subscribe');
					}
				};
				div.appendChild(btn);
				container.appendChild(div);
			});
		}

		async function clearActionLinks(context) {
			const confirmed = await showConfirm('Clear all links in this list?', {
				title: context === 'follow' ? 'Clear follow links' : 'Clear subscribe links',
				confirmText: 'Clear links',
				cancelText: 'Keep list',
				type: 'warning'
			});
			if (!confirmed) return;
			if (context === 'follow') {
				followLinks = [];
				await saveGlobalSetting('followLinks', JSON.stringify(followLinks));
				renderActionLinksList('follow');
				renderActionPopupButtons('follow');
				notify.success('Follow links cleared.');
			} else {
				subscribeLinks = [];
				await saveGlobalSetting('subscribeLinks', JSON.stringify(subscribeLinks));
				renderActionLinksList('subscribe');
				renderActionPopupButtons('subscribe');
				notify.success('Subscribe links cleared.');
			}
		}

		function setPopupTitles(displayName) {
			const name = displayName && displayName !== 'N/A' ? displayName : 'ilyambr';
			const fTitle = document.getElementById('followPopupTitle');
			if (fTitle) fTitle.textContent = `Follow ${name}`;
			const sTitle = document.getElementById('subscribePopupTitle');
			if (sTitle) sTitle.textContent = `Subscribe to ${name}`;
		}

		function renderActionPopupButtons(context) {
			const data = context === 'follow' ? followLinks : subscribeLinks;
			const container = document.getElementById(context === 'follow' ? 'followPopupButtons' : 'subscribePopupButtons');
			if (!container) return;
			container.innerHTML = '';
			data.forEach(item => {
				const a = document.createElement('a');
				a.href = item.url;
				a.target = '_blank';
				a.rel = 'noopener';
				a.className = 'popup-button';
				// logo
				const img = document.createElement('img');
				img.src = item.img;
				img.alt = 'Logo';
				img.style.filter = item.invert ? 'invert(1) grayscale(100%)' : 'grayscale(100%)';
				a.appendChild(img);
				// text node
				a.appendChild(document.createTextNode(item.name));
				container.appendChild(a);
			});
		}

		// Upload handlers for Profile Picture and Background
		function triggerProfileUpload(){ const f = document.getElementById('profilePictureUploadFile'); if (f) f.click(); }
		function triggerBackgroundUpload(){ const f = document.getElementById('backgroundImageUploadFile'); if (f) f.click(); }
		function triggerPageLogoUpload(type){ const target = type === 'small' ? document.getElementById('pageLogoSmallUploadFile') : document.getElementById('pageLogoLargeUploadFile'); if (target) target.click(); }
		function setPageLogoPreviewImage(type, src) {
			const map = {
				large: { img: document.getElementById('pageLogoAdminPreviewLarge'), frame: document.getElementById('pageLogoLargeFrame') },
				small: { img: document.getElementById('pageLogoAdminPreviewSmall'), frame: document.getElementById('pageLogoSmallFrame') }
			};
			const target = map[type];
			if (!target) return;
			const { img, frame } = target;
			if (!img || !frame) return;
			if (src) {
				img.src = src;
				img.style.display = 'block';
				frame.classList.add('has-image');
			} else {
				img.removeAttribute('src');
				img.style.display = 'none';
				frame.classList.remove('has-image');
			}
			const invertEnabled = !document.body.classList.contains('logo-no-invert');
			updateAdminLogoPreviewInvert(invertEnabled);
		}
		function updateAdminLogoPreviewInvert(shouldInvert) {
			['pageLogoAdminPreviewLarge', 'pageLogoAdminPreviewSmall'].forEach(id => {
				const img = document.getElementById(id);
				if (!img) return;
				img.style.filter = shouldInvert ? 'invert(100%)' : 'none';
			});
		}
		async function handlePageLogoUploadFile(input, type) {
			const file = input?.files?.[0];
			if (!file) return;
			try {
				const dataUrl = await readFileAsDataURL(file);
				const hiddenId = type === 'small' ? 'pageLogoSmall' : 'pageLogoLarge';
				const targetInput = document.getElementById(hiddenId);
				if (targetInput) {
					targetInput.value = dataUrl;
					targetInput.dataset.filename = file.name || '';
				}
				if (type === 'large') {
					const previewEl = document.getElementById('pageLogoImg');
					if (previewEl) {
						previewEl.src = dataUrl;
					}
				}
				if (type === 'small') {
					const faviconLink = document.querySelector('link[rel="icon"]');
					if (faviconLink) {
						faviconLink.href = dataUrl;
					}
				}
				setPageLogoPreviewImage(type, dataUrl);
				const statusId = type === 'small' ? 'currentPageLogoSmall' : 'currentPageLogo';
				const status = document.getElementById(statusId);
				if (status && (!status.textContent || status.textContent === 'N/A' || status.textContent === 'Default')) {
					status.textContent = 'Uploaded image (unsaved)';
				}
				if (typeof notify !== 'undefined' && typeof notify.info === 'function') {
					notify.info(`${type === 'small' ? 'Small' : 'Large'} logo ready to save.`);
				}
			} catch (error) {
				console.error('Failed to prepare page logo:', error);
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Could not load that image. Try a different file.');
				}
			} finally {
				if (input) input.value = '';
			}
		}
		async function handleProfileUploadFile(input) {
			const file = input.files && input.files[0];
			if (!file) return;
			try {
				const dataUrl = await readFileAsDataURL(file);
				const profileInput = document.getElementById('profilePicture');
				if (profileInput) profileInput.value = dataUrl;
				await saveGlobalSetting('profile-pic', dataUrl);
				const avatarImgs = document.querySelectorAll('.avatar img');
				avatarImgs.forEach(img => (img.src = dataUrl));
				setProfilePreviewImage(dataUrl);
				const statusEl = document.getElementById('currentProfilePic');
				if (statusEl) statusEl.textContent = 'uploaded image';
				if (typeof notify !== 'undefined' && typeof notify.success === 'function') {
					notify.success('Profile image uploaded and applied globally.');
				}
			} catch (error) {
				console.error('Failed to update profile image:', error);
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Could not update the profile image. Try a different file.');
				}
			} finally {
				if (input) input.value = '';
			}
		}

		async function handleBackgroundUploadFile(input) {
			const file = input.files && input.files[0];
			if (!file) return;
			try {
				const dataUrl = await readFileAsDataURL(file);
				const backgroundInput = document.getElementById('backgroundImage');
				if (backgroundInput) backgroundInput.value = dataUrl;
				await saveGlobalSetting('background', dataUrl);
				document.body.style.background = `url('${dataUrl}') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
				pageEffectsRoot.style.background = document.body.style.background;
				const statusEl = document.getElementById('currentBackground');
				if (statusEl) statusEl.textContent = 'uploaded image';
				if (typeof notify !== 'undefined' && typeof notify.success === 'function') {
					notify.success('Background image uploaded and applied globally.');
				}
			} catch (error) {
				console.error('Failed to update background image:', error);
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Could not update the background image. Try again.');
				}
			} finally {
				if (input) input.value = '';
			}
		}

		async function openFollowPopup() {
			renderActionPopupButtons('follow');
			openPopup('followPopup');
		}
		async function openSubscribePopup() {
			renderActionPopupButtons('subscribe');
			openPopup('subscribePopup');
		}
		function loadCurrentSettings() {
			const currentHost = window.location.hostname || 'unknown';
			document.getElementById('adminUserName').textContent = `Welcome, ${adminUser.name} (Domain: ${currentHost})`;
			
			// Load current settings
			const currentPic = localStorage.getItem('admin-profile-pic') || 'Default';
			const currentBg = localStorage.getItem('admin-background') || 'Default';
			const currentVideo = localStorage.getItem('admin-youtube-video') || 'Auto-Latest';
			const shortVideoLine = localStorage.getItem('admin-short-video') || 'None';
			
			document.getElementById('currentProfilePic').textContent = currentPic;
			document.getElementById('currentBackground').textContent = currentBg;
			document.getElementById('currentYouTubeVideo').textContent = currentVideo;
			const shortVideoEl = document.getElementById('currentShortVideo');
			if (shortVideoEl) shortVideoEl.textContent = shortVideoLine;
		}

		async function loadExistingSettings() {
			console.log('🌍 Loading global settings for ALL visitors...');
			// Apply saved GLOBAL settings on page load - visible to ALL users
			const savedDisplayName = await loadGlobalSetting('display-name');
			const savedUsername = await loadGlobalSetting('username');
			// Load follow/subscribe links
			try {
				const f = await loadGlobalSetting('followLinks');
				if (f && f !== 'N/A') {
					followLinks = JSON.parse(f);
					// backfill invert flag
					followLinks = (Array.isArray(followLinks) ? followLinks : []).map(x => ({...x, invert: !!x.invert}));
				}
			} catch(e) { followLinks = []; }
			try {
				const s = await loadGlobalSetting('subscribeLinks');
				if (s && s !== 'N/A') {
					subscribeLinks = JSON.parse(s);
					subscribeLinks = (Array.isArray(subscribeLinks) ? subscribeLinks : []).map(x => ({...x, invert: !!x.invert}));
				}
			} catch(e) { subscribeLinks = []; }
			renderActionLinksList('follow');
			renderActionLinksList('subscribe');
			renderActionPopupButtons('follow');
			renderActionPopupButtons('subscribe');

			try {
				const storedApps = await loadGlobalSetting('allSettingsApps');
				if (storedApps && storedApps !== 'N/A') {
					const parsed = JSON.parse(storedApps);
					if (Array.isArray(parsed)) {
						const deduped = [];
						const seen = new Set();
						parsed.forEach(item => {
							const normalized = normalizeAllSettingsApp(item);
							if (!normalized || seen.has(normalized.id)) return;
							seen.add(normalized.id);
							deduped.push(normalized);
						});
						allSettingsApps = deduped;
					} else {
						allSettingsApps = [];
					}
				} else {
					allSettingsApps = [];
				}
			} catch (error) {
				console.error('Failed to load All Settings apps:', error);
				allSettingsApps = [];
			}
			renderGameSettingsTabs();
			renderAllSettingsManagerGrid();

			// Update popup titles with current display name
			setPopupTitles(savedDisplayName);
			const savedTwitchStatus = await loadGlobalSetting('twitchStatus');
			const savedDiscordLink = await loadGlobalSetting('discordLink');
			const savedPic = await loadGlobalSetting('profile-pic');
			const savedBg = await loadGlobalSetting('background');
			const savedVideo = await loadGlobalSetting('youtube-video');
			const savedShortVideoRaw = await loadGlobalSetting('shortVideoEmbed');
			const savedShortVideo = normalizeShortVideoConfig(savedShortVideoRaw);
			const savedPageLogo = await loadGlobalSetting('pageLogo');
			const savedPageLogoSmall = await loadGlobalSetting('pageLogoSmall');
			const savedLogoInvert = await loadGlobalSetting('logoInvert');
			const savedLogoSize = await loadGlobalSetting('pageLogoSize');
			const savedBio = await loadGlobalSetting('bioText');
			const savedAboutText = await loadGlobalSetting('aboutText');
			const savedStreamingYear = await loadGlobalSetting('streamingYear');
			const savedFollowerCount = await loadGlobalSetting('followerCount');
			const savedSubscriberCount = await loadGlobalSetting('subscriberCount');
			const savedTwitchLink = await loadGlobalSetting('twitchLink');
			const savedYouTubeLink = await loadGlobalSetting('youtubeLink');
			const savedTikTokLink = await loadGlobalSetting('tiktokLink');
			const savedInstagramLink = await loadGlobalSetting('instagramLink');
			const savedXLink = await loadGlobalSetting('xLink');
			const savedRedditLink = await loadGlobalSetting('redditLink');
			const savedFollowButtonText = await loadGlobalSetting('followButtonText');
			const savedSubscribeButtonText = await loadGlobalSetting('subscribeButtonText');
			const savedTwitchChannel = await loadGlobalSetting('twitchChannel');
			const savedSaturdayTime = await loadGlobalSetting('saturdayTime');
			const savedSundayTime = await loadGlobalSetting('sundayTime');
			
			console.log('� Global display name:', savedDisplayName);
			console.log('📧 Global username:', savedUsername);
			console.log('�🖼️ Global profile pic:', savedPic);
			console.log('🎨 Global background:', savedBg);
			console.log('📺 Global YouTube video:', savedVideo);
			if (savedShortVideo) {
				console.log('🎬 Featured short video config:', savedShortVideo);
				applyShortVideoEmbed(savedShortVideo);
			} else {
				applyShortVideoEmbed(null);
			}
			
			// Apply saved names
			if (savedDisplayName && savedDisplayName !== 'N/A') {
				const nameElements = document.querySelectorAll('.name, h1, .profile-name');
				nameElements.forEach(element => {
					if (element.textContent.includes('ilyambr') || element.textContent === 'ilyambr' || !element.textContent.trim()) {
						element.textContent = savedDisplayName;
					}
				});
				document.title = savedDisplayName;
			} else {
				const fallbackName = 'ilyambr';
				const nameElements = document.querySelectorAll('.name, h1, .profile-name');
				nameElements.forEach(element => {
					if (!element.textContent.trim()) {
						element.textContent = fallbackName;
					}
				});
				document.title = fallbackName;
			}
			
			if (savedUsername && savedUsername !== 'N/A') {
				const usernameElements = document.querySelectorAll('.username, .handle, .user-handle');
				usernameElements.forEach(element => {
					element.textContent = savedUsername;
				});
				
				// SAFE way to update specific content without breaking JavaScript
				// Only target visible content elements, exclude script/style/head
				const contentElements = document.querySelectorAll('div.username, span.username, p.username, .bio, .title');
				contentElements.forEach(element => {
					// Only update if it's not inside a script or style tag
					if (!element.closest('script') && !element.closest('style') && !element.closest('head')) {
						if (element.textContent && element.textContent.includes('@ilyambrr')) {
							element.textContent = element.textContent.replace('@ilyambrr', savedUsername);
						}
					}
				});
			} else {
				const fallbackUsername = '@ilyambrr';
				const usernameElements = document.querySelectorAll('.username, .handle, .user-handle');
				usernameElements.forEach(element => {
					if (!element.textContent.trim()) {
						element.textContent = fallbackUsername;
					}
				});
			}
			const gameSettingsUsername = document.getElementById('gameSettingsUsername');
			if (gameSettingsUsername) {
				gameSettingsUsername.textContent = formatHandle(savedUsername);
			}
			
			// Apply saved Twitch status
			if (savedTwitchStatus) {
				console.log('💜 Applying global Twitch status to ALL visitors:', savedTwitchStatus);
				const statusBadge = document.getElementById('twitchStatusBadge');
				if (statusBadge) {
					let statusText = savedTwitchStatus.charAt(0).toUpperCase() + savedTwitchStatus.slice(1);
					if (savedTwitchStatus === 'verified') {
						statusText += ' <img src="https://ilyambr.me/img/checkmark.svg" style="width: 12px; height: 12px; margin-left: 4px; filter: invert(1); vertical-align: middle;" alt="✓">';
					}
					statusBadge.innerHTML = statusText;
					statusBadge.style.display = 'block'; // Show the badge
					console.log('✅ Twitch status badge shown:', savedTwitchStatus);
				}
			} else {
				console.log('💜 No Twitch status set, badge remains hidden');
			}
			
			// Apply saved Discord link
			if (savedDiscordLink && savedDiscordLink !== 'N/A') {
				console.log('💬 Applying global Discord link to ALL visitors:', savedDiscordLink);
				const discordLink = document.getElementById('discordSocialLink');
				if (discordLink) {
					discordLink.href = savedDiscordLink;
				}
				console.log('✅ Discord link updated');
			}
			
			// Apply saved page logos
			const logoElement = document.getElementById('pageLogoImg');
			const initialLargeLogoSrc = (savedPageLogo && savedPageLogo !== 'N/A') ? savedPageLogo : (logoElement ? logoElement.src : '');
			if (logoElement) {
				logoElement.src = initialLargeLogoSrc || 'https://ilyambr.me/Screenshot_2025-02-06_010238_edited_edited.png';
			}
			const appliedLargeLogo = logoElement ? logoElement.src : initialLargeLogoSrc;
			const faviconLink = document.querySelector('link[rel="icon"]');
			const initialSmallLogoSrc = (savedPageLogoSmall && savedPageLogoSmall !== 'N/A') ? savedPageLogoSmall : (faviconLink ? faviconLink.href : '');
			if (faviconLink && initialSmallLogoSrc) {
				faviconLink.href = initialSmallLogoSrc;
			}
			const appliedSmallLogo = faviconLink ? faviconLink.href : initialSmallLogoSrc;
			setPageLogoPreviewImage('large', appliedLargeLogo);
			setPageLogoPreviewImage('small', appliedSmallLogo);
			const pageLogoLargeHidden = document.getElementById('pageLogoLarge');
			if (pageLogoLargeHidden) {
				pageLogoLargeHidden.value = '';
				if (pageLogoLargeHidden.dataset) {
					delete pageLogoLargeHidden.dataset.filename;
				}
			}
			const pageLogoSmallHidden = document.getElementById('pageLogoSmall');
			if (pageLogoSmallHidden) {
				pageLogoSmallHidden.value = '';
				if (pageLogoSmallHidden.dataset) {
					delete pageLogoSmallHidden.dataset.filename;
				}
			}
			// Apply saved page logo size (widthxheight)
			if (savedLogoSize && /^\d{2,5}x\d{2,5}$/i.test(savedLogoSize)) {
				const [w, h] = savedLogoSize.toLowerCase().split('x');
				const logoBox = document.querySelector('.page-logo');
				if (logoBox) {
					logoBox.style.width = w + 'px';
					logoBox.style.height = h + 'px';
				}
			}
			// Apply saved logo inversion state (default true)
			{
				const useInvert = (savedLogoInvert === null || savedLogoInvert === undefined) ? true : !!savedLogoInvert;
				const toggle = document.getElementById('logoInvertToggle');
				if (toggle) toggle.checked = useInvert;
				applyLogoInvertState(useInvert);
			}
			
			// Apply saved bio
			if (savedBio && savedBio !== 'N/A') {
				console.log('📝 Applying global bio to ALL visitors:', savedBio);
				const bioElement = document.querySelector('.bio');
				if (bioElement) {
					bioElement.textContent = savedBio;
				}
			} else {
				const bioElement = document.querySelector('.bio');
				if (bioElement && !bioElement.textContent.trim()) {
					bioElement.textContent = 'just give me a year max.....';
				}
			}
			
			// Apply saved about text
			if (savedAboutText && savedAboutText !== 'N/A') {
				console.log('📄 Applying global about text to ALL visitors:', savedAboutText);
				const aboutElement = document.getElementById('aboutTextContent');
				if (aboutElement) {
					aboutElement.textContent = clampAboutText(savedAboutText);
				}
			} else {
				const aboutElement = document.getElementById('aboutTextContent');
				if (aboutElement && !aboutElement.textContent.trim()) {
					aboutElement.textContent = clampAboutText("i make stuff, i stream, that's it really. just trying to make and do stuff i enjoy. appreciate you for visiting my website, make sure to join the discord and watch the streams 🫶");
				}
			}
			
			// Apply saved streaming year
			if (savedStreamingYear && savedStreamingYear !== 'N/A') {
				console.log('📅 Applying global streaming year to ALL visitors:', savedStreamingYear);
				const yearElement = document.getElementById('streamingYearStat');
				if (yearElement) {
					yearElement.textContent = `Streaming since ${savedStreamingYear}`;
				}
			} else {
				const yearElement = document.getElementById('streamingYearStat');
				if (yearElement && !yearElement.textContent.trim()) {
					yearElement.textContent = 'Streaming since 2024';
				}
			}
			
			// Apply saved follower count
			if (savedFollowerCount && savedFollowerCount !== 'N/A') {
				console.log('👥 Applying global follower count to ALL visitors:', savedFollowerCount);
				const followerElement = document.getElementById('twitchFollowersStat');
				if (followerElement) {
					followerElement.innerHTML = `
						<img src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" alt="Twitch" style="filter: invert(100%);"/>
						${formatNumber(parseInt(savedFollowerCount))} followers
					`;
				}
			}
			
			// Apply saved subscriber count
			if (savedSubscriberCount && savedSubscriberCount !== 'N/A') {
				console.log('📺 Applying global subscriber count to ALL visitors:', savedSubscriberCount);
				const subscriberElement = document.getElementById('youtubeSubscribersStat');
				if (subscriberElement) {
					subscriberElement.innerHTML = `
						<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" alt="YouTube" style="filter: invert(100%);"/>
						${formatNumber(parseInt(savedSubscriberCount))} subs
					`;
				}
			}
			
			// Apply saved social links
			if (savedTwitchLink && savedTwitchLink !== 'N/A') {
				updateSocialLink('twitch', savedTwitchLink);
			}
			if (savedYouTubeLink && savedYouTubeLink !== 'N/A') {
				updateSocialLink('youtube', savedYouTubeLink);
			}
			if (savedTikTokLink && savedTikTokLink !== 'N/A') {
				updateSocialLink('tiktok', savedTikTokLink);
			}
			if (savedInstagramLink && savedInstagramLink !== 'N/A') {
				updateSocialLink('instagram', savedInstagramLink);
			}
			if (savedXLink && savedXLink !== 'N/A') {
				updateSocialLink('x', savedXLink);
			}
			if (savedRedditLink && savedRedditLink !== 'N/A') {
				updateSocialLink('reddit', savedRedditLink);
			}

			const sanitizedChannel = sanitizeTwitchChannel(savedTwitchChannel);
			if (sanitizedChannel) {
				console.log('🎮 Applying global Twitch channel to ALL visitors:', sanitizedChannel);
				applyTwitchChannel(sanitizedChannel);
				const currentChannelEl = document.getElementById('currentTwitchChannel');
				if (currentChannelEl) currentChannelEl.textContent = sanitizedChannel;
				const twitchChannelInput = document.getElementById('twitchChannel');
				if (twitchChannelInput) twitchChannelInput.value = sanitizedChannel;
			} else {
				console.log('🎮 No saved Twitch channel found, applying default from config');
				const defaultChannel = sanitizeTwitchChannel(twitchConfig.username);
				if (defaultChannel) {
					applyTwitchChannel(defaultChannel);
					const currentChannelEl = document.getElementById('currentTwitchChannel');
					if (currentChannelEl) currentChannelEl.textContent = defaultChannel;
					const twitchChannelInput = document.getElementById('twitchChannel');
					if (twitchChannelInput) twitchChannelInput.value = defaultChannel;
				}
			}
			
			// Apply saved button text
			if (savedFollowButtonText && savedFollowButtonText !== 'N/A') {
				const followButton = document.getElementById('followButton');
				if (followButton) {
					followButton.innerHTML = `
						<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
							<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="m19 8 2 2-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="m21 10-7.5 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
						${savedFollowButtonText}
					`;
				}
			}
			if (savedSubscribeButtonText && savedSubscribeButtonText !== 'N/A') {
				const subscribeButton = document.getElementById('subscribeButton');
				if (subscribeButton) {
					subscribeButton.innerHTML = `
						<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
							<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="m19 8 2 2-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="m21 10-7.5 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
						${savedSubscribeButtonText}
					`;
				}
			}
			
			// Apply saved schedule with new flexible format (with fallback to old format)
			const stream1Day = await loadGlobalSetting('stream1Day') || 6; // Default Saturday
			const stream1Time = await loadGlobalSetting('stream1Time') || savedSaturdayTime;
			const stream1DateMode = await loadGlobalSetting('stream1DateMode') || 'auto';
			const stream1CustomDate = await loadGlobalSetting('stream1CustomDate') || '';
			
			const stream2Day = await loadGlobalSetting('stream2Day') || 0; // Default Sunday
			const stream2Time = await loadGlobalSetting('stream2Time') || savedSundayTime;
			const stream2DateMode = await loadGlobalSetting('stream2DateMode') || 'auto';
			const stream2CustomDate = await loadGlobalSetting('stream2CustomDate') || '';
			
			const dayNamesSchedule = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
			if (stream1Time && stream1Time !== 'N/A') {
				const saturdayElement = document.getElementById('saturdaySchedule');
				if (saturdayElement) {
					let dayLabel = dayNamesSchedule[parseInt(stream1Day, 10)] || '';
					if (stream1DateMode === 'custom' && stream1CustomDate) {
						const customDateObj = new Date(stream1CustomDate);
						if (!Number.isNaN(customDateObj.getTime())) {
							dayLabel = dayNamesSchedule[customDateObj.getDay()] || dayLabel;
						}
					}
					saturdayElement.textContent = `${dayLabel || 'Saturday'}, ${stream1Time}`;
				}
			}
			
			if (stream2Time && stream2Time !== 'N/A') {
				const sundayElement = document.getElementById('sundaySchedule');
				if (sundayElement) {
					let dayLabel = dayNamesSchedule[parseInt(stream2Day, 10)] || '';
					if (stream2DateMode === 'custom' && stream2CustomDate) {
						const customDateObj = new Date(stream2CustomDate);
						if (!Number.isNaN(customDateObj.getTime())) {
							dayLabel = dayNamesSchedule[customDateObj.getDay()] || dayLabel;
						}
					}
					sundayElement.textContent = `${dayLabel || 'Sunday'}, ${stream2Time}`;
				}
			}
			
			// Track loading state for simple coordination
			let avatarLoaded = false;
			let backgroundLoaded = false;
			
			// Simple function to check if we can hide loading screen
			function checkContentLoaded() {
				if (avatarLoaded && backgroundLoaded) {
					console.log('✅ All content loaded, hiding loading screen');
					setTimeout(() => {
						const loadingOverlay = document.getElementById('loadingOverlay');
						if (loadingOverlay) {
							loadingOverlay.classList.add('hide');
							setTimeout(() => {
								loadingOverlay.style.display = 'none';
								// Show all database-dependent content
								document.body.classList.remove('db-loading');
								document.body.classList.add('db-loaded');
							}, 600);
						}
					}, 300);
				}
			}
			
			// Handle profile picture
			const avatarImg = document.querySelector('.avatar img');
			const avatar = document.querySelector('.avatar');
			if (avatarImg && avatar) {
				if (savedPic && savedPic !== 'N/A') {
					console.log('✅ Applying global profile picture to ALL visitors');
					avatarImg.src = savedPic;
					avatarImg.onload = function() {
						avatar.classList.add('loaded'); // Show avatar after image loads
						avatarLoaded = true;
						checkContentLoaded();
						setProfilePreviewImage(savedPic);
					};
					avatarImg.onerror = function() {
						console.log('❌ Global profile pic failed to load, reverting to default');
						this.src = DEFAULT_PROFILE_PIC;
						avatar.classList.add('loaded');
						avatarLoaded = true;
						saveGlobalSetting('profile-pic', 'N/A');
						setProfilePreviewImage(DEFAULT_PROFILE_PIC);
						checkContentLoaded();
					};
				} else {
					// Use default image
					avatarImg.src = DEFAULT_PROFILE_PIC;
					avatarImg.onload = function() {
						avatar.classList.add('loaded');
						avatarLoaded = true;
						checkContentLoaded();
					};
					setProfilePreviewImage(DEFAULT_PROFILE_PIC);
				}
			} else {
				avatarLoaded = true; // No avatar to load
			}
			
			// Handle background
			if (savedBg && savedBg !== 'N/A') {
				console.log('✅ Applying global background to ALL visitors');
				const img = new Image();
				img.onload = function() {
					document.body.style.background = `url('${savedBg}') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
					pageEffectsRoot.style.background = document.body.style.background;
					console.log('🎨 Global background applied successfully');
					backgroundLoaded = true;
					checkContentLoaded();
				};
				img.onerror = function() {
					console.log('❌ Global background failed to load, reverting to default');
					document.body.style.background = `url('https://ilyambr.me/img/bg.jpg') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
					pageEffectsRoot.style.background = document.body.style.background;
					backgroundLoaded = true;
					saveGlobalSetting('background', 'Default');
					checkContentLoaded();
				};
				img.src = savedBg;
			} else {
				// Use default background
				document.body.style.background = `url('https://ilyambr.me/img/bg.jpg') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
				pageEffectsRoot.style.background = document.body.style.background;
				backgroundLoaded = true;
				checkContentLoaded();
			}
			
			if (savedVideo && savedVideo !== 'N/A') {
				// Apply custom YouTube video for ALL visitors
				console.log('✅ Applying global YouTube video to ALL visitors');
				updateYouTubeEmbed(savedVideo);
				youtubeVideoLoaded = true; // Mark as loaded
			} else {
				// Use auto-latest for ALL visitors
				loadLatestYouTubeVideo();
			}
			
			// Load and apply theme tint if saved
			const savedTint = await loadGlobalSetting('themeTint');
			if (savedTint && savedTint !== 'N/A') {
				let tint = null;
				try {
					tint = (typeof savedTint === 'string') ? JSON.parse(savedTint) : savedTint;
				} catch(e) { console.warn('Failed to parse themeTint (string):', e, savedTint); }
				if (tint && typeof tint === 'object') {
					console.log('🎨 Applying saved themeTint:', tint);
					applyThemeTint(tint);
					// also update controls if present
					if (document.getElementById('tintMode')) {
						document.getElementById('tintMode').value = tint.mode || 'none';
						updateTintRows();
						if (tint.mode === 'solid') {
							document.getElementById('tintColor1').value = tint.color1 || '#9146ff';
							const op1 = (typeof tint.opacity === 'number' && tint.opacity > 1) ? tint.opacity : Math.round((tint.opacity ?? 0.35) * 100);
							document.getElementById('tintOpacity').value = op1;
						} else if (tint.mode === 'gradient') {
							document.getElementById('tintColorG1').value = tint.color1 || '#9146ff';
							document.getElementById('tintColorG2').value = tint.color2 || '#3a86ff';
							document.getElementById('tintDirection').value = tint.direction || 'to bottom';
							const op2 = (typeof tint.opacity === 'number' && tint.opacity > 1) ? tint.opacity : Math.round((tint.opacity ?? 0.35) * 100);
							document.getElementById('tintOpacityG').value = op2;
						}
					}
				}
			}

			// Load site colors (CSS variables)
			const savedColors = await loadGlobalSetting('siteColors');
			if (savedColors && savedColors !== 'N/A') {
				try {
					const colors = (typeof savedColors === 'string') ? JSON.parse(savedColors) : savedColors;
					if (colors && typeof colors === 'object') {
						Object.entries(colors).forEach(([k,v])=>{
							document.documentElement.style.setProperty(k, v);
						});
						console.log('🎨 Applied site colors from DB');
					}
				} catch(e) { console.warn('Failed to parse siteColors:', e); }
			}

			// Load and apply global website effects
			await loadGlobalEffects();
		}

		function updateYouTubeEmbed(videoId) {
			console.log('🎥 Updating YouTube embed with video ID:', videoId);
			const youtubeEmbed = document.getElementById('youtube-embed');
			console.log('Found YouTube embed element:', youtubeEmbed);
			
			if (youtubeEmbed) {
				youtubeEmbed.outerHTML = `
					<iframe 
						id="youtube-embed"
						class="embed-frame hidden" 
						width="100%" 
						height="100%" 
						src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=0&controls=1&cc_load_policy=0&enablejsapi=0&fs=1&hd=1&iv_load_policy=3&modestbranding=1&playsinline=1&rel=0&vq=hd1080" 
						frameborder="0" 
						allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
						allowfullscreen>
					</iframe>
				`;
				console.log('✅ Updated YouTube embed with video ID:', videoId);
				
				// Re-get the element after outerHTML replacement and check if it's visible when YouTube tab is active
				const newYoutubeEmbed = document.getElementById('youtube-embed');
				const youtubeButton = document.querySelector('.stream-switch[onclick*="youtube"]');
				if (youtubeButton && youtubeButton.classList.contains('active')) {
					console.log('YouTube tab is active, removing hidden class');
					newYoutubeEmbed.classList.remove('hidden');
				}
			} else {
				console.error('❌ YouTube embed element not found!');
			}
		}

		// Admin Panel Functions
		async function loadCurrentSettings() {
			document.getElementById('adminUserName').textContent = `Welcome, ${adminUser.name}`;
			
			// Load current GLOBAL settings
			const currentDisplayName = await loadGlobalSetting('display-name') || 'N/A';
			const currentUsername = await loadGlobalSetting('username') || 'N/A';
			const currentTwitchStatus = await loadGlobalSetting('twitchStatus') || '';
			const currentDiscordLink = await loadGlobalSetting('discordLink') || 'N/A';
			const currentPic = await loadGlobalSetting('profile-pic') || 'N/A';
			const currentBg = await loadGlobalSetting('background') || 'N/A';
			const currentVideo = await loadGlobalSetting('youtube-video') || 'N/A';
			const currentShortVideoRaw = await loadGlobalSetting('shortVideoEmbed') || '';
			const currentShortVideo = normalizeShortVideoConfig(currentShortVideoRaw);
			const currentPageLogo = await loadGlobalSetting('pageLogo') || '';
			const currentPageLogoSmall = await loadGlobalSetting('pageLogoSmall') || '';
			const currentPageLogoResolution = await loadGlobalSetting('pageLogoResolution') || '';
			const currentPageLogoSize = await loadGlobalSetting('pageLogoSize') || '';
			const currentLogoInvert = await loadGlobalSetting('logoInvert');
			const currentBio = await loadGlobalSetting('bioText') || '';
			const currentAboutTextRaw = await loadGlobalSetting('aboutText') || '';
			const currentAboutText = clampAboutText(currentAboutTextRaw);
			const currentStreamingYear = await loadGlobalSetting('streamingYear') || '';
			const currentFollowerCount = await loadGlobalSetting('followerCount') || '';
			const currentSubscriberCount = await loadGlobalSetting('subscriberCount') || '';
			const currentTwitchLink = await loadGlobalSetting('twitchLink') || '';
			const currentTwitchChannelSetting = await loadGlobalSetting('twitchChannel') || '';
			const currentYouTubeLink = await loadGlobalSetting('youtubeLink') || '';
			const currentTikTokLink = await loadGlobalSetting('tiktokLink') || '';
			const currentInstagramLink = await loadGlobalSetting('instagramLink') || '';
			const currentXLink = await loadGlobalSetting('xLink') || '';
			const currentRedditLink = await loadGlobalSetting('redditLink') || '';
			const currentFollowButtonText = await loadGlobalSetting('followButtonText') || '';
			const currentSubscribeButtonText = await loadGlobalSetting('subscribeButtonText') || '';
			
			// Load new schedule format (with fallback to old format)
			const stream1Day = await loadGlobalSetting('stream1Day') || 6; // Default Saturday
			const stream1Time = await loadGlobalSetting('stream1Time') || await loadGlobalSetting('saturdayTime') || '';
			const stream1DateMode = await loadGlobalSetting('stream1DateMode') || 'auto';
			const stream1CustomDate = await loadGlobalSetting('stream1CustomDate') || '';
			
			const stream2Day = await loadGlobalSetting('stream2Day') || 0; // Default Sunday  
			const stream2Time = await loadGlobalSetting('stream2Time') || await loadGlobalSetting('sundayTime') || '';
			const stream2DateMode = await loadGlobalSetting('stream2DateMode') || 'auto';
			const stream2CustomDate = await loadGlobalSetting('stream2CustomDate') || '';
			
			// Display current settings
			const setCurrentText = (id, value) => {
				const el = document.getElementById(id);
				if (el) el.textContent = value;
			};
			const currentHost = window.location.hostname || 'unknown';
			setCurrentText('adminUserName', `Welcome, ${adminUser.name} (Domain: ${currentHost})`);
			const shorten = (value, limit = 30, fallback = 'N/A') => {
				if (!value || value === 'N/A') return fallback;
				return value.length > limit ? `${value.substring(0, limit)}...` : value;
			};
			const formatLogoDisplay = (value) => {
				if (!value || value === 'N/A') return 'Default';
				return value.startsWith('data:') ? 'Uploaded image' : shorten(value);
			};

			setCurrentText('currentDisplayName', currentDisplayName && currentDisplayName !== 'N/A' ? currentDisplayName : 'N/A');
			setCurrentText('currentUsername', currentUsername && currentUsername !== 'N/A' ? currentUsername : 'N/A');
			const gameSettingsUsername = document.getElementById('gameSettingsUsername');
			if (gameSettingsUsername) {
				gameSettingsUsername.textContent = formatHandle(currentUsername);
			}
			setCurrentText('currentTwitchStatus', currentTwitchStatus ? currentTwitchStatus.charAt(0).toUpperCase() + currentTwitchStatus.slice(1) : 'None');
			const twitchStatusSelect = document.getElementById('twitchStatus');
			if (twitchStatusSelect) twitchStatusSelect.value = currentTwitchStatus;
			const sanitizedCurrentChannel = sanitizeTwitchChannel(currentTwitchChannelSetting) || 'ilyambrr';
			setCurrentText('currentTwitchChannel', sanitizedCurrentChannel);
			const twitchChannelInput = document.getElementById('twitchChannel');
			if (twitchChannelInput) twitchChannelInput.value = sanitizedCurrentChannel;
			setCurrentText('currentDiscordLink', shorten(currentDiscordLink));
			setCurrentText('currentProfilePic', shorten(currentPic, 50));
			setProfilePreviewImage(currentPic);
			setCurrentText('currentBackground', shorten(currentBg, 50));
			setCurrentText('currentYouTubeVideo', currentVideo || 'N/A');
			setCurrentText('currentShortVideo', formatShortVideoLabel(currentShortVideo));
			setCurrentText('currentPageLogo', formatLogoDisplay(currentPageLogo));
			setCurrentText('currentPageLogoSmall', formatLogoDisplay(currentPageLogoSmall));
			const mainLogoElement = document.getElementById('pageLogoImg');
			const adminLargePreviewSrc = currentPageLogo && currentPageLogo !== 'N/A'
				? currentPageLogo
				: (mainLogoElement ? mainLogoElement.src : '');
			const faviconLinkCurrent = document.querySelector('link[rel="icon"]');
			const adminSmallPreviewSrc = currentPageLogoSmall && currentPageLogoSmall !== 'N/A'
				? currentPageLogoSmall
				: (faviconLinkCurrent ? faviconLinkCurrent.href : '');
			setPageLogoPreviewImage('large', adminLargePreviewSrc);
			setPageLogoPreviewImage('small', adminSmallPreviewSrc);
			const pageLogoLargeHidden = document.getElementById('pageLogoLarge');
			if (pageLogoLargeHidden) {
				pageLogoLargeHidden.value = '';
				if (pageLogoLargeHidden.dataset) {
					delete pageLogoLargeHidden.dataset.filename;
				}
			}
			const pageLogoSmallHidden = document.getElementById('pageLogoSmall');
			if (pageLogoSmallHidden) {
				pageLogoSmallHidden.value = '';
				if (pageLogoSmallHidden.dataset) {
					delete pageLogoSmallHidden.dataset.filename;
				}
			}
			const resInput = document.getElementById('pageLogoResolution');
			if (resInput) resInput.value = currentPageLogoResolution;
			const sizeInput = document.getElementById('pageLogoSize');
			if (sizeInput) sizeInput.value = currentPageLogoSize || '135x135';
			const effectiveLogoInvert = (currentLogoInvert === null || currentLogoInvert === undefined) ? true : !!currentLogoInvert;
			const invToggle = document.getElementById('logoInvertToggle');
			if (invToggle) invToggle.checked = effectiveLogoInvert;
			applyLogoInvertState(effectiveLogoInvert);
			setCurrentText('currentBio', shorten(currentBio));
			setCurrentText('currentAboutText', shorten(currentAboutText, ABOUT_MAX_LENGTH));
			setCurrentText('currentStreamingYear', currentStreamingYear || 'N/A');
			setCurrentText('currentFollowerCount', currentFollowerCount || 'API');
			setCurrentText('currentSubscriberCount', currentSubscriberCount || 'API');
			setCurrentText('currentTwitchLink', shorten(currentTwitchLink));
			setCurrentText('currentYouTubeLink', shorten(currentYouTubeLink));
			setCurrentText('currentTikTokLink', shorten(currentTikTokLink));
			setCurrentText('currentInstagramLink', shorten(currentInstagramLink));
			setCurrentText('currentXLink', shorten(currentXLink));
			setCurrentText('currentRedditLink', shorten(currentRedditLink));
			setCurrentText('currentFollowButtonText', currentFollowButtonText || 'Follow');
			setCurrentText('currentSubscribeButtonText', currentSubscribeButtonText || 'Subscribe');
			const shortVideoInput = document.getElementById('shortVideoLink');
			if (shortVideoInput) shortVideoInput.value = currentShortVideo?.originalUrl || '';
			
			// Set schedule selector values
			const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
			
			const streamDay1Select = document.getElementById('streamDay1');
			const streamTime1Input = document.getElementById('streamTime1');
			const streamDateMode1Select = document.getElementById('streamDateMode1');
			const streamCustomDate1Input = document.getElementById('streamCustomDate1');
			
			const streamDay2Select = document.getElementById('streamDay2');
			const streamTime2Input = document.getElementById('streamTime2');
			const streamDateMode2Select = document.getElementById('streamDateMode2');
			const streamCustomDate2Input = document.getElementById('streamCustomDate2');
			
			if (streamDay1Select) {
				streamDay1Select.value = stream1Day;
				streamDateMode1Select.value = stream1DateMode;
				if (stream1DateMode === 'custom') {
					streamCustomDate1Input.style.display = 'block';
					streamCustomDate1Input.value = stream1CustomDate;
				}
			}
			
			if (streamDay2Select) {
				streamDay2Select.value = stream2Day;
				streamDateMode2Select.value = stream2DateMode;
				if (stream2DateMode === 'custom') {
					streamCustomDate2Input.style.display = 'block';
					streamCustomDate2Input.value = stream2CustomDate;
				}
			}
			
			// Display current Firebase database URL
			setCurrentText('currentFirebaseUrl', firebaseConfig.databaseURL || 'N/A');
		}
			
		if (savedVideo && savedVideo !== 'N/A') {
			// Apply custom YouTube video
			updateYouTubeEmbed(savedVideo);
		} else {
			// Use auto-latest
			loadLatestYouTubeVideo();
		}

		async function updateProfilePicture() {
			const url = document.getElementById('profilePicture').value.trim();
			if (!url) {
				notify.error('Please enter a valid image URL.');
				return;
			}

			// Test if image loads before applying GLOBALLY
			const img = new Image();
			img.onload = async function() {
				// Image loaded successfully - save GLOBALLY for ALL users
				await saveGlobalSetting('profile-pic', url);
				
				// Apply to all avatar images immediately
				const avatarImgs = document.querySelectorAll('.avatar img');
				avatarImgs.forEach(img => img.src = url);
				setProfilePreviewImage(url);
				
				// Update current settings display
				document.getElementById('currentProfilePic').textContent = url.substring(0, 50) + (url.length > 50 ? '...' : '');
				document.getElementById('profilePicture').value = '';
			
				notify.success('Profile picture updated for every visitor.');
			};
			img.onerror = function() {
				notify.error('Failed to load image. Please check the URL and try again.');
			};
			img.src = url;
		}

		async function updateBackgroundImage() {
			const url = document.getElementById('backgroundImage').value.trim();
			if (!url) {
				notify.error('Please enter a valid image URL.');
				return;
			}

			// Test if image loads before applying GLOBALLY
			const img = new Image();
			img.onload = async function() {
				// Image loaded successfully - save GLOBALLY for ALL users
				await saveGlobalSetting('background', url);
				
				// Apply background immediately
				document.body.style.background = `url('${url}') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
				pageEffectsRoot.style.background = document.body.style.background;
				
				// Update current settings display
				document.getElementById('currentBackground').textContent = url.substring(0, 50) + (url.length > 50 ? '...' : '');
				document.getElementById('backgroundImage').value = '';
			
				notify.success('Background image updated for everyone.');
			};
			img.onerror = function() {
				notify.error('Failed to load image. Please check the URL and try again.');
			};
			img.src = url;
		}

		async function updateDisplayName() {
			const displayName = document.getElementById('displayName').value.trim();
			if (!displayName) {
				notify.error('Please enter a display name.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('display-name', displayName);
			
			// Update all instances of display name on the page
			const nameElements = document.querySelectorAll('.name, h1, .profile-name');
			nameElements.forEach(element => {
				if (element.textContent.includes('ilyambr') || element.textContent === 'ilyambr') {
					element.textContent = displayName;
				}
			});
			
			// Also update the page title
			document.title = displayName;
			// Update popup titles
			setPopupTitles(displayName);
			
			// Update current settings display
			document.getElementById('currentDisplayName').textContent = displayName;
			document.getElementById('displayName').value = '';
			
			notify.success('Display name updated globally.');
		}

		async function updateUsername() {
			const username = document.getElementById('username').value.trim();
			if (!username) {
				notify.error('Please enter a username.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('username', username);
			
			// Update all instances of username on the page
			const usernameElements = document.querySelectorAll('.username, .handle, .user-handle');
			usernameElements.forEach(element => {
				element.textContent = username;
			});
			
			// SAFE way to update @ilyambrr in content only
			// Only target visible content elements, exclude script/style/head
			const contentElements = document.querySelectorAll('div.username, span.username, p.username, .bio, .title');
			contentElements.forEach(element => {
				// Only update if it's not inside a script or style tag
				if (!element.closest('script') && !element.closest('style') && !element.closest('head')) {
					if (element.textContent && element.textContent.includes('@ilyambrr')) {
						element.textContent = element.textContent.replace('@ilyambrr', username);
					}
				}
			});
			const gameSettingsUsername = document.getElementById('gameSettingsUsername');
			if (gameSettingsUsername) {
				gameSettingsUsername.textContent = formatHandle(username);
			}
			
			// Update current settings display
			document.getElementById('currentUsername').textContent = username;
			document.getElementById('username').value = '';
			
			// Refresh Twitch followers with new username
			console.log('🔄 Username changed, refreshing Twitch followers...');
			updateTwitchFollowers();
			
			notify.success('Username updated globally.');
		}

		async function updateTwitchStatus() {
			const status = document.getElementById('twitchStatus').value;
			const statusText = status || 'None';

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('twitchStatus', status);
			
			// Update the badge display immediately
			const statusBadge = document.getElementById('twitchStatusBadge');
			if (statusBadge) {
				if (status) {
					let statusText = status.charAt(0).toUpperCase() + status.slice(1);
					if (status === 'verified') {
						statusText += ' <img src="https://ilyambr.me/img/checkmark.svg" style="width: 12px; height: 12px; margin-left: 4px; filter: invert(1); vertical-align: middle;" alt="✓">';
					}
					statusBadge.innerHTML = statusText;
					statusBadge.style.display = 'block'; // Show the badge
				} else {
					statusBadge.style.display = 'none'; // Hide the badge
				}
			}
			
			// Update current settings display
			document.getElementById('currentTwitchStatus').textContent = statusText.charAt(0).toUpperCase() + statusText.slice(1);
			
			console.log(`Twitch status updated to: ${statusText}`);
			notify.success(`Twitch status updated globally to ${statusText}.`);
		}

		async function updateDiscordLink() {
			const discordUrl = document.getElementById('discordLink').value.trim();
			if (!discordUrl) {
				notify.error('Please enter a Discord link.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('discordLink', discordUrl);
			
			// Update all Discord links immediately
			const discordLinks = document.querySelectorAll('a[href*="discord"]');
			discordLinks.forEach(link => {
				link.href = discordUrl;
			});
			
			// Update current settings display
			const shortUrl = discordUrl.length > 30 ? discordUrl.substring(0, 30) + '...' : discordUrl;
			document.getElementById('currentDiscordLink').textContent = shortUrl;
			document.getElementById('discordLink').value = '';
			
			console.log(`Discord link updated to: ${discordUrl}`);
			notify.success('Discord link updated globally.');
		}

		async function updatePageLogo() {
			const largeInput = document.getElementById('pageLogoLarge');
			const smallInput = document.getElementById('pageLogoSmall');
			const largeFileName = largeInput?.dataset?.filename || '';
			const smallFileName = smallInput?.dataset?.filename || '';
			const largeData = (largeInput?.value || '').trim();
			const smallData = (smallInput?.value || '').trim();
			const resolution = (document.getElementById('pageLogoResolution').value || '').trim();
			const sizeStr = (document.getElementById('pageLogoSize').value || '').trim();

			if (!largeData && !smallData && !resolution && !sizeStr) {
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Upload a logo or adjust the fields before saving.');
				}
				return;
			}

			if (resolution && !/^\d{2,5}x\d{2,5}$/i.test(resolution)) {
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Resolution must use the format 1920x1080.');
				}
				return;
			}
			if (sizeStr && !/^\d{2,5}x\d{2,5}$/i.test(sizeStr)) {
				if (typeof notify !== 'undefined' && typeof notify.error === 'function') {
					notify.error('Size must use the format 135x135.');
				}
				return;
			}

			const savePromises = [];
			if (largeData) {
				savePromises.push(saveGlobalSetting('pageLogo', largeData));
				savePromises.push(saveGlobalSetting('pageLogoLarge', largeData));
			}
			if (smallData) {
				savePromises.push(saveGlobalSetting('pageLogoSmall', smallData));
			}
			if (resolution) {
				savePromises.push(saveGlobalSetting('pageLogoResolution', resolution));
			}
			if (sizeStr) {
				savePromises.push(saveGlobalSetting('pageLogoSize', sizeStr));
			}
			await Promise.all(savePromises);

			if (largeData) {
				const logoElement = document.getElementById('pageLogoImg');
				if (logoElement) {
					logoElement.src = largeData;
				}
				setPageLogoPreviewImage('large', largeData);
			}
			if (smallData) {
				const faviconLink = document.querySelector('link[rel="icon"]');
				if (faviconLink) {
					faviconLink.href = smallData;
				}
				setPageLogoPreviewImage('small', smallData);
			}
			if (sizeStr) {
				const [w, h] = sizeStr.toLowerCase().split('x');
				const logoBox = document.querySelector('.page-logo');
				if (logoBox) {
					logoBox.style.width = w + 'px';
					logoBox.style.height = h + 'px';
				}
			}

			const statusLarge = document.getElementById('currentPageLogo');
			if (statusLarge && largeData) {
				statusLarge.textContent = largeData.startsWith('data:') ? 'Uploaded image' : (largeData.length > 30 ? `${largeData.substring(0, 30)}...` : largeData);
			}
			const statusSmall = document.getElementById('currentPageLogoSmall');
			if (statusSmall && smallData) {
				statusSmall.textContent = smallData.startsWith('data:') ? 'Uploaded image' : (smallData.length > 30 ? `${smallData.substring(0, 30)}...` : smallData);
			}

			if (largeInput) {
				largeInput.value = '';
				if (largeInput.dataset) {
					delete largeInput.dataset.filename;
				}
			}
			if (smallInput) {
				smallInput.value = '';
				if (smallInput.dataset) {
					delete smallInput.dataset.filename;
				}
			}
			document.getElementById('pageLogoResolution').value = '';
			document.getElementById('pageLogoSize').value = '';

			if (typeof notify !== 'undefined' && typeof notify.success === 'function') {
				notify.success('Page logos updated globally.');
			}
		}

		function applyLogoInvertState(shouldInvert) {
			const logoElement = document.getElementById('pageLogoImg');
			if (shouldInvert) {
				document.body.classList.remove('logo-no-invert');
				if (logoElement) {
					logoElement.style.filter = 'invert(100%)';
				}
			} else {
				document.body.classList.add('logo-no-invert');
				if (logoElement) {
					logoElement.style.filter = 'none';
				}
			}
			updateAdminLogoPreviewInvert(shouldInvert);
		}

		async function updateLogoInvert() {
			const checked = document.getElementById('logoInvertToggle').checked;
			await saveGlobalSetting('logoInvert', checked);
			applyLogoInvertState(checked);
			console.log('Logo invert set to:', checked);
		}

		async function updateBio() {
			const bio = document.getElementById('bioTextInput').value.trim();
			if (!bio) {
				notify.error('Please enter a bio.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('bioText', bio);
			
			// Update bio immediately
			const bioElement = document.querySelector('.bio');
			if (bioElement) {
				bioElement.textContent = bio;
			}
			
			// Update current settings display
			document.getElementById('currentBio').textContent = bio.length > 30 ? bio.substring(0, 30) + '...' : bio;
			document.getElementById('bioTextInput').value = '';
			
			notify.success('Bio updated globally.');
		}

		async function updateAboutText() {
			const aboutTextInput = document.getElementById('aboutText');
			const aboutTextRaw = aboutTextInput.value.trim();
			if (!aboutTextRaw) {
				notify.error('Please enter some About text.');
				return;
			}
			if (aboutTextRaw.length > ABOUT_MAX_LENGTH) {
				notify.error(`About text must be ${ABOUT_MAX_LENGTH} characters or fewer.`);
				return;
			}
			const aboutText = clampAboutText(aboutTextRaw);

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('aboutText', aboutText);
			
			// Update about text immediately
			const aboutElement = document.getElementById('aboutTextContent');
			if (aboutElement) {
				aboutElement.textContent = aboutText;
			}
			
			// Update current settings display
			document.getElementById('currentAboutText').textContent = aboutText;
			aboutTextInput.value = '';
			
			notify.success('About section updated globally.');
		}

		async function updateStreamingYear() {
			const year = document.getElementById('streamingYear').value.trim();
			if (!year) {
				notify.error('Please enter the streaming start year.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('streamingYear', year);
			
			// Update streaming year immediately
			const yearElement = document.getElementById('streamingYearStat');
			if (yearElement) {
				yearElement.textContent = `Streaming since ${year}`;
			}
			
			// Update current settings display
			document.getElementById('currentStreamingYear').textContent = year;
			document.getElementById('streamingYear').value = '';
			
			notify.success('Streaming year updated globally.');
		}

		async function updateFollowerCount() {
			const count = document.getElementById('followerCount').value.trim();
			
			// Save GLOBALLY for ALL users (empty string for API mode)
			await saveGlobalSetting('followerCount', count);
			
			// Update followers immediately
			const followerElement = document.getElementById('twitchFollowersStat');
			if (followerElement) {
				if (count) {
					followerElement.innerHTML = `
						<img src="https://static.wixstatic.com/media/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png/v1/fill/w_20,h_20,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/11062b_33ebef7d3c404a0baa46a0ec8b83cd51~mv2.png" alt="Twitch" style="filter: invert(100%);"/>
						${formatNumber(parseInt(count))} followers
					`;
				} else {
					// Use API
					updateTwitchFollowers();
				}
			}
			
			// Update current settings display
			document.getElementById('currentFollowerCount').textContent = count || 'API';
			document.getElementById('followerCount').value = '';
			
			if (count) {
				notify.success('Follower count updated globally.');
			} else {
				notify.info('Follower count now uses the live API globally.');
			}
		}

		async function updateSubscriberCount() {
			const count = document.getElementById('subscriberCount').value.trim();
			
			// Save GLOBALLY for ALL users (empty string for API mode)
			await saveGlobalSetting('subscriberCount', count);
			
			// Update subscribers immediately
			const subscriberElement = document.getElementById('youtubeSubscribersStat');
			if (subscriberElement) {
				if (count) {
					subscriberElement.innerHTML = `
						<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" alt="YouTube" style="filter: invert(100%);"/>
						${formatNumber(parseInt(count))} subs
					`;
				} else {
					// Use API
					updateYouTubeSubscribers();
				}
			}
			
			// Update current settings display
			document.getElementById('currentSubscriberCount').textContent = count || 'API';
			document.getElementById('subscriberCount').value = '';
			
			if (count) {
				notify.success('Subscriber count updated globally.');
			} else {
				notify.info('Subscriber count now uses the live API globally.');
			}
		}

		async function updateTwitchLink() {
			const url = document.getElementById('twitchLink').value.trim();
			if (!url) {
				notify.error('Please enter a Twitch URL.');
				return;
			}

			await saveGlobalSetting('twitchLink', url);
			updateSocialLink('twitch', url);
			document.getElementById('twitchLink').value = '';
			notify.success('Twitch link updated globally.');
		}

		async function updateYouTubeLink() {
			const url = document.getElementById('youtubeLink').value.trim();
			if (!url) {
				notify.error('Please enter a YouTube URL.');
				return;
			}

			await saveGlobalSetting('youtubeLink', url);
			updateSocialLink('youtube', url);
			document.getElementById('youtubeLink').value = '';
			notify.success('YouTube link updated globally.');
		}

		async function updateTwitchChannel() {
			const input = document.getElementById('twitchChannel');
			if (!input) return;
			const rawValue = input.value.trim();
			if (!rawValue) {
				notify.error('Please enter a Twitch channel name.');
				return;
			}

			const channel = sanitizeTwitchChannel(rawValue);
			if (!channel) {
				notify.error('Invalid Twitch channel name.');
				return;
			}

			await saveGlobalSetting('twitchChannel', channel);
			applyTwitchChannel(channel);
			const currentChannelEl = document.getElementById('currentTwitchChannel');
			if (currentChannelEl) currentChannelEl.textContent = channel;
			input.value = '';
			notify.success('Twitch channel updated globally.');
			updateTwitchFollowers();
		}

		async function updateTikTokLink() {
			const url = document.getElementById('tiktokLink').value.trim();
			if (!url) {
				notify.error('Please enter a TikTok URL.');
				return;
			}

			await saveGlobalSetting('tiktokLink', url);
			updateSocialLink('tiktok', url);
			document.getElementById('tiktokLink').value = '';
			notify.success('TikTok link updated globally.');
		}

		async function updateInstagramLink() {
			const url = document.getElementById('instagramLink').value.trim();
			if (!url) {
				notify.error('Please enter an Instagram URL.');
				return;
			}

			await saveGlobalSetting('instagramLink', url);
			updateSocialLink('instagram', url);
			document.getElementById('instagramLink').value = '';
			notify.success('Instagram link updated globally.');
		}

		async function updateXLink() {
			const url = document.getElementById('xLink').value.trim();
			if (!url) {
				notify.error('Please enter an X URL.');
				return;
			}

			await saveGlobalSetting('xLink', url);
			updateSocialLink('x', url);
			document.getElementById('xLink').value = '';
			notify.success('X link updated globally.');
		}

		async function updateRedditLink() {
			const url = document.getElementById('redditLink').value.trim();
			if (!url) {
				notify.error('Please enter a Reddit URL.');
				return;
			}

			await saveGlobalSetting('redditLink', url);
			updateSocialLink('reddit', url);
			document.getElementById('redditLink').value = '';
			notify.success('Reddit link updated globally.');
		}

		function updateSocialLink(platform, url) {
			// Update social bar links using specific IDs
			const linkMap = {
				'twitch': 'twitchSocialLink',
				'youtube': 'youtubeSocialLink',
				'tiktok': 'tiktokSocialLink',
				'discord': 'discordSocialLink',
				'instagram': 'instagramSocialLink',
				'x': 'xSocialLink',
				'reddit': 'redditSocialLink'
			};
			
			const linkId = linkMap[platform.toLowerCase()];
			if (linkId) {
				const socialLink = document.getElementById(linkId);
				if (socialLink) {
					socialLink.href = url;
				}
			}
		}

		async function updateFollowButton() {
			const text = document.getElementById('followButtonText').value.trim();
			if (!text) {
				notify.error('Please enter follow button text.');
				return;
			}

			await saveGlobalSetting('followButtonText', text);
			
			const followButton = document.getElementById('followButton');
			if (followButton) {
				followButton.innerHTML = `
					<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<path d="m19 8 2 2-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<path d="m21 10-7.5 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					${text}
				`;
			}
			
			document.getElementById('followButtonText').value = '';
			notify.success('Follow button updated globally.');
		}

		async function updateSubscribeButton() {
			const text = document.getElementById('subscribeButtonText').value.trim();
			if (!text) {
				notify.error('Please enter subscribe button text.');
				return;
			}

			await saveGlobalSetting('subscribeButtonText', text);
			
			const subscribeButton = document.getElementById('subscribeButton');
			if (subscribeButton) {
				subscribeButton.innerHTML = `
					<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<path d="m19 8 2 2-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<path d="m21 10-7.5 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					${text}
				`;
			}
			
			document.getElementById('subscribeButtonText').value = '';
			notify.success('Subscribe button updated globally.');
		}

		async function updateStreamSchedule(streamNumber) {
			const daySelect = document.getElementById(`streamDay${streamNumber}`);
			const timeInput = document.getElementById(`streamTime${streamNumber}`);
			const dateModeSelect = document.getElementById(`streamDateMode${streamNumber}`);
			const customDateInput = document.getElementById(`streamCustomDate${streamNumber}`);
			
			const selectedDay = parseInt(daySelect.value);
			const time = timeInput.value.trim();
			const dateMode = dateModeSelect.value;
			const customDate = customDateInput.value;
			
			if (!time) {
				notify.error(`Please enter stream ${streamNumber} time.`);
				return;
			}

			// Save settings
			await saveGlobalSetting(`stream${streamNumber}Day`, selectedDay);
			await saveGlobalSetting(`stream${streamNumber}Time`, time);
			await saveGlobalSetting(`stream${streamNumber}DateMode`, dateMode);
			if (dateMode === 'custom' && customDate) {
				await saveGlobalSetting(`stream${streamNumber}CustomDate`, customDate);
			}
			
			// Update display
			const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
			const scheduleElement = document.getElementById(streamNumber === 1 ? 'saturdaySchedule' : 'sundaySchedule');
			
			if (scheduleElement) {
				let dayLabel = dayNames[selectedDay] || '';
				if (dateMode === 'custom' && customDate) {
					const customDateObj = new Date(customDate);
					if (!Number.isNaN(customDateObj.getTime())) {
						dayLabel = dayNames[customDateObj.getDay()] || dayLabel;
					}
				}
				scheduleElement.textContent = `${dayLabel || 'TBD'}, ${time}`;
			}
			
			timeInput.value = '';
			notify.success(`Stream ${streamNumber} schedule updated globally.`);
		}

		// Keep old functions for backward compatibility but make them call the new function
		async function updateSaturdayTime() {
			// Try new format first, fallback to old
			const newTimeInput = document.getElementById('streamTime1');
			const oldTimeInput = document.getElementById('saturdayTime');
			
			if (newTimeInput && newTimeInput.value.trim()) {
				await updateStreamSchedule(1);
			} else if (oldTimeInput && oldTimeInput.value.trim()) {
				// Old format compatibility
				const time = oldTimeInput.value.trim();
				await saveGlobalSetting('stream1Day', 6); // Saturday
				await saveGlobalSetting('stream1Time', time);
				await saveGlobalSetting('stream1DateMode', 'auto');
				
				const saturdayElement = document.getElementById('saturdaySchedule');
				if (saturdayElement) {
					const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
					saturdayElement.textContent = `${dayNames[6]}, ${time}`;
				}
				oldTimeInput.value = '';
				notify.success('Saturday schedule updated globally.');
			} else {
				notify.error('Please enter Saturday stream time.');
			}
		}

		async function updateSundayTime() {
			// Try new format first, fallback to old
			const newTimeInput = document.getElementById('streamTime2');
			const oldTimeInput = document.getElementById('sundayTime');
			
			if (newTimeInput && newTimeInput.value.trim()) {
				await updateStreamSchedule(2);
			} else if (oldTimeInput && oldTimeInput.value.trim()) {
				// Old format compatibility
				const time = oldTimeInput.value.trim();
				await saveGlobalSetting('stream2Day', 0); // Sunday
				await saveGlobalSetting('stream2Time', time);
				await saveGlobalSetting('stream2DateMode', 'auto');
				
				const sundayElement = document.getElementById('sundaySchedule');
				if (sundayElement) {
					const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
					sundayElement.textContent = `${dayNames[0]}, ${time}`;
				}
				oldTimeInput.value = '';
				notify.success('Sunday schedule updated globally.');
			} else {
				notify.error('Please enter Sunday stream time.');
			}
		}

		async function updateYouTubeVideo() {
			const videoId = document.getElementById('youtubeVideoId').value.trim();
			if (!videoId) {
				notify.error('Please enter a YouTube video ID.');
				return;
			}

			// Validate video ID format (basic check)
			if (videoId.length < 8 || videoId.length > 15) {
				notify.error('Invalid YouTube video ID format. Use 8-15 characters.');
				return;
			}

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('youtube-video', videoId);
			
			// Update the YouTube embed immediately
			updateYouTubeEmbed(videoId);
			
			// Update current settings display
			document.getElementById('currentYouTubeVideo').textContent = videoId;
			document.getElementById('youtubeVideoId').value = '';
		
			notify.success('Featured YouTube video updated globally.');
		}

		async function updateShortVideoEmbed() {
			const input = document.getElementById('shortVideoLink');
			if (!input) return;
			const link = input.value.trim();
			if (!link) {
				notify.error('Please paste a TikTok or YouTube Shorts link.');
				return;
			}

			const parsed = parseShortVideoLink(link);
			if (!parsed) {
				notify.error('Unsupported link. Use a valid YouTube Shorts or TikTok URL.');
				return;
			}

			input.value = parsed.originalUrl;
			await saveGlobalSetting('shortVideoEmbed', JSON.stringify(parsed));
			applyShortVideoEmbed(parsed);
			const currentShortVideoEl = document.getElementById('currentShortVideo');
			if (currentShortVideoEl) currentShortVideoEl.textContent = formatShortVideoLabel(parsed);
			notify.success('Featured short video updated globally.');
		}

		async function clearShortVideoEmbed() {
			const confirmed = await showConfirm('Remove the featured short video for all visitors?', {
				title: 'Remove featured short',
				confirmText: 'Remove video',
				cancelText: 'Keep featured video',
				type: 'warning'
			});
			if (!confirmed) return;
			await saveGlobalSetting('shortVideoEmbed', 'N/A');
			applyShortVideoEmbed(null);
			const currentShortVideoEl = document.getElementById('currentShortVideo');
			if (currentShortVideoEl) currentShortVideoEl.textContent = 'None';
			const input = document.getElementById('shortVideoLink');
			if (input) input.value = '';
			notify.info('Featured short video cleared.');
		}

		async function updateFirebaseDatabase() {
			const newDatabaseUrl = document.getElementById('firebaseDatabaseUrl').value.trim();
			const siteName = getSelectedSiteLabel();
			
			if (!newDatabaseUrl) {
				notify.error('Please enter a Firebase database URL.');
				return;
			}
			
			// Confirm the change
			const confirmed = await showConfirm(`Switch Firebase database to ${newDatabaseUrl}?`, {
				title: 'Add database URL to history',
				confirmText: 'Add to history',
				cancelText: 'Cancel',
				type: 'warning'
			});
		
			if (!confirmed) return;
			
			try {
				// Build entry and save ONLY to history (no activation, no reload)
				const hostKey = normalizeHost(siteName === 'auto' ? (window.location.hostname || '') : siteName);
				const entry = { url: newDatabaseUrl, site: hostKey || 'auto', by: adminUser?.email || 'unknown', at: Date.now() };
				await appendFirebaseHistoryEntry(entry);
				if (typeof firebase !== 'undefined') {
					const defaultAppName = 'defaultProbeWrite';
					const existing = firebase.apps?.find(a => a.name === defaultAppName);
					const defaultApp = existing || firebase.initializeApp({ ...firebaseConfig, databaseURL: defaultDatabaseUrl }, defaultAppName);
					await mirrorHistoryToDefaultDb(defaultApp.database(), entry);
				}
				// Clear input and re-render history so user can click Activate
				document.getElementById('firebaseDatabaseUrl').value = '';
				renderFirebaseHistory();
				notify.success('Database URL added to history. Click Activate to switch for everyone.');
			} catch (error) {
				console.error('Error updating Firebase database:', error);
				notify.error('Error adding to history. Please try again.');
			}
		}

		function onFirebaseSiteChange() {
			const sel = document.getElementById('firebaseSiteName');
			const custom = document.getElementById('firebaseSiteCustom');
			if (!sel || !custom) return;
			custom.style.display = sel.value === 'custom' ? 'inline-block' : 'none';
		}

		function getSelectedSiteLabel() {
			const sel = document.getElementById('firebaseSiteName');
			const custom = document.getElementById('firebaseSiteCustom');
			if (!sel) return window.location.hostname || 'auto';
			if (sel.value === 'auto') return window.location.hostname || 'auto';
			if (sel.value === 'custom') return (custom?.value?.trim() || 'custom');
			return sel.value;
		}

		async function appendFirebaseHistoryEntry(entry) {
			try {
				// Load existing list
				let listRaw = await loadGlobalSetting('firebaseDbHistory');
				let list = [];
				try { if (listRaw && listRaw !== 'N/A') list = JSON.parse(listRaw); } catch(e) {}
				list.unshift(entry);
				// Cap to last 10 entries
				list = list.slice(0, 10);
				await saveGlobalSetting('firebaseDbHistory', JSON.stringify(list));
				renderFirebaseHistory(list);
			} catch(e) {
				console.warn('Failed to append history:', e);
			}
		}

		async function upsertActiveMap(entry){
			try {
				let raw = await loadGlobalSetting('firebaseDbActiveMap');
				let map = {};
				try { if (raw && raw !== 'N/A') map = JSON.parse(raw); } catch {}
				const key = normalizeHost(entry.site || window.location.hostname || '');
				map[key || 'auto'] = { url: entry.url, by: entry.by, at: entry.at };
				await saveGlobalSetting('firebaseDbActiveMap', JSON.stringify(map));
			} catch(e) { console.warn('Failed to upsert active map:', e); }
		}

		async function mirrorActiveMapToDefaultDb(defaultDb, entry){
			try {
				const snap = await defaultDb.ref('siteSettings/firebaseDbActiveMap').once('value');
				let map = snap.val();
				if (!map || typeof map !== 'object') {
					try { map = JSON.parse(map); } catch { map = {}; }
				}
				const key = normalizeHost(entry.site || window.location.hostname || '');
				map[key || 'auto'] = { url: entry.url, by: entry.by, at: entry.at };
				await defaultDb.ref('siteSettings/firebaseDbActiveMap').set(map);
			} catch(e) { console.warn('Failed to mirror active map:', e); }
		}

		async function mirrorHistoryToDefaultDb(defaultDb, entry) {
			try {
				const snap = await defaultDb.ref('siteSettings/firebaseDbHistory').once('value');
				let list = snap.val();
				if (!Array.isArray(list)) {
					try { list = JSON.parse(list); } catch { list = []; }
				}
				list.unshift(entry);
				list = list.slice(0, 10);
				await defaultDb.ref('siteSettings/firebaseDbHistory').set(list);
			} catch(e) {
				console.warn('Failed to mirror history to default DB:', e);
			}
		}

		async function renderFirebaseHistory(existingList) {
			const container = document.getElementById('firebaseDbHistory');
			if (!container) return;
			try {
				let list = existingList;
				if (!list) {
					const raw = await loadGlobalSetting('firebaseDbHistory');
					if (raw && raw !== 'N/A') {
						try { list = JSON.parse(raw); } catch { list = []; }
					} else list = [];
				}
				if (!Array.isArray(list)) list = [];
				if (list.length === 0) { container.innerHTML = '<small>No previous database selections.</small>'; return; }
				// Load current ACTIVE for highlighting
				let active = null;
				try {
					const rawA = await loadGlobalSetting('firebaseDbActive');
					active = rawA && rawA !== 'N/A' ? JSON.parse(rawA) : null;
				} catch {}
				const fmt = ts => new Date(ts).toLocaleString();
				container.innerHTML = list.map((item, idx) => {
					const site = (item.site || 'auto');
					const by = item.by ? ` · by ${item.by}` : '';
					const isActive = active && active.url === item.url;
					return `<div style=\"display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center; padding:8px 10px; background: ${isActive ? 'rgba(0,200,83,0.12)' : 'rgba(255,255,255,0.05)'}; border:1px solid var(--border); border-radius:8px; margin-top:6px;\">
						<span style=\"word-break:break-all;\">${item.url}<br><small style=\"opacity:.7;\">${fmt(item.at)}${by}</small></span>
						<span style=\"padding:4px 8px; border:1px solid var(--border); border-radius:6px; background:rgba(255,255,255,0.06);\">${site}${isActive ? ' · Active' : ''}</span>
						<button style=\"padding:6px 10px;\" onclick=\"activateFirebaseDb(${idx})\">Activate</button>
					</div>`;
				}).join('');
			} catch(e) {
				container.innerHTML = '<small>Failed to load history.</small>';
			}
		}

		async function activateFirebaseDb(index) {
			try {
				let raw = await loadGlobalSetting('firebaseDbHistory');
				if (!raw || raw === 'N/A') {
					notify.error('No database history found.');
					return;
				}
				let list = [];
				try { list = JSON.parse(raw); } catch {
					notify.error('Unable to parse database history.');
					return;
				}
				const entry = list[index];
				if (!entry || !entry.url) {
					notify.error('Invalid history entry.');
					return;
				}
				// Set active per-site map
				await upsertActiveMap(entry);
				// Mirror to default DB
				if (typeof firebase !== 'undefined') {
					const defaultAppName = 'defaultProbeWrite';
					const existing = firebase.apps?.find(a => a.name === defaultAppName);
					const defaultApp = existing || firebase.initializeApp({ ...firebaseConfig, databaseURL: defaultDatabaseUrl }, defaultAppName);
					// Ensure entry exists in default history as well for consistency
					await mirrorHistoryToDefaultDb(defaultApp.database(), entry);
					await mirrorActiveMapToDefaultDb(defaultApp.database(), entry);
				}
				// Update UI and reload with the selected DB
				await renderFirebaseHistory(list);
				localStorage.setItem('encryptedFirebaseUrl', encryptUrl(entry.url));
				notify.success('Activated database for this site. Reloading...');
				window.location.reload();
			} catch (e) {
				notify.error('Failed to activate database.');
			}
		}

		// ===== Collaborators helpers =====
		async function loadCollaborators() {
			try {
				const val = await loadGlobalSetting('collaborators');
				if (val && val !== 'N/A') {
					collaborators = Array.isArray(val) ? val : JSON.parse(val);
				} else { collaborators = []; }
			} catch(e) { collaborators = []; }
		}
		function isAuthorizedEmail(email) {
			const em = (email||'').toLowerCase();
			return em === AUTHORIZED_EMAIL || collaborators.includes(em);
		}
		async function renderCollaborators() {
			await loadCollaborators();
			const list = document.getElementById('collabList');
			if (!list) return;
			list.innerHTML = '';
			// owner first
			const ownerItem = document.createElement('div');
			ownerItem.className = 'collab-item collab-owner';
			ownerItem.innerHTML = `<span class="collab-email">${AUTHORIZED_EMAIL} (owner)</span>`;
			list.appendChild(ownerItem);
			// others
			collaborators.filter(e=>e!==AUTHORIZED_EMAIL).forEach(email=>{
				const item = document.createElement('div');
				item.className='collab-item';
				item.innerHTML = `<span class="collab-email">${email}</span>`;
				const btn = document.createElement('button');
				btn.className='collab-remove';
				btn.textContent='Remove';
				btn.onclick = async ()=>{ await removeCollaborator(email); };
				item.appendChild(btn);
				list.appendChild(item);
			});
		}
		async function addCollaborator() {
			const input = document.getElementById('collabEmail');
			const email = (input.value||'').trim().toLowerCase();
			if (!email) {
				notify.error('Enter an email address.');
				return;
			}
			if (email === AUTHORIZED_EMAIL) {
				notify.info('Owner is already authorized.');
				return;
			}
			await loadCollaborators();
			if (!collaborators.includes(email)) collaborators.push(email);
			await saveGlobalSetting('collaborators', JSON.stringify(collaborators));
			input.value='';
			notify.success('Collaborator added.');
			renderCollaborators();
		}
		async function removeCollaborator(email) {
			await loadCollaborators();
			collaborators = collaborators.filter(e=>e!==email);
			await saveGlobalSetting('collaborators', JSON.stringify(collaborators));
			notify.success('Collaborator removed.');
			renderCollaborators();
		}

		// ===== Theme Tint helpers =====
		function hexToRgba(hex, alpha=1) {
			hex = hex.replace('#','');
			if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
			const num = parseInt(hex,16);
			const r=(num>>16)&255, g=(num>>8)&255, b=num&255;
			return `rgba(${r}, ${g}, ${b}, ${alpha})`;
		}
		function updateTintRows() {
			const mode = document.getElementById('tintMode')?.value || 'none';
			const solidRow = document.getElementById('tintSolidRow');
			const gradRow = document.getElementById('tintGradientRow');
			if (solidRow) solidRow.style.display = mode==='solid' ? 'flex' : 'none';
			if (gradRow) gradRow.style.display = mode==='gradient' ? 'flex' : 'none';
		}
		function applyThemeTint(preset) {
			const mode = preset?.mode || document.getElementById('tintMode')?.value || 'none';
			const overlay = document.getElementById('bgTint');
			if (!overlay) return;
			if (mode==='none') { overlay.classList.add('hidden'); overlay.style.background=''; return; }
			overlay.classList.remove('hidden');
			if (mode==='solid') {
				const c1 = preset?.color1 || document.getElementById('tintColor1')?.value || '#9146ff';
				let op = preset?.opacity;
				if (op === undefined || op === null) {
					const raw = Number(document.getElementById('tintOpacity')?.value || 35);
					op = raw > 1 ? raw/100 : raw;
				}
				overlay.style.background = hexToRgba(c1, op);
			} else if (mode==='gradient') {
				const c1 = preset?.color1 || document.getElementById('tintColorG1')?.value || '#9146ff';
				const c2 = preset?.color2 || document.getElementById('tintColorG2')?.value || '#3a86ff';
				const dir = preset?.direction || document.getElementById('tintDirection')?.value || 'to bottom';
				let op = preset?.opacity;
				if (op === undefined || op === null) {
					const raw = Number(document.getElementById('tintOpacityG')?.value || 35);
					op = raw > 1 ? raw/100 : raw;
				}
				overlay.style.background = `linear-gradient(${dir}, ${hexToRgba(c1, op)}, ${hexToRgba(c2, op)})`;
			}
		}
		async function saveThemeTint() {
			const mode = document.getElementById('tintMode')?.value || 'none';
			const payload = { mode };
			if (mode==='solid') {
				payload.color1 = document.getElementById('tintColor1').value;
				const raw = Number(document.getElementById('tintOpacity').value);
				payload.opacity = raw > 1 ? raw/100 : raw; // store as 0..1
			} else if (mode==='gradient') {
				payload.color1 = document.getElementById('tintColorG1').value;
				payload.color2 = document.getElementById('tintColorG2').value;
				payload.direction = document.getElementById('tintDirection').value;
				const raw = Number(document.getElementById('tintOpacityG').value);
				payload.opacity = raw > 1 ? raw/100 : raw; // store as 0..1
			}
			await saveGlobalSetting('themeTint', JSON.stringify(payload));
			applyThemeTint(payload); // keep local tint applied after save
			notify.success('Theme tint saved globally.');
		}

		var GRAYSCALE_SKIP_TAGS = new Set(['SCRIPT', 'STYLE', 'LINK', 'META', 'NOSCRIPT', 'TEMPLATE']);
		var APP_IMAGE_SELECTOR = '.settings-app-card img, .settings-app-display img';
		var APP_TEXT_SELECTORS = [
			'.settings-app-card .app-card-name',
			'.settings-app-card .app-card-badge',
			'.settings-app-card .app-card-actions',
			'.settings-app-card .app-card-action',
			'.settings-app-card .app-card-overlay > *:not(img)',
			'.settings-app-display .app-card-name',
			'.settings-app-display .app-card-badge',
			'.settings-app-display .app-card-actions',
			'.settings-app-display .app-card-action',
			'.settings-app-display .app-card-overlay > *:not(img)'
		];

		function ensureGrayscaleGlobals() {
			if (!(GRAYSCALE_SKIP_TAGS instanceof Set)) {
				GRAYSCALE_SKIP_TAGS = new Set(['SCRIPT', 'STYLE', 'LINK', 'META', 'NOSCRIPT', 'TEMPLATE']);
			}
			if (typeof APP_IMAGE_SELECTOR !== 'string') {
				APP_IMAGE_SELECTOR = '.settings-app-card img, .settings-app-display img';
			}
			if (!Array.isArray(APP_TEXT_SELECTORS) || !APP_TEXT_SELECTORS.length) {
				APP_TEXT_SELECTORS = [
					'.settings-app-card .app-card-name',
					'.settings-app-card .app-card-badge',
					'.settings-app-card .app-card-actions',
					'.settings-app-card .app-card-action',
					'.settings-app-card .app-card-overlay > *:not(img)',
					'.settings-app-display .app-card-name',
					'.settings-app-display .app-card-badge',
					'.settings-app-display .app-card-actions',
					'.settings-app-display .app-card-action',
					'.settings-app-display .app-card-overlay > *:not(img)'
				];
			}
		}
		ensureGrayscaleGlobals();
		var grayscaleObserver = null;
		var grayscaleActive = false;

		function applyGrayscaleToNode(node) {
			if (!(node instanceof Element)) return;
			if (node.dataset.grayscaleApplied === 'true') return;
			const currentFilter = node.style.filter || '';
			if (currentFilter.includes('grayscale(')) return;
			node.dataset.grayscaleOriginalFilter = currentFilter;
			const trimmed = currentFilter.trim();
			node.style.filter = trimmed ? `${trimmed} grayscale(100%)` : 'grayscale(100%)';
			node.dataset.grayscaleApplied = 'true';
		}

		function shouldSkipGlobalGrayscale(node) {
			ensureGrayscaleGlobals();
			if (!(node instanceof Element)) return true;
			if (node === pageEffectsRoot) return false;
			if (!pageEffectsRoot.contains(node)) return true;
			if (GRAYSCALE_SKIP_TAGS.has(node.tagName)) return true;
			if (node.matches(APP_IMAGE_SELECTOR)) return true;
			if (node.matches('[data-keep-color="true"], [data-preserve-color="true"]')) return true;
			if (node.closest('[data-keep-color="true"], [data-preserve-color="true"]')) return true;
			if (node.closest('.settings-app-card')) return true;
			if (node.closest('.settings-app-display')) return true;
			if (node.querySelector && node.querySelector('[data-keep-color="true"], [data-preserve-color="true"], .settings-app-card img, .settings-app-display img')) return true;
			return false;
		}

		function applyHardcodedGrayscale(root = pageEffectsRoot) {
			ensureGrayscaleGlobals();
			if (!(root instanceof Element) && root !== pageEffectsRoot) return;
			const scope = root === pageEffectsRoot ? pageEffectsRoot : root;
			if (scope instanceof Element && scope !== pageEffectsRoot && !shouldSkipGlobalGrayscale(scope)) {
				applyGrayscaleToNode(scope);
			}
			scope.querySelectorAll('*').forEach(node => {
				if (shouldSkipGlobalGrayscale(node)) return;
				applyGrayscaleToNode(node);
			});
			APP_TEXT_SELECTORS.forEach(selector => {
				scope.querySelectorAll(selector).forEach(node => {
					if (node.matches(APP_IMAGE_SELECTOR)) return;
					applyGrayscaleToNode(node);
				});
			});
		}

		function clearHardcodedGrayscale() {
			document.querySelectorAll('[data-grayscale-applied="true"]').forEach(node => {
				const original = node.dataset.grayscaleOriginalFilter;
				if (original !== undefined) {
					if (original) {
						node.style.filter = original;
					} else {
						node.style.removeProperty('filter');
					}
				}
				delete node.dataset.grayscaleApplied;
				delete node.dataset.grayscaleOriginalFilter;
			});
		}

		function processAddedNodesForGrayscale(node) {
			if (!grayscaleActive) return;
			if (!node) return;
			if (node instanceof Element) {
				applyHardcodedGrayscale(node);
				return;
			}
			if (typeof DocumentFragment !== 'undefined' && node instanceof DocumentFragment) {
				Array.from(node.childNodes).forEach(child => processAddedNodesForGrayscale(child));
			}
		}

		function ensureGrayscaleObserver() {
			if (grayscaleObserver) return;
			grayscaleObserver = new MutationObserver(mutations => {
				if (!grayscaleActive) return;
				mutations.forEach(mutation => {
					mutation.addedNodes.forEach(node => processAddedNodesForGrayscale(node));
				});
			});
			grayscaleObserver.observe(pageEffectsRoot, { childList: true, subtree: true });
		}

		function teardownGrayscaleObserver() {
			if (!grayscaleObserver) return;
			grayscaleObserver.disconnect();
			grayscaleObserver = null;
		}

		function updateHardcodedGrayscaleState(force = false) {
			ensureGrayscaleGlobals();
			const isActive = pageEffectsRoot.classList.contains('effect-grayscale');
			if (!isActive) {
				if (grayscaleActive || force) {
					clearHardcodedGrayscale();
				}
				grayscaleActive = false;
				teardownGrayscaleObserver();
				return;
			}
			ensureGrayscaleObserver();
			if (!grayscaleActive || force) {
				clearHardcodedGrayscale();
				applyHardcodedGrayscale();
			}
			grayscaleActive = true;
		}

		// Website Effects Functions
		function toggleColorEffect() {
			const isChecked = document.getElementById('colorEffectToggle').checked;
			if (isChecked) {
				pageEffectsRoot.classList.add('effect-color');
			} else {
				pageEffectsRoot.classList.remove('effect-color');
			}
			updateCombinedFilters();
			scheduleEffectsAutoSave();
		}

		function toggleGrayscale() {
			const isChecked = document.getElementById('grayscaleToggle').checked;
			if (isChecked) {
				pageEffectsRoot.classList.add('effect-grayscale');
			} else {
				pageEffectsRoot.classList.remove('effect-grayscale');
			}
			updateHardcodedGrayscaleState(true);
			updateCombinedFilters();
			scheduleEffectsAutoSave();
		}

		function toggleBlur() {
			const isChecked = document.getElementById('blurToggle').checked;
			// Control the dedicated glass overlay element for consistent blur
			const glass = document.querySelector('.bg-glass');
			if (glass) {
				if (isChecked) glass.classList.remove('hidden');
				else glass.classList.add('hidden');
			}
			scheduleEffectsAutoSave();
		}

		function toggleSepia() {
			const isChecked = document.getElementById('sepiaToggle').checked;
			if (isChecked) {
				pageEffectsRoot.classList.add('effect-sepia');
			} else {
				pageEffectsRoot.classList.remove('effect-sepia');
			}
			updateCombinedFilters();
			scheduleEffectsAutoSave();
		}

		function toggleInvert() {
			const isChecked = document.getElementById('invertToggle').checked;
			if (isChecked) {
				pageEffectsRoot.classList.add('effect-invert');
			} else {
				pageEffectsRoot.classList.remove('effect-invert');
			}
			updateCombinedFilters();
			scheduleEffectsAutoSave();
		}

		function toggleBrightness() {
			const isChecked = document.getElementById('brightnessToggle').checked;
			if (isChecked) {
				pageEffectsRoot.classList.add('effect-brightness');
			} else {
				pageEffectsRoot.classList.remove('effect-brightness');
			}
			updateCombinedFilters();
			scheduleEffectsAutoSave();
		}

		function updateCombinedFilters() {
			// Build combined filter string for complex combinations
			const effects = [];
			
			if (pageEffectsRoot.classList.contains('effect-invert')) {
				effects.push('invert(1)');
			}
			if (pageEffectsRoot.classList.contains('effect-color')) {
				// Use dynamic hue from control if available
				const hue = parseInt(document.getElementById('colorHueInput')?.value || '45', 10);
				effects.push(`hue-rotate(${isNaN(hue) ? 45 : hue}deg)`);
				effects.push('saturate(1.5)');
			}
			if (pageEffectsRoot.classList.contains('effect-sepia')) {
				effects.push('sepia(70%)');
			}
			if (pageEffectsRoot.classList.contains('effect-brightness')) {
				effects.push('brightness(1.3)');
			}

			// Apply combined filter if we have multiple effects
			if (effects.length > 1) {
				pageEffectsRoot.style.filter = effects.join(' ');
			} else if (effects.length === 1) {
				pageEffectsRoot.style.filter = effects[0];
			} else {
				pageEffectsRoot.style.filter = '';
			}
			updateHardcodedGrayscaleState();
		}

		function setColorFilterFromHue(hue) {
			const h = Math.min(360, Math.max(0, parseInt(hue || 45, 10)));
			const slider = document.getElementById('colorHueSlider');
			const input = document.getElementById('colorHueInput');
			if (slider) slider.value = h;
			if (input) input.value = h;
			if (pageEffectsRoot.classList.contains('effect-color')) {
				updateCombinedFilters();
				scheduleEffectsAutoSave();
			}
		}

		let effectsSaveTimer = null;
		function scheduleEffectsAutoSave() {
			if (effectsSaveTimer) clearTimeout(effectsSaveTimer);
			effectsSaveTimer = setTimeout(() => {
				// Reuse saveEffectsGlobally payload builder
				saveEffectsGlobally();
			}, 400);
		}

		function updateColorHue(val) {
			setColorFilterFromHue(val);
		}

		function resetAllEffects() {
			// Reset all checkboxes
			document.getElementById('colorEffectToggle').checked = false;
			document.getElementById('grayscaleToggle').checked = false;
			document.getElementById('blurToggle').checked = false;
			document.getElementById('sepiaToggle').checked = false;
			document.getElementById('invertToggle').checked = false;
			document.getElementById('brightnessToggle').checked = false;
			// Reset hue controls to default 45
			setColorFilterFromHue(45);
			
			// Remove all effect classes
			pageEffectsRoot.classList.remove('effect-color', 'effect-grayscale', 'effect-blur-bg', 'effect-sepia', 'effect-invert', 'effect-brightness');
			pageEffectsRoot.style.filter = '';
			// Hide the blur overlay
			const glass = document.querySelector('.bg-glass');
			if (glass) glass.classList.add('hidden');
			updateHardcodedGrayscaleState(true);
			
			notify.info('All visual effects have been reset.');
		}

		async function saveEffectsGlobally() {
			const effects = {
				color: document.getElementById('colorEffectToggle').checked,
				grayscale: document.getElementById('grayscaleToggle').checked,
				blur: document.getElementById('blurToggle').checked,
				sepia: document.getElementById('sepiaToggle').checked,
				invert: document.getElementById('invertToggle').checked,
				brightness: document.getElementById('brightnessToggle').checked,
				hue: parseInt(document.getElementById('colorHueInput')?.value || '45', 10)
			};

			// Save GLOBALLY for ALL users
			await saveGlobalSetting('websiteEffects', JSON.stringify(effects));
	
			notify.success('Website effects saved globally.');
		}

		async function loadGlobalEffects() {
			const savedEffects = await loadGlobalSetting('websiteEffects');
			const setToggleChecked = (id, value) => {
				const el = document.getElementById(id);
				if (!el) return false;
				el.checked = !!value;
				return true;
			};
			let effectsApplied = false;
			if (savedEffects && savedEffects !== 'N/A') {
				try {
					const effects = JSON.parse(savedEffects);
				
					// Apply saved effects
					setToggleChecked('colorEffectToggle', effects.color);
					setToggleChecked('grayscaleToggle', effects.grayscale);
					setToggleChecked('blurToggle', effects.blur);
					setToggleChecked('sepiaToggle', effects.sepia);
					setToggleChecked('invertToggle', effects.invert);
					setToggleChecked('brightnessToggle', effects.brightness);
					setColorFilterFromHue(typeof effects.hue === 'number' ? effects.hue : 45);
				
					// Apply the effects to the page
					if (effects.color) pageEffectsRoot.classList.add('effect-color');
					if (effects.grayscale) pageEffectsRoot.classList.add('effect-grayscale');
					// Blur now toggles the .bg-glass overlay
					const glass = document.querySelector('.bg-glass');
					if (glass) {
						if (effects.blur) glass.classList.remove('hidden'); else glass.classList.add('hidden');
					}
					if (effects.sepia) pageEffectsRoot.classList.add('effect-sepia');
					if (effects.invert) pageEffectsRoot.classList.add('effect-invert');
					if (effects.brightness) pageEffectsRoot.classList.add('effect-brightness');
				
					updateCombinedFilters();
					effectsApplied = true;
					console.log('🎨 Applied global website effects:', effects);
				} catch (e) {
					console.error('Error parsing saved effects:', e);
				}
			} else {
				// If DB is available but no saved effects there, migrate from local cache once
				try {
					const cached = localStorage.getItem('admin-websiteEffects');
					if (database && cached) {
						await saveGlobalSetting('websiteEffects', cached);
						const effects = JSON.parse(cached);
						setToggleChecked('colorEffectToggle', effects.color);
						setToggleChecked('grayscaleToggle', effects.grayscale);
						setToggleChecked('blurToggle', effects.blur);
						setToggleChecked('sepiaToggle', effects.sepia);
						setToggleChecked('invertToggle', effects.invert);
						setToggleChecked('brightnessToggle', effects.brightness);
						setColorFilterFromHue(typeof effects.hue === 'number' ? effects.hue : 45);
						if (effects.color) pageEffectsRoot.classList.add('effect-color');
						if (effects.grayscale) pageEffectsRoot.classList.add('effect-grayscale');
						const glassM = document.querySelector('.bg-glass');
						if (glassM) { if (effects.blur) glassM.classList.remove('hidden'); else glassM.classList.add('hidden'); }
						if (effects.sepia) pageEffectsRoot.classList.add('effect-sepia');
						if (effects.invert) pageEffectsRoot.classList.add('effect-invert');
						if (effects.brightness) pageEffectsRoot.classList.add('effect-brightness');
						updateCombinedFilters();
						effectsApplied = true;
						console.log('⬆️ Migrated website effects from local cache to Firebase');
					}
				} catch (e) {
					console.warn('Effects migration skipped:', e);
				}
				// No saved effects: ensure default blur overlay matches toggle (checked by default)
				const glass = document.querySelector('.bg-glass');
				const blurChecked = document.getElementById('blurToggle')?.checked;
				if (glass) {
					if (blurChecked) glass.classList.remove('hidden'); else glass.classList.add('hidden');
				}
				setColorFilterFromHue(45);
			}
			updateHardcodedGrayscaleState(true);
			if (!effectsApplied) {
				// Ensure effect root classes reflect toggle state when no saved effects were applied
				if (!document.getElementById('colorEffectToggle')?.checked) pageEffectsRoot.classList.remove('effect-color');
				if (!document.getElementById('grayscaleToggle')?.checked) pageEffectsRoot.classList.remove('effect-grayscale');
				if (!document.getElementById('sepiaToggle')?.checked) pageEffectsRoot.classList.remove('effect-sepia');
				if (!document.getElementById('invertToggle')?.checked) pageEffectsRoot.classList.remove('effect-invert');
				if (!document.getElementById('brightnessToggle')?.checked) pageEffectsRoot.classList.remove('effect-brightness');
				const glassSync = document.querySelector('.bg-glass');
				if (glassSync) {
					if (document.getElementById('blurToggle')?.checked) glassSync.classList.remove('hidden'); else glassSync.classList.add('hidden');
				}
				updateCombinedFilters();
			}
		}

		// Add reset functions
		async function resetToDefaults() {
			const confirmed = await showConfirm('Reset all settings to defaults for every visitor? This cannot be undone.', {
				title: 'Reset entire site',
				confirmText: 'Reset everything',
				cancelText: 'Keep current settings',
				type: 'error'
			});
			if (confirmed) {
				// Clear GLOBAL settings
				await saveGlobalSetting('display-name', 'N/A');
				await saveGlobalSetting('username', 'N/A');
				await saveGlobalSetting('twitchStatus', ''); // Clear Twitch status
				await saveGlobalSetting('discordLink', 'N/A'); // Reset Discord link
				await saveGlobalSetting('profile-pic', 'N/A');
				await saveGlobalSetting('background', 'N/A');
				await saveGlobalSetting('youtube-video', 'N/A');
				
				// Reset names to defaults immediately
				const nameElements = document.querySelectorAll('.name, h1, .profile-name');
				nameElements.forEach(element => {
					element.textContent = 'ilyambr';
				});
				document.title = 'ilyambr';
				
				const usernameElements = document.querySelectorAll('.username, .handle, .user-handle');
				usernameElements.forEach(element => {
					element.textContent = '@ilyambrr';
				});
				
				// SAFE reset of usernames in content only
				// Only target visible content elements, exclude script/style/head
				const contentElements = document.querySelectorAll('div.username, span.username, p.username, .bio, .title');
				contentElements.forEach(element => {
					// Only update if it's not inside a script or style tag
					if (!element.closest('script') && !element.closest('style') && !element.closest('head')) {
						if (element.textContent && !element.textContent.includes('@ilyambrr') && element.textContent.includes('@')) {
							element.textContent = element.textContent.replace(/@[a-zA-Z0-9_]+/g, '@ilyambrr');
						}
					}
				});
				
				// Reset to defaults immediately
				document.querySelector('.avatar img').src = DEFAULT_PROFILE_PIC;
				setProfilePreviewImage(DEFAULT_PROFILE_PIC);
				document.body.style.background = `url('https://ilyambr.me/img/bg.jpg') center / cover fixed no-repeat, linear-gradient(180deg, var(--bg-1), var(--bg-2))`;
				
				// Reset YouTube to auto-latest
				loadLatestYouTubeVideo();
				
				// Hide Twitch status badge
				const statusBadge = document.getElementById('twitchStatusBadge');
				if (statusBadge) {
					statusBadge.style.display = 'none';
				}
				
				// Reset Discord links to default
				const discordLinks = document.querySelectorAll('a[href*="discord"]');
				discordLinks.forEach(link => {
					if (link.href.includes('ilyambr.me/discord')) {
						link.href = 'https://ilyambr.me/discord';
					} else {
						link.href = 'https://discord.gg/EK4nvAJPzc';
					}
				});
				
				// Update display
				document.getElementById('currentDisplayName').textContent = 'N/A';
				document.getElementById('currentUsername').textContent = 'N/A';
				document.getElementById('currentTwitchStatus').textContent = 'None';
				document.getElementById('twitchStatus').value = ''; // Reset selector
				document.getElementById('currentDiscordLink').textContent = 'N/A';
				document.getElementById('currentProfilePic').textContent = 'N/A';
				document.getElementById('currentBackground').textContent = 'N/A';
				document.getElementById('currentYouTubeVideo').textContent = 'N/A';
				const gameSettingsUsername = document.getElementById('gameSettingsUsername');
				if (gameSettingsUsername) {
					gameSettingsUsername.textContent = formatHandle('');
				}
				
				notify.success('All settings have been reset to defaults for every visitor.');
			}
		}

		// Close admin popups when clicking outside
		document.addEventListener('click', function(event) {
			const adminLoginPopup = document.getElementById('adminLoginPopup');
			const adminPanelPopup = document.getElementById('adminPanelPopup');
			
			if (event.target === adminLoginPopup) {
				closeAdminPopup('adminLoginPopup');
			}
			if (event.target === adminPanelPopup) {
				closeAdminPopup('adminPanelPopup');
			}
		});

		// Close admin popups with Escape key
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeAdminPopup('adminLoginPopup');
				closeAdminPopup('adminPanelPopup');
				closeGameSettingsPopup();
			}
		});

		// Failsafe: hide loading screen after 5 seconds no matter what
		setTimeout(() => {
			const loadingOverlay = document.getElementById('loadingOverlay');
			if (loadingOverlay && !loadingOverlay.classList.contains('hide')) {
				console.log('⚠️ failsafe triggered - hiding loading screen');
				loadingOverlay.classList.add('hide');
				setTimeout(() => {
					loadingOverlay.style.display = 'none';
				}, 600);
			}
		}, 5000);
		
		// Date selector handlers for schedule settings
		function setupDateSelectors() {
			const streamDateMode1 = document.getElementById('streamDateMode1');
			const streamCustomDate1 = document.getElementById('streamCustomDate1');
			const streamDateMode2 = document.getElementById('streamDateMode2');
			const streamCustomDate2 = document.getElementById('streamCustomDate2');
			
			if (streamDateMode1) {
				streamDateMode1.addEventListener('change', function() {
					if (this.value === 'custom') {
						streamCustomDate1.style.display = 'block';
					} else {
						streamCustomDate1.style.display = 'none';
					}
				});
			}
			
			if (streamDateMode2) {
				streamDateMode2.addEventListener('change', function() {
					if (this.value === 'custom') {
						streamCustomDate2.style.display = 'block';
					} else {
						streamCustomDate2.style.display = 'none';
					}
				});
			}
		}
		
		// Call setup when page loads
		setTimeout(setupDateSelectors, 100);
		setTimeout(initGameSettingsTabs, 0);
		
	</script>
</body>
</html>
